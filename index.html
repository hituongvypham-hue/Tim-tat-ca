<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Media Search Hub Pro</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Công cụ tìm kiếm video, hình ảnh, ebook đa nền tảng">
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Media Search">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Block search engines - Private/Unlisted -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="googlebot" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Markdown Parser for Knowledge Base -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            /* macOS Color Palette */
            --mac-bg: #f5f5f7;
            --mac-sidebar-bg: rgba(232, 232, 237, 0.8);
            --mac-card: rgba(255, 255, 255, 0.8);
            --mac-accent: #007aff;
            --mac-accent-hover: #0056b3;
            --mac-red: #ff5f57;
            --mac-yellow: #febc2e;
            --mac-green: #28c840;
            --mac-text: #1d1d1f;
            --mac-text-secondary: #86868b;
            --mac-border: #d1d1d6;
            --mac-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);

            /* Missing variables mapped to Mac theme */
            --google-blue: var(--mac-accent);
            --google-blue-hover: var(--mac-accent-hover);
            --mac-radius: 12px;
            --mac-radius-lg: 16px;

            /* Legacy Variable Mappings (Fix for broken UI) */
            --bg: var(--mac-bg);
            --card: #ffffff;
            /* Use solid white for card to avoid transparency issues without blur */
            --text: var(--mac-text);
            --text-light: var(--mac-text-secondary);
            --border: var(--mac-border);
            --primary: var(--mac-accent);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--mac-text);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* macOS Window Container */
        .mac-window {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            max-height: 900px;
            background: var(--mac-bg);
            border-radius: var(--mac-radius-lg);
            box-shadow: var(--mac-shadow), 0 0 0 1px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* macOS Title Bar */
        .mac-titlebar {
            height: 52px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--mac-border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
            flex-shrink: 0;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
        }

        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .traffic-light:hover {
            opacity: 0.8;
        }

        .traffic-light.close {
            background: var(--mac-red);
        }

        .traffic-light.minimize {
            background: var(--mac-yellow);
        }

        .traffic-light.maximize {
            background: var(--mac-green);
        }

        .mac-title {
            flex: 1;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--mac-text);
        }

        .mac-title-spacer {
            width: 52px;
        }

        /* macOS Main Layout */
        .mac-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* macOS Sidebar */
        .mac-sidebar {
            width: 220px;
            background: var(--mac-sidebar-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--mac-border);
            padding: 12px 8px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--mac-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 6px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            font-weight: 500;
            color: var(--mac-text);
            text-decoration: none;
        }

        .sidebar-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .sidebar-item.active {
            background: var(--mac-accent);
            color: white;
        }

        .sidebar-item .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* macOS Content Area */
        .mac-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--mac-bg);
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Modal Z-index Fix for macOS layout */
        .api-modal-overlay,
        .style-modal,
        .guide-modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 999999 !important;
            display: flex;
            /* Removed !important so JS can hide it */
            align-items: center !important;
            justify-content: center !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }

        .api-modal-overlay .api-modal,
        .style-modal .style-modal-content,
        .guide-modal-overlay .guide-modal {
            position: relative !important;
            z-index: 100000 !important;
            pointer-events: auto !important;
        }

        .api-modal-overlay .modal-btn,
        .api-modal-overlay button,
        .style-modal .close-modal,
        .style-modal button,
        .style-modal .style-tab-btn,
        .style-modal .analyze-btn,
        .guide-modal-overlay button,
        .guide-modal-overlay .modal-close-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 100001 !important;
        }

        /* Dropdown z-index fix */
        .country-dropdown,
        .language-dropdown,
        select,
        .dropdown-menu {
            z-index: 100 !important;
        }

        /* Ensure mac-content doesn't create stacking context issues */
        .mac-content {
            position: relative;
            z-index: 1;
        }


        /* Google Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 1rem;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.375rem;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .app-title span {
            color: var(--google-blue);
            font-weight: 500;
        }

        /* Tab Filters */
        .tab-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tab-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 0.4rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--bg);
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 16px;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .filter-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border);
            color: var(--text);
        }

        .filter-btn.active {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        /* Google-style Tabs (pill buttons) */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: var(--mac-bg);
            border: 1px solid var(--mac-border);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--mac-text);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--bg-secondary);
        }

        .tab.active {
            background: #e8f0fe;
            border-color: #e8f0fe;
            color: var(--mac-accent);
        }

        .tab[draggable="true"] {
            cursor: grab;
        }

        .tab.dragging {
            opacity: 0.5;
            cursor: grabbing;
            background: #e8f0fe;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--mac-card);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-light);
        }

        /* Search */
        .search-wrapper {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            outline: none;
            font-family: inherit;
            color: var(--text);
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--google-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        /* Script Input */
        .script-section {
            background: var(--card);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
        }

        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .script-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
        }

        .script-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .script-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.875rem;
            resize: vertical;
            outline: none;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .script-textarea:focus {
            border-color: var(--google-blue);
            background: var(--card);
        }

        .analyze-btn {
            width: 100%;
            margin-top: 0.875rem;
            padding: 0.75rem 1rem;
            background: var(--mac-accent);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .analyze-btn:hover {
            background: var(--mac-accent-hover);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Suggestions */
        .suggestions {
            background: var(--mac-card);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
            border: 1px solid var(--border-light);
        }

        .suggestions.show {
            display: block;
        }

        .suggestions-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--mac-accent);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .suggestion-group {
            margin-bottom: 0.75rem;
        }

        .suggestion-group:last-child {
            margin-bottom: 0;
        }

        .suggestion-label {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--mac-text-secondary);
            margin-bottom: 0.4rem;
        }

        .suggestion-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .keyword-chip {
            padding: 0.375rem 0.75rem;
            background: var(--mac-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 0.8125rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s;
        }

        .keyword-chip:hover {
            background: #e8f0fe;
            border-color: var(--google-blue);
            color: var(--google-blue);
        }

        .keyword-chip.official {
            border-color: var(--google-blue);
            background: #e8f0fe;
            color: var(--google-blue);
        }

        .keyword-chip.official:hover {
            background: var(--google-blue);
            border-color: var(--google-blue);
        }

        /* Google-Style Country Selector */
        .country-selector {
            display: flex;
            align-items: center;
            gap: 0;
            margin-top: 0.75rem;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .country-tab {
            padding: 0.6rem 0.8rem;
            font-size: 0.75rem;
            color: var(--text-light);
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            position: relative;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .country-tab:hover {
            color: var(--text);
        }

        .country-tab.active {
            color: var(--primary);
            font-weight: 500;
        }

        .country-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            border-radius: 2px 2px 0 0;
        }

        .country-more-btn {
            padding: 0.5rem 0.6rem;
            font-size: 0.7rem;
            color: var(--text-light);
            cursor: pointer;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: auto;
        }

        .country-more-btn:hover {
            color: var(--text);
        }

        .country-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            display: none;
            max-height: 350px;
            overflow: hidden;
        }

        .country-dropdown.show {
            display: block;
        }

        .country-search {
            width: 100%;
            padding: 0.7rem 1rem;
            padding-left: 2.2rem;
            border: none;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            font-family: inherit;
            outline: none;
            background: var(--bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 0.75rem center;
        }

        .country-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            max-height: 280px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .country-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: var(--text);
            cursor: pointer;
            transition: background 0.1s;
        }

        .country-item:hover {
            background: var(--bg-secondary);
        }

        .country-item.selected {
            background: #e8f0fe;
            color: var(--google-blue);
        }

        .country-item .flag {
            font-size: 1.1rem;
        }



        /* Section */
        .section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Platforms */
        .platforms {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .platform {
            position: relative;
            cursor: pointer;
        }

        .platform input {
            position: absolute;
            opacity: 0;
        }

        .platform-label {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8125rem;
            color: var(--text);
            transition: all 0.15s;
        }

        .platform:hover .platform-label {
            background: var(--bg-secondary);
        }

        .platform input:checked+.platform-label {
            background: #e8f0fe;
            border-color: var(--google-blue);
            color: var(--google-blue);
        }

        .platform-icon {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            object-fit: contain;
        }

        /* Section Description */
        .section-desc {
            color: #5f6368;
            font-size: 12px;
            line-height: 1.5;
            margin: -8px 0 12px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #1a73e8;
        }

        .section-desc strong {
            color: #202124;
        }

        /* Create Tab Styles */
        .create-prompt-box textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.2s;
        }

        .create-prompt-box textarea:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .ai-model-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ai-model-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-model-option:hover {
            border-color: #1a73e8;
            background: #f8f9fa;
        }

        .ai-model-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
            accent-color: #1a73e8;
        }

        .ai-model-option input[type="radio"]:checked+.ai-model-info {
            color: #1a73e8;
        }

        .ai-model-info {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .ai-model-icon {
            font-size: 20px;
        }

        .ai-model-name {
            font-weight: 500;
            font-size: 14px;
        }

        .ai-model-desc {
            font-size: 12px;
            color: #5f6368;
            width: 100%;
        }

        /* Compact AI Icon Grid */
        .ai-icon-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .ai-icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            position: relative;
        }

        .ai-icon-btn:hover {
            border-color: #1a73e8;
            transform: scale(1.1);
        }

        .ai-icon-btn.selected {
            border-color: #1a73e8;
            background: #e8f0fe;
            box-shadow: 0 0 12px rgba(26, 115, 232, 0.4);
        }

        .ai-icon-btn img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .ai-icon-btn[title]::after {
            content: attr(title);
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            white-space: nowrap;
            color: #5f6368;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .ai-icon-btn:hover[title]::after {
            opacity: 1;
        }

        .ai-section-label {
            font-size: 11px;
            color: #9aa0a6;
            margin-bottom: 6px;
            display: block;
        }

        /* Prompt Builder Styles */
        .prompt-builder {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pb-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pb-label {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .pb-input,
        .pb-select,
        .pb-textarea {
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        /* Negative Prompt Grid */
        .negative-prompt-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .neg-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: #fef7f7;
            border: 1px solid #fce8e8;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .neg-checkbox:hover {
            background: #fce8e8;
            border-color: #ea4335;
        }

        .neg-checkbox input[type="checkbox"] {
            accent-color: #ea4335;
        }

        .neg-checkbox input[type="checkbox"]:checked+span,
        .neg-checkbox:has(input:checked) {
            color: #c5221f;
            font-weight: 500;
        }

        /* Formula Cards Section */
        .formula-section .toggle-hint {
            font-size: 11px;
            color: #9aa0a6;
            font-weight: 400;
        }

        .formula-cards {
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f5 50%, #f5fff5 100%);
            border-radius: 12px;
            border: 1px solid #e8eaed;
        }

        /* Sub-tabs Navigation (inside Create tab) */
        .sub-tabs-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e8eaed;
        }

        .sub-tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #5f6368;
        }

        .sub-tab-btn:hover {
            background: #e8eaed;
        }

        .sub-tab-btn.active {
            background: white;
            color: #1a73e8;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Always visible section (Final Prompt + Generate) */
        .always-visible {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px dashed #e8eaed;
        }

        .recipe-category {
            margin-bottom: 16px;
        }

        .recipe-category:last-of-type {
            margin-bottom: 8px;
        }

        .recipe-category-title {
            font-size: 13px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px dashed #dadce0;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }

        .recipe-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recipe-card:hover {
            border-color: #1a73e8;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
            transform: translateY(-2px);
        }

        .recipe-card:active {
            transform: translateY(0);
        }

        .recipe-name {
            font-size: 12px;
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 6px;
        }

        .recipe-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .recipe-tag {
            font-size: 9px;
            padding: 2px 6px;
            background: #f1f3f4;
            border-radius: 10px;
            color: #5f6368;
            white-space: nowrap;
        }

        .recipe-tag:nth-child(1) {
            background: #e8f0fe;
            color: #1967d2;
        }

        /* Style */
        .recipe-tag:nth-child(2) {
            background: #fef7e0;
            color: #b06000;
        }

        /* Lighting */
        .recipe-tag:nth-child(3) {
            background: #e6f4ea;
            color: #137333;
        }

        /* Camera */
        .recipe-tag:nth-child(4) {
            background: #fce8e6;
            color: #c5221f;
        }

        /* Mood */
        .recipe-tag:nth-child(5) {
            background: #f3e8fd;
            color: #7627bb;
        }

        /* Color */

        .formula-legend {
            margin-top: 12px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-size: 11px;
            color: #5f6368;
            text-align: center;
        }

        .formula-legend .legend-item {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin: 0 2px;
        }

        .formula-legend .legend-item:nth-of-type(1) {
            background: #e8f0fe;
            color: #1967d2;
        }

        .formula-legend .legend-item:nth-of-type(2) {
            background: #fef7e0;
            color: #b06000;
        }

        .formula-legend .legend-item:nth-of-type(3) {
            background: #e6f4ea;
            color: #137333;
        }

        .formula-legend .legend-item:nth-of-type(4) {
            background: #fce8e6;
        }

        .copy-style-btn {
            padding: 0 16px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(245, 124, 0, 0.2);
        }

        .copy-style-btn:hover {
            opacity: 0.9;
            box-shadow: 0 4px 8px rgba(245, 124, 0, 0.3);
            transform: translateY(-1px);
        }

        /* Style Transfer Modal */
        .style-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .style-modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .style-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f1f3f4;
            padding-bottom: 0;
        }

        .style-tab-btn {
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-size: 14px;
        }

        .style-tab-btn.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
        }

        .upload-area {
            border: 2px dashed #dadce0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #1a73e8;
            background: #f1f8ff;
        }

        .analyze-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 20px;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .analyze-btn:hover {
            opacity: 0.9;
        }

        /* Processing Overlay */
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            z-index: 10;
        }

        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .processing-text {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            max-width: 80%;
            text-align: center;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        color: #c5221f;
        }

        .formula-legend .legend-item:nth-of-type(5) {
            background: #f3e8fd;
            color: #7627bb;
        }


        .pb-input-group {
            display: flex;
            gap: 8px;
        }

        .pb-input-group .pb-input {
            flex: 1;
        }

        .ai-assist-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .ai-assist-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .ai-assist-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        .toggle-key-btn {
            padding: 10px 12px;
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .toggle-key-btn:hover {
            background: #e8eaed;
        }

        /* API Status Badge */
        .api-status-section {
            padding: 0 !important;
        }

        .api-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .api-status-badge.connected {
            background: #e6f4ea;
            color: #1e8e3e;
            border: 1px solid #34a853;
        }

        .api-status-badge.disconnected {
            background: #fce8e6;
            color: #c5221f;
            border: 1px solid #ea4335;
        }

        .api-status-badge:hover {
            transform: scale(1.05);
        }

        /* API Modal */
        .api-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .api-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlide 0.2s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .api-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .api-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #5f6368;
        }

        .api-modal-body {
            padding: 20px;
        }

        .api-modal-body p {
            margin: 0 0 12px;
            color: #5f6368;
        }

        .api-modal-body ol {
            margin: 0 0 16px;
            padding-left: 20px;
            color: #5f6368;
        }

        .api-modal-body a {
            color: #1a73e8;
        }

        .api-modal-input-group {
            display: flex;
            gap: 8px;
        }

        .api-modal-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: #f1f3f4;
            color: #5f6368;
        }

        .modal-btn.danger {
            background: #fce8e6;
            color: #c5221f;
        }

        .modal-btn.primary {
            background: #1a73e8;
            color: white;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        .pb-input:focus,
        .pb-select:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .final-prompt-box {
            position: relative;
        }

        .final-prompt {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            padding-right: 70px;
            border: 2px solid #1a73e8;
            border-radius: 8px;
            font-size: 13px;
            background: #e8f0fe;
            resize: vertical;
        }

        .copy-prompt-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            padding: 6px 12px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-prompt-btn:hover {
            background: #1557b0;
        }

        .ai-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .ai-checkbox {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-checkbox:hover {
            border-color: #1a73e8;
            background: #f8f9fa;
        }

        .ai-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

        .ai-checkbox input[type="checkbox"]:checked+span {
            color: #1a73e8;
            font-weight: 600;
        }

        .ai-checkbox input[type="checkbox"]:checked~small {
            color: #1a73e8;
        }

        .ai-checkbox:has(input:checked) {
            border-color: #1a73e8;
            background: #e8f0fe;
        }

        .ai-checkbox span {
            font-size: 13px;
        }

        .ai-checkbox small {
            font-size: 11px;
            color: #5f6368;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn-search {
            flex: 1;
            padding: 0.75rem 1.5rem;
            background: var(--google-blue);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-search:hover {
            background: var(--google-blue-hover);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .btn-select {
            padding: 0.75rem 1.25rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--google-blue);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .btn-select:hover {
            background: #e8f0fe;
            border-color: #e8f0fe;
        }

        /* History */
        .history {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .history-item {
            padding: 0.375rem 0.75rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .history-item:hover {
            border-color: var(--primary);
            color: var(--text);
        }

        .empty {
            color: var(--text-light);
            font-size: 0.7rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: #fff;
            padding: 0.7rem 1.2rem;
            border-radius: 12px;
            font-size: 0.75rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .count {
            display: inline-block;
            min-width: 1.2rem;
            padding: 0.15rem 0.3rem;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            font-size: 0.6rem;
            text-align: center;
            margin-left: 0.3rem;
        }

        .badge {
            font-size: 0.5rem;
            padding: 0.15rem 0.35rem;
            background: var(--primary);
            color: #fff;
            border-radius: 10px;
            margin-left: 0.25rem;
            text-transform: uppercase;
        }

        .badge.hot {
            background: var(--danger);
        }

        .badge.ai {
            background: #8b5cf6;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(45, 158, 132, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Settings Bar */
        .settings-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .app-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .settings-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--card);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .setting-item {
            margin-bottom: 0.75rem;
        }

        .setting-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--text);
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .api-key-input {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.75rem;
            font-family: monospace;
            background: var(--bg);
            color: var(--text);
            outline: none;
        }

        .api-key-input:focus {
            border-color: var(--primary);
        }

        .api-link {
            display: inline-block;
            font-size: 0.65rem;
            color: var(--primary);
            margin-top: 0.3rem;
            text-decoration: none;
        }

        .api-link:hover {
            text-decoration: underline;
        }

        .save-settings-btn {
            width: 100%;
            padding: 0.7rem;
            background: var(--primary);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .save-settings-btn:hover {
            background: var(--primary-dark);
        }

        /* AI Suggestions */
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            font-size: 0.75rem;
            color: #8b5cf6;
            margin-top: 0.75rem;
        }

        .ai-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
        }

        .ai-section-title {
            font-size: 0.65rem;
            color: #8b5cf6;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .keyword-chip.ai {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .keyword-chip.ai:hover {
            background: #8b5cf6;
            color: #fff;
        }

        /* Upload Section CSS */
        .upload-section {
            margin-bottom: 1rem;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(45, 158, 132, 0.05);
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            font-size: 0.8rem;
            color: var(--text);
        }

        .upload-text span {
            display: block;
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .upload-formats {
            font-size: 0.6rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .upload-or {
            text-align: center;
            color: var(--text-light);
            font-size: 0.7rem;
            margin: 0.75rem 0;
        }

        .paste-area {
            display: flex;
            gap: 0.5rem;
        }

        .url-input {
            flex: 1;
            padding: 0.7rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.75rem;
            font-family: inherit;
            outline: none;
            background: var(--card);
            color: var(--text);
        }

        .url-input:focus {
            border-color: var(--primary);
        }

        .upload-preview {
            margin-top: 1rem;
            position: relative;
            display: inline-block;
        }

        .upload-preview img {
            max-width: 150px;
            max-height: 120px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .remove-preview {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .upload-status {
            margin-top: 0.75rem;
            font-size: 0.7rem;
            color: var(--text-light);
        }

        .upload-status.error {
            color: var(--danger);
        }

        .upload-status.success {
            color: var(--success);
        }

        .url-result {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            align-items: center;
        }

        .result-url-input {
            flex: 1;
            padding: 0.6rem 0.8rem;
            border: 2px solid var(--success);
            border-radius: 10px;
            font-size: 0.7rem;
            font-family: monospace;
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            outline: none;
        }

        .copy-url-btn {
            padding: 0.6rem 1rem;
            background: var(--success);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .copy-url-btn:hover {
            background: #219a52;
        }

        .copy-url-btn.copied {
            background: var(--google-blue-hover);
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                padding: 0.75rem;
                max-width: 100%;
            }

            .app-header {
                padding: 0.75rem 0;
            }

            .app-title {
                font-size: 1.125rem;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 0.25rem;
                padding-bottom: 0.25rem;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .search-input {
                font-size: 16px;
                /* Prevents zoom on iOS */
                padding: 0.75rem;
            }

            .script-section {
                padding: 1rem;
            }

            .script-textarea {
                font-size: 16px;
                min-height: 80px;
            }

            .country-selector {
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .country-tab {
                padding: 0.5rem 0.6rem;
                font-size: 0.75rem;
            }

            .country-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 16px 16px 0 0;
                max-height: 60vh;
            }

            .country-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .section-title {
                font-size: 0.8125rem;
            }

            .platforms {
                gap: 0.4rem;
            }

            .platform-label {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
            }

            .actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .btn-search,
            .btn-select {
                width: 100%;
                padding: 0.875rem;
            }

            .history {
                gap: 0.4rem;
            }

            .history-item {
                font-size: 0.8125rem;
            }

            .suggestions {
                padding: 0.875rem;
            }

            .keyword-chip {
                padding: 0.4rem 0.75rem;
                font-size: 0.8125rem;
            }

            /* Upload section mobile */
            .upload-area {
                padding: 1.5rem 1rem;
            }

            .upload-preview {
                max-height: 200px;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                gap: 0.125rem;
            }

            .tab {
                padding: 0.4rem 0.5rem;
                font-size: 0.75rem;
            }

            .country-grid {
                grid-template-columns: 1fr;
            }

            .platform-label {
                padding: 0.4rem 0.5rem;
                font-size: 0.75rem;
            }

            .platform-icon {
                font-size: 0.875rem;
            }
        }

        /* PWA / Fullscreen support */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Touch improvements */
        @media (hover: none) {

            .platform-label,
            .keyword-chip,
            .country-tab,
            .btn-search,
            .btn-select {
                -webkit-tap-highlight-color: transparent;
            }

            .platform:active .platform-label {
                transform: scale(0.98);
            }
        }

        /* ========== NEW UX FEATURES ========== */

        /* Scroll to Top FAB */
        .scroll-top-btn {
            position: fixed;
            bottom: 2rem;
            right: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--google-blue);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 90;
        }

        .scroll-top-btn.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-top-btn:hover {
            background: var(--google-blue-hover);
            transform: translateY(-2px);
        }

        /* Tab Scroll Indicator */
        .tabs-wrapper {
            position: relative;
        }

        .tabs-wrapper::after {
            content: '→';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to left, var(--bg) 60%, transparent);
            padding-left: 2rem;
            padding-right: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tabs-wrapper.show-indicator::after {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .tabs-wrapper::after {
                opacity: 1;
            }

            .tabs-wrapper.scrolled-end::after {
                opacity: 0;
            }
        }

        /* Language Toggle */
        .lang-toggle {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-left: 0.5rem;
        }

        .lang-toggle-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .lang-toggle-btn.active {
            background: var(--google-blue);
            color: white;
        }

        /* Clear All Button */
        .btn-clear {
            padding: 0.6rem 1rem;
            background: transparent;
            border: 1px solid var(--google-red);
            border-radius: 4px;
            color: var(--google-red);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: var(--google-red);
            color: white;
        }

        /* Favorite Star */
        .fav-star {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
            color: var(--text-secondary);
        }

        .platform:hover .fav-star {
            opacity: 1;
        }

        .fav-star.active {
            opacity: 1;
            color: var(--google-yellow);
        }

        /* Export/Import buttons */
        .export-import-btns {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-export,
        .btn-import {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export:hover,
        .btn-import:hover {
            border-color: var(--google-blue);
            color: var(--google-blue);
        }

        /* Batch Warning Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-box {
            background: var(--card);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 320px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.show .modal-box {
            transform: scale(1);
        }

        .modal-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .modal-btns {
            display: flex;
            gap: 0.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .modal-btn.confirm {
            background: var(--google-blue);
            color: white;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        /* Header flex adjustments */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ========== DRAG-DROP PLATFORMS ========== */
        .platform[draggable="true"] {
            cursor: grab;
        }

        .platform.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }

        .platform.drag-over .platform-label {
            border-color: var(--google-blue);
            border-style: dashed;
            background: #e8f0fe;
        }

        .drag-handle {
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 0.25rem;
        }

        .platform:hover .drag-handle {
            opacity: 0.6;
        }

        /* ========== ADD CUSTOM SITE ========== */
        .add-custom-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 8px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-custom-btn:hover {
            border-color: var(--google-blue);
            color: var(--google-blue);
            background: #e8f0fe;
        }

        .custom-site-badge {
            background: var(--google-green);
            color: white;
            font-size: 0.5rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            margin-left: 0.25rem;
        }

        .platform.custom .platform-label {
            border-style: dashed;
        }

        .delete-custom {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--google-red);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.65rem;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .platform.custom:hover .delete-custom {
            opacity: 1;
        }

        /* Custom Site Modal */
        .add-site-modal .modal-box {
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .form-group input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            border-color: var(--google-blue);
        }

        .form-group .hint {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .icon-picker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .icon-option {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .icon-option:hover,
        .icon-option.selected {
            border-color: var(--google-blue);
            background: #e8f0fe;
        }

        /* Platform Context Menu */
        .platform-context-menu {
            position: fixed;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 180px;
            padding: 0.5rem 0;
            display: none;
        }

        .platform-context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.15s;
        }

        .context-menu-item:hover {
            background: #f0f0f0;
        }

        body.dark .context-menu-item:hover {
            background: #333;
        }

        /* ========== CLOUD SYNC ========== */
        .sync-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .sync-title {
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .sync-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .sync-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: monospace;
        }

        .sync-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .sync-btn:hover {
            border-color: var(--google-blue);
            color: var(--google-blue);
        }

        .sync-btn.primary {
            background: var(--google-blue);
            color: white;
            border-color: var(--google-blue);
        }

        .sync-status {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .sync-status.success {
            color: var(--google-green);
        }

        .sync-status.error {
            color: var(--google-red);
        }

        /* Wiki Preview Styles */
        .btn-preview {
            padding: 0.5rem 1rem;
            border: 2px solid #34a853;
            background: linear-gradient(135deg, #34a853 0%, #2d9649 100%);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
        }

        .wiki-preview-container {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .wiki-preview-loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            color: var(--text-light);
        }

        .wiki-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .wiki-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            border-color: #404040;
        }

        .wiki-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .wiki-thumbnail {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            background: #e0e0e0;
        }

        .wiki-content {
            flex: 1;
            min-width: 0;
        }

        .wiki-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a73e8;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wiki-title a {
            color: inherit;
            text-decoration: none;
        }

        .wiki-title a:hover {
            text-decoration: underline;
        }

        .wiki-lang-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: #e8f0fe;
            color: #1a73e8;
            border-radius: 4px;
            font-weight: 500;
        }

        [data-theme="dark"] .wiki-lang-badge {
            background: #1e3a5f;
        }

        .wiki-extract {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text);
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .wiki-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .wiki-btn {
            padding: 0.35rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wiki-btn:hover {
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .wiki-btn.primary {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .wiki-btn.primary:hover {
            background: #1557b0;
        }

        .wiki-no-results {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .wiki-multi-results {
            display: grid;
            gap: 0.75rem;
        }

        @media (max-width: 600px) {
            .wiki-card {
                flex-direction: column;
            }

            .wiki-thumbnail {
                width: 100%;
                height: 150px;
            }
        }

        /* Wiki Article Full Display */
        .wiki-article {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }

        .wiki-article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
        }

        .wiki-article-title {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .wiki-open-link {
            color: white;
            text-decoration: none;
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .wiki-open-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .wiki-article-body {
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .wiki-article-body img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 0.5rem 0;
        }

        .wiki-article-body a {
            color: #1a73e8;
        }

        .wiki-article-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        .wiki-article-body table,
        .wiki-article-body th,
        .wiki-article-body td {
            border: 1px solid var(--border);
        }

        .wiki-article-body th,
        .wiki-article-body td {
            padding: 0.5rem;
            text-align: left;
        }

        .wiki-article-body .infobox {
            float: right;
            width: 280px;
            margin: 0 0 1rem 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
        }

        [data-theme="dark"] .wiki-article-body .infobox {
            background: #2d2d2d;
        }

        .wiki-article-footer {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        /* Wiki Language Selector */
        .wiki-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wiki-lang-selector {
            position: relative;
        }

        .wiki-lang-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wiki-lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .wiki-lang-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            max-height: 350px;
            overflow: hidden;
            z-index: 1000;
        }

        .wiki-lang-dropdown.show {
            display: block;
        }

        .wiki-lang-search {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .wiki-lang-search input {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .wiki-lang-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .wiki-lang-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text);
            transition: background 0.2s;
        }

        .wiki-lang-item:hover {
            background: var(--hover);
        }

        .wiki-lang-item.active {
            background: #e8f0fe;
            color: #1a73e8;
            font-weight: 600;
        }

        [data-theme="dark"] .wiki-lang-item.active {
            background: #1e3a5f;
        }

        /* My Tool Tab Styles */
        .mytool-add-form {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .mytool-input {
            flex: 1;
            min-width: 150px;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            background: var(--bg);
        }

        .mytool-icon-input {
            flex: 0 0 60px;
            min-width: 60px;
            text-align: center;
            font-size: 1.2rem;
        }

        .mytool-form-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-add-tool {
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-tool:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .btn-cancel-tool {
            padding: 0.6rem 1rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .mytool-search {
            margin-bottom: 1rem;
        }

        .mytool-search-input {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--card);
        }

        .mytool-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .mytool-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .mytool-item:hover {
            border-color: #1a73e8;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .mytool-icon {
            font-size: 1.5rem;
            width: 32px;
            text-align: center;
        }

        .mytool-name {
            flex: 1;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mytool-actions {
            display: none;
            position: absolute;
            top: 50%;
            right: 0.5rem;
            transform: translateY(-50%);
            gap: 0.25rem;
        }

        .mytool-item:hover .mytool-actions {
            display: flex;
        }

        .mytool-action-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.05);
        }

        .mytool-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .mytool-action-btn.delete:hover {
            background: #ffebee;
            color: #c62828;
        }

        .mytool-empty {
            grid-column: 1/-1;
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Prompt Manager Styles */
        .prompt-add-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.25rem;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .prompt-input,
        .prompt-textarea,
        .prompt-select {
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--bg);
            width: 100%;
            box-sizing: border-box;
        }

        .prompt-textarea {
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.5;
        }

        .prompt-note {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .prompt-form-row {
            display: flex;
            gap: 0.75rem;
        }

        .prompt-form-row>* {
            flex: 1;
        }

        .prompt-select {
            cursor: pointer;
        }

        .prompt-form-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-add-prompt {
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-prompt:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-cancel-prompt {
            padding: 0.7rem 1rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .prompt-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .prompt-search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--card);
        }

        .prompt-filter-select {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            cursor: pointer;
        }

        .prompt-count {
            font-size: 0.8rem;
            color: var(--text-light);
            padding: 0.4rem 0.8rem;
            background: var(--hover);
            border-radius: 20px;
        }

        .prompt-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .prompt-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .prompt-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .prompt-item-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .prompt-drag-handle {
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: grab;
            padding: 0.25rem;
            user-select: none;
        }

        .prompt-drag-handle:hover {
            color: var(--primary);
        }

        .prompt-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary);
        }

        .prompt-item:not(.dragging):hover {
            cursor: grab;
        }

        .prompt-item-category {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
        }

        .prompt-item-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            background: var(--bg);
            padding: 0.75rem;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
        }

        .prompt-item-content .variable {
            background: #fff3cd;
            color: #856404;
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-weight: 600;
        }

        [data-theme="dark"] .prompt-item-content .variable {
            background: #3d3d00;
            color: #ffc107;
        }

        .prompt-item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .prompt-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: var(--hover);
            border-radius: 10px;
            color: var(--text-light);
        }

        .prompt-item-note {
            font-size: 0.8rem;
            color: var(--text-light);
            padding: 0.5rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .prompt-item-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .prompt-action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            background: var(--hover);
            transition: all 0.2s;
        }

        .prompt-action-btn:hover {
            background: var(--border);
        }

        .prompt-action-btn.copy {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .prompt-action-btn.copy:hover {
            background: #c8e6c9;
        }

        .prompt-action-btn.delete:hover {
            background: #ffebee;
            color: #c62828;
        }

        .prompt-action-btn.move {
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.3rem 0.5rem;
        }

        .prompt-action-btn.move:hover {
            background: #bbdefb;
        }

        .prompt-empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Workflow and Step Styles */
        .prompt-item-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-light);
            flex-wrap: wrap;
        }

        .prompt-timestamp {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .prompt-workflow-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.6rem;
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border: 1px solid #667eea40;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #667eea;
            font-weight: 500;
        }

        .prompt-step {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .btn-copy-workflow {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-copy-workflow:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Knowledge Base Styles */
        .knowledge-add-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.25rem;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .knowledge-upload-section {
            margin-bottom: 0.5rem;
        }

        .knowledge-upload-area {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            border: 2px dashed #10b981;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.08));
            cursor: pointer;
            transition: all 0.2s;
        }

        .knowledge-upload-area:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.15));
            border-color: #059669;
        }

        .knowledge-upload-area.dragover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.25));
            border-color: #047857;
            transform: scale(1.02);
        }

        .knowledge-upload-area .upload-icon {
            font-size: 2rem;
        }

        .knowledge-upload-area .upload-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .knowledge-upload-area .upload-text strong {
            color: #059669;
            font-size: 1rem;
        }

        .knowledge-upload-area .upload-text span {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .knowledge-upload-section .upload-or {
            text-align: center;
            color: var(--text-light);
            font-size: 0.8rem;
            margin-top: 0.75rem;
            position: relative;
        }

        .knowledge-upload-section .upload-or::before,
        .knowledge-upload-section .upload-or::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: var(--border);
        }

        .knowledge-upload-section .upload-or::before {
            left: 10%;
        }

        .knowledge-upload-section .upload-or::after {
            right: 10%;
        }

        .knowledge-input,
        .knowledge-textarea,
        .knowledge-select {
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--bg);
            width: 100%;
            box-sizing: border-box;
        }

        .knowledge-textarea {
            min-height: 120px;
            font-family: inherit;
            resize: vertical;
        }

        .knowledge-form-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-add-knowledge {
            padding: 0.7rem 1.2rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-knowledge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-cancel-knowledge {
            padding: 0.7rem 1.2rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .knowledge-search-bar {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1rem;
        }

        .knowledge-search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--card);
        }

        .knowledge-filter-select {
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--card);
        }

        .knowledge-count {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .knowledge-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .knowledge-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .knowledge-item-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.08));
        }

        .knowledge-item-header:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.12));
        }

        .knowledge-item-expand {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            transition: transform 0.2s;
        }

        .knowledge-item.expanded .knowledge-item-expand {
            transform: rotate(90deg);
        }

        .knowledge-item-info {
            flex: 1;
        }

        .knowledge-item-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .knowledge-item-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .knowledge-item-category {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 10px;
        }

        .knowledge-item-tag {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            background: var(--bg);
            color: var(--text-light);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .knowledge-item-actions {
            display: flex;
            gap: 0.4rem;
        }

        .knowledge-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            background: transparent;
            transition: all 0.2s;
        }

        .knowledge-action-btn.copy {
            background: #dcfce7;
            color: #16a34a;
        }

        .knowledge-action-btn.copy:hover {
            background: #bbf7d0;
        }

        .knowledge-action-btn.edit {
            background: #dbeafe;
            color: #2563eb;
        }

        .knowledge-action-btn.edit:hover {
            background: #bfdbfe;
        }

        .knowledge-action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .knowledge-action-btn.delete:hover {
            background: #fecaca;
        }

        .knowledge-item-body {
            display: none;
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid var(--border);
        }

        .knowledge-item.expanded .knowledge-item-body {
            display: block;
        }

        .knowledge-item-content {
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg);
            padding: 1.25rem;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 0.75rem;
            line-height: 1.6;
        }

        /* Markdown Content Styling */
        .knowledge-item-content.markdown-body h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 0.75rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: #10b981;
        }

        .knowledge-item-content.markdown-body h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: #059669;
        }

        .knowledge-item-content.markdown-body h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.75rem 0 0.5rem 0;
            color: #047857;
        }

        .knowledge-item-content.markdown-body p {
            margin: 0.5rem 0;
        }

        .knowledge-item-content.markdown-body ul,
        .knowledge-item-content.markdown-body ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .knowledge-item-content.markdown-body li {
            margin: 0.25rem 0;
        }

        .knowledge-item-content.markdown-body code {
            background: #f0fdf4;
            color: #166534;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
        }

        .knowledge-item-content.markdown-body pre {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .knowledge-item-content.markdown-body pre code {
            background: none;
            padding: 0;
        }

        .knowledge-item-content.markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.85rem;
        }

        .knowledge-item-content.markdown-body th,
        .knowledge-item-content.markdown-body td {
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .knowledge-item-content.markdown-body th {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 600;
        }

        .knowledge-item-content.markdown-body tr:nth-child(even) {
            background: rgba(16, 185, 129, 0.05);
        }

        .knowledge-item-content.markdown-body blockquote {
            border-left: 4px solid #10b981;
            margin: 0.75rem 0;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.05);
            color: var(--text-secondary);
        }

        .knowledge-item-content.markdown-body strong {
            color: #059669;
            font-weight: 600;
        }

        .knowledge-item-content.markdown-body hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 1rem 0;
        }

        [data-theme="dark"] .knowledge-item-content.markdown-body code {
            background: #064e3b;
            color: #6ee7b7;
        }

        [data-theme="dark"] .knowledge-item-content.markdown-body pre {
            background: #1e293b;
        }

        .knowledge-item-copy-full {
            margin-top: 0.75rem;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
        }

        .knowledge-item-copy-full:hover {
            opacity: 0.9;
        }

        .knowledge-empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Knowledge Base Cards */
        .kb-filter-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.25rem;
        }

        .kb-filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kb-filter-btn:hover {
            background: var(--card);
        }

        .kb-filter-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: transparent;
        }

        .kb-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .kb-card {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.25rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kb-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: #10b981;
        }

        .kb-card.hidden {
            display: none;
        }

        .kb-card-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .kb-card-content {
            flex: 1;
            min-width: 0;
        }

        .kb-card-content h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            color: var(--text);
        }

        .kb-card-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0 0 0.75rem 0;
            line-height: 1.4;
        }

        .kb-card-tags {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .kb-card-tags span {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-radius: 4px;
        }

        .kb-card-actions {
            flex-shrink: 0;
        }

        .kb-copy-btn {
            padding: 0.6rem;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .kb-copy-btn:hover {
            transform: scale(1.1);
        }

        /* Guide Modal */
        .guide-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            padding: 2rem;
            overflow-y: auto;
        }

        .guide-modal-overlay.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .guide-modal {
            background: var(--card);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        }

        .guide-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .guide-modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .guide-modal-actions {
            display: flex;
            gap: 0.75rem;
        }

        .guide-copy-all-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .guide-copy-all-btn:hover {
            opacity: 0.9;
        }

        .guide-close-btn {
            padding: 0.5rem 0.75rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .guide-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
            line-height: 1.7;
        }

        .guide-modal-body h1 {
            font-size: 1.5rem;
            color: #10b981;
            margin: 0 0 1rem 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .guide-modal-body h2 {
            font-size: 1.2rem;
            color: #059669;
            margin: 1.5rem 0 0.75rem 0;
        }

        .guide-modal-body h3 {
            font-size: 1.05rem;
            color: #047857;
            margin: 1rem 0 0.5rem 0;
        }

        .guide-modal-body ul,
        .guide-modal-body ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .guide-modal-body li {
            margin: 0.25rem 0;
        }

        .guide-modal-body code {
            background: #f0fdf4;
            color: #166534;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        .guide-modal-body pre {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .guide-modal-body pre code {
            background: none;
            padding: 0;
        }

        .guide-modal-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.9rem;
        }

        .guide-modal-body th,
        .guide-modal-body td {
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .guide-modal-body th {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .guide-modal-body blockquote {
            border-left: 4px solid #10b981;
            margin: 0.75rem 0;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.05);
        }

        .guide-modal-body strong {
            color: #059669;
        }

        .guide-modal-body hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 1.5rem 0;
        }

        @media (max-width: 600px) {
            .kb-cards {
                grid-template-columns: 1fr;
            }

            .guide-modal-overlay {
                padding: 1rem;
            }

            .guide-modal {
                max-height: 95vh;
            }
        }
    </style>
</head>

<body>
    <div class="mac-window">
        <!-- macOS Title Bar -->
        <div class="mac-titlebar">
            <div class="traffic-lights">
                <div class="traffic-light close" title="Close"></div>
                <div class="traffic-light minimize" title="Minimize"></div>
                <div class="traffic-light maximize" title="Maximize"></div>
            </div>
            <div class="mac-title">Media Search Pro</div>
            <div class="header-actions" style="display: flex; align-items: center; gap: 8px;">
                <span id="headerClock" style="font-size: 11px; color: var(--mac-text-secondary);"></span>
                <div id="apiStatusBadge" class="api-status-badge disconnected" onclick="showApiKeyModal()"
                    style="cursor: pointer;">
                    <span class="status-icon">❌</span>
                    <span class="status-text">AI</span>
                </div>
                <button class="settings-btn" onclick="toggleSettings()"
                    style="background: none; border: none; cursor: pointer; font-size: 16px;">⚙️</button>
            </div>
        </div>

        <!-- macOS Main Layout -->
        <div class="mac-layout">
            <!-- Sidebar -->
            <nav class="mac-sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Media</div>
                    <div class="sidebar-item active" onclick="switchMacTab('video')">
                        <span class="icon">🎬</span>Video
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('movie')">
                        <span class="icon">🎥</span>Movie
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('image')">
                        <span class="icon">🖼️</span>Image
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('ebook')">
                        <span class="icon">📚</span>Ebook
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('apk')">
                        <span class="icon">📱</span>APK
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('software')">
                        <span class="icon">💻</span>Software
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">AI Tools</div>
                    <div class="sidebar-item" onclick="switchMacTab('ai')">
                        <span class="icon">🤖</span>AI Search
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('create')">
                        <span class="icon">🎨</span>Create
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('reverse')">
                        <span class="icon">🔄</span>Reverse
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('vision')">
                        <span class="icon">👁️</span>Vision
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Discover</div>
                    <div class="sidebar-item" onclick="switchMacTab('discover')">
                        <span class="icon">🧭</span>Explore
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('knowledge')">
                        <span class="icon">📖</span>Knowledge
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">Your Tools</div>
                    <div class="sidebar-item" onclick="switchMacTab('prompt')">
                        <span class="icon">📝</span>Prompt
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('mytool')">
                        <span class="icon">🧰</span>My Tools
                    </div>
                    <div class="sidebar-item" onclick="switchMacTab('wiki')">
                        <span class="icon">🌐</span>Wiki
                    </div>
                </div>
            </nav>

            <!-- Content Area -->
            <main class="mac-content">
                <div class="container">

                    <!-- Settings Panel (Hidden by default) -->
                    <div class="settings-panel" id="settingsPanel"
                        style="display: none; margin-bottom: 20px; background: var(--mac-card); padding: 16px; border-radius: var(--mac-radius); border: 1px solid var(--mac-border);">
                        <button class="save-settings-btn" onclick="saveSettings()" id="btnSaveSettings">💾 Lưu cài
                            đặt</button>
                        <div class="export-import-btns">
                            <button class="btn-export" onclick="exportSettings()" id="btnExport">📤 Export</button>
                            <button class="btn-import" onclick="importSettings()" id="btnImport">📥 Import</button>
                        </div>

                        <!-- Google Drive Sync Section -->
                        <div class="sync-section">
                            <div class="sync-title">
                                <img src="https://www.google.com/images/branding/googleg/1x/googleg_standard_color_128dp.png"
                                    style="width:16px;height:16px;">
                                <span id="lblCloudSync">Google Drive Sync</span>
                            </div>

                            <!-- Not signed in state -->
                            <div id="driveNotSignedIn">
                                <button class="sync-btn primary" onclick="signInGoogle()" style="width:100%">
                                    <img src="https://www.google.com/favicon.ico"
                                        style="width:14px;height:14px;margin-right:6px;">
                                    Đăng nhập Google
                                </button>
                                <div class="hint"
                                    style="margin-top:0.5rem;font-size:0.65rem;color:var(--mac-text-secondary);">
                                    Đăng nhập để đồng bộ dữ liệu lên Google Drive
                                </div>
                            </div>

                            <!-- Signed in state -->
                            <div id="driveSignedIn" style="display:none;">
                                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;">
                                    <img id="driveUserPhoto" src=""
                                        style="width:24px;height:24px;border-radius:50%;display:none;"
                                        onerror="this.style.display='none'">
                                    <span id="driveUserName" style="font-size:0.75rem;flex:1;"></span>
                                    <button class="sync-btn" onclick="signOutGoogle()" style="font-size:0.65rem;">Đăng
                                        xuất</button>
                                </div>
                                <div class="sync-input-group">
                                    <button class="sync-btn primary" onclick="syncToDrive()" id="btnDriveSyncUp"
                                        style="flex:1;">⬆️
                                        Lưu lên Drive</button>
                                    <button class="sync-btn" onclick="syncFromDrive()" id="btnDriveSyncDown"
                                        style="flex:1;">⬇️ Tải
                                        xuống</button>
                                </div>
                                <div class="sync-status" id="driveStatus"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab content containers are hidden by CSS, shown via JS -->
                    <div class="tabs-wrapper" id="tabsWrapper"
                        style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;">
                        <button class="tab active" data-tab="video" data-category="media" draggable="true"><svg
                                width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M23.5 6.2c-.2-.8-.9-1.4-1.7-1.6C19.9 4 12 4 12 4s-7.9 0-9.8.5c-.8.2-1.5.9-1.7 1.7C0 8.1 0 12 0 12s0 3.9.5 5.8c.2.8.9 1.5 1.7 1.7 1.9.5 9.8.5 9.8.5s7.9 0 9.8-.5c.8-.2 1.5-.9 1.7-1.7.5-1.9.5-5.8.5-5.8s0-3.9-.5-5.8zM9.5 15.5v-7l6.5 3.5-6.5 3.5z" />
                            </svg> Video</button>
                        <button class="tab" data-tab="movie" data-category="media" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z" />
                            </svg> Movie</button>
                        <button class="tab" data-tab="image" data-category="media" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                            </svg> Image</button>
                        <button class="tab" data-tab="ebook" data-category="media" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z" />
                            </svg> Ebook</button>
                        <button class="tab" data-tab="apk" data-category="media" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48C13.85 1.23 12.95 1 12 1c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z" />
                            </svg> APK</button>
                        <button class="tab" data-tab="software" data-category="media" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M0 3.5v17h24v-17H0zm4.4 14.4H2.6v-1.8h1.8v1.8zm0-4.3H2.6v-1.8h1.8v1.8zm0-4.2H2.6V7.6h1.8v1.8zm8.2 8.5H7v-1.8h5.6v1.8zm0-4.3H7v-1.8h5.6v1.8zm0-4.2H7V7.6h5.6v1.8zm8.8 8.5h-6.2v-1.8h1.8v-8.4h-1.8V7.6h6.2v1.8h-1.8v8.4h1.8v1.8z" />
                            </svg> Software</button>
                        <button class="tab" data-tab="ai" data-category="tools" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12zM12.5 8v4.25l3.5 2.08-.72 1.21L11 13V8h1.5z" />
                            </svg> AI</button>
                        <button class="tab" data-tab="wiki" data-category="knowledge" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                            </svg> Wiki</button>
                        <button class="tab" data-tab="create" data-category="tools" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.04 10 9c0 3.31-2.69 6-6 6h-1.77c-.28 0-.5.22-.5.5 0 .12.05.23.13.33.41.47.64 1.06.64 1.67A2.5 2.5 0 0 1 12 22zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8c.28 0 .5-.22.5-.5a.54.54 0 0 0-.14-.35c-.41-.46-.63-1.05-.63-1.65a2.5 2.5 0 0 1 2.5-2.5H16c2.21 0 4-1.79 4-4 0-3.86-3.59-7-8-7z" />
                                <circle cx="6.5" cy="11.5" r="1.5" />
                                <circle cx="9.5" cy="7.5" r="1.5" />
                                <circle cx="14.5" cy="7.5" r="1.5" />
                                <circle cx="17.5" cy="11.5" r="1.5" />
                            </svg> Create</button>
                        <button class="tab" data-tab="reverse" data-category="tools" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                            </svg> Reverse</button>
                        <button class="tab" data-tab="discover" data-category="knowledge" draggable="true"><svg
                                width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z" />
                            </svg> Discover</button>
                        <button class="tab" data-tab="vision" data-category="tools" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                            </svg> Vision</button>
                        <button class="tab" data-tab="mytool" data-category="tools" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z" />
                            </svg> My Tool</button>
                        <button class="tab" data-tab="prompt" data-category="tools" draggable="true"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                            </svg> Prompt</button>
                        <button class="tab" data-tab="knowledge" data-category="knowledge" draggable="true"><svg
                                width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z" />
                            </svg> Knowledge</button>
                    </div>
                </div>

                <!-- VIDEO TAB -->
                <div class="tab-content active" id="video-tab">
                    <!-- Script Analysis -->
                    <div class="script-section">
                        <div class="script-header">
                            <span class="script-title">📝 Phân tích nội dung</span>
                            <span class="script-hint">Nhập kịch bản, tên, hoặc khái niệm</span>
                        </div>
                        <textarea id="videoScript" class="script-textarea"
                            placeholder="Nhập bất kỳ nội dung nào...&#10;&#10;Ví dụ:&#10;• Kịch bản: Dự án kênh đào Kachhi ở Pakistan...&#10;• Tên công trình: Đập Tam Hiệp&#10;• Khái niệm: Năng lượng tái tạo&#10;• Nhân vật: Elon Musk"></textarea>
                        <button class="analyze-btn" id="analyzeBtn" onclick="analyzeScript('video')">
                            ✨ Gợi ý từ khóa
                        </button>
                    </div>

                    <!-- Suggestions -->
                    <div class="suggestions" id="videoSuggestions">
                        <div class="suggestions-title">💡 Từ khóa gợi ý</div>
                        <div id="videoSuggestionContent"></div>
                        <!-- AI Suggestions will be added here -->
                        <div id="aiSuggestions" style="display: none;">
                            <div class="ai-loading" id="aiLoading">
                                <span class="loading"></span> Đang phân tích bằng AI...
                            </div>
                            <div id="aiSuggestionContent"></div>
                        </div>
                    </div>

                    <div class="search-wrapper">
                        <input type="text" id="videoInput" class="search-input" placeholder="Từ khóa tìm kiếm..."
                            autofocus>

                        <!-- Google-style Country Selector -->
                        <div class="country-selector" id="videoCountrySelector">
                            <button class="country-tab active" data-country="" data-lang=""
                                onclick="selectCountryTab('video', this)">Tất cả</button>
                            <button class="country-tab" data-country="VN" data-lang="vi"
                                onclick="selectCountryTab('video', this)">🇻🇳 Việt</button>
                            <button class="country-tab" data-country="US" data-lang="en"
                                onclick="selectCountryTab('video', this)">🇺🇸 Anh</button>
                            <button class="country-tab" data-country="CN" data-lang="zh-CN"
                                onclick="selectCountryTab('video', this)">🇨🇳 Trung</button>
                            <button class="country-tab" data-country="JP" data-lang="ja"
                                onclick="selectCountryTab('video', this)">🇯🇵 Nhật</button>
                            <button class="country-more-btn" onclick="toggleCountryDropdown('video')">Thêm ▼</button>

                            <div class="country-dropdown" id="videoCountryDropdown">
                                <input type="text" class="country-search" placeholder="Tìm kiếm ngôn ngữ"
                                    oninput="filterCountries('video', this.value)">
                                <div class="country-grid" id="videoCountryGrid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Global</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="youtube"><span
                                    class="platform-label"><span class="platform-icon">▶️</span>YouTube</span></label>
                            <label class="platform"><input type="checkbox" data-p="tiktok"><span
                                    class="platform-label"><span class="platform-icon">🎵</span>TikTok</span></label>
                            <label class="platform"><input type="checkbox" data-p="instagram"><span
                                    class="platform-label"><span class="platform-icon">📷</span>Instagram</span></label>
                            <label class="platform"><input type="checkbox" data-p="facebook"><span
                                    class="platform-label"><span class="platform-icon">📘</span>Facebook</span></label>
                            <label class="platform"><input type="checkbox" data-p="googlevideos"><span
                                    class="platform-label"><span class="platform-icon">🔍</span>Google</span></label>
                            <label class="platform"><input type="checkbox" data-p="vimeo"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>Vimeo</span></label>
                            <label class="platform"><input type="checkbox" data-p="dailymotion"><span
                                    class="platform-label"><span
                                        class="platform-icon">📹</span>Dailymotion</span></label>
                            <label class="platform"><input type="checkbox" data-p="twitch"><span
                                    class="platform-label"><span class="platform-icon">🎮</span>Twitch</span></label>
                            <label class="platform"><input type="checkbox" data-p="rumble"><span
                                    class="platform-label"><span class="platform-icon">📺</span>Rumble</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">China <span class="badge hot">HOT</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="douyin"><span
                                    class="platform-label"><span class="platform-icon">🎶</span>Douyin</span></label>
                            <label class="platform"><input type="checkbox" data-p="bilibili"><span
                                    class="platform-label"><span class="platform-icon">📺</span>Bilibili</span></label>
                            <label class="platform"><input type="checkbox" data-p="kuaishou"><span
                                    class="platform-label"><span class="platform-icon">⚡</span>Kuaishou</span></label>
                            <label class="platform"><input type="checkbox" data-p="xiaohongshu"><span
                                    class="platform-label"><span class="platform-icon">📕</span>小红书</span></label>
                            <label class="platform"><input type="checkbox" data-p="weibo"><span
                                    class="platform-label"><span class="platform-icon">🔴</span>Weibo</span></label>
                            <label class="platform"><input type="checkbox" data-p="youku"><span
                                    class="platform-label"><span class="platform-icon">🎭</span>优酷</span></label>
                            <label class="platform"><input type="checkbox" data-p="iqiyi"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>爱奇艺</span></label>
                            <label class="platform"><input type="checkbox" data-p="tencentvideo"><span
                                    class="platform-label"><span class="platform-icon">📱</span>腾讯视频</span></label>
                            <label class="platform"><input type="checkbox" data-p="mangotv"><span
                                    class="platform-label"><span class="platform-icon">🥭</span>芒果TV</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎬 Stock Free</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="pexelsvideo"><span
                                    class="platform-label"><span class="platform-icon">🎥</span>Pexels
                                    Video</span></label>
                            <label class="platform"><input type="checkbox" data-p="pixabayvideo"><span
                                    class="platform-label"><span class="platform-icon">🎞️</span>Pixabay
                                    Video</span></label>
                            <label class="platform"><input type="checkbox" data-p="coverr"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>Coverr</span></label>
                            <label class="platform"><input type="checkbox" data-p="videezy"><span
                                    class="platform-label"><span class="platform-icon">📹</span>Videezy</span></label>
                            <label class="platform"><input type="checkbox" data-p="lifeofvids"><span
                                    class="platform-label"><span class="platform-icon">🌿</span>Life of
                                    Vids</span></label>
                            <label class="platform"><input type="checkbox" data-p="mazwai"><span
                                    class="platform-label"><span class="platform-icon">🎨</span>Mazwai</span></label>
                            <label class="platform"><input type="checkbox" data-p="vidsplay"><span
                                    class="platform-label"><span class="platform-icon">▶️</span>Vidsplay</span></label>
                            <label class="platform"><input type="checkbox" data-p="vecteezy"><span
                                    class="platform-label"><span class="platform-icon">🎯</span>Vecteezy</span></label>
                            <label class="platform"><input type="checkbox" data-p="dareful"><span
                                    class="platform-label"><span class="platform-icon">🌟</span>Dareful</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="videoSearchBtn">Search<span class="count"
                                id="videoCount">10</span></button>
                        <button class="btn-select" onclick="toggleAll('video')">Toggle</button>
                    </div>
                </div>

                <!-- MOVIE TAB -->
                <div class="tab-content" id="movie-tab">
                    <div class="search-wrapper">
                        <input type="text" id="movieInput" class="search-input"
                            placeholder="Tên phim, diễn viên, đạo diễn...">
                    </div>

                    <div class="section">
                        <div class="section-title">🌐 Xem phim miễn phí <span class="badge">Global Hot</span></div>
                        <div class="section-desc">Các trang được recommend nhiều nhất trên Reddit 2024</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="hydrahd"><span
                                    class="platform-label"><span class="platform-icon">💧</span>HydraHD</span></label>
                            <label class="platform"><input type="checkbox" data-p="cineby"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>Cineby</span></label>
                            <label class="platform"><input type="checkbox" data-p="fmovies"><span
                                    class="platform-label"><span class="platform-icon">🎞️</span>FMovies</span></label>
                            <label class="platform"><input type="checkbox" data-p="m4uhd"><span
                                    class="platform-label"><span class="platform-icon">📺</span>M4uHD</span></label>
                            <label class="platform"><input type="checkbox" data-p="movie456"><span
                                    class="platform-label"><span class="platform-icon">🔥</span>456Movie</span></label>
                            <label class="platform"><input type="checkbox" data-p="sflix"><span
                                    class="platform-label"><span class="platform-icon">⚡</span>Sflix</span></label>
                            <label class="platform"><input type="checkbox" data-p="flixhq"><span
                                    class="platform-label"><span class="platform-icon">🎥</span>FlixHQ</span></label>
                            <label class="platform"><input type="checkbox" data-p="soap2day"><span
                                    class="platform-label"><span class="platform-icon">🧼</span>Soap2Day</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📺 Streaming hợp pháp <span class="badge ai">Free + Ads</span></div>
                        <div class="section-desc">Tubi, Plex, Pluto: Miễn phí, có quảng cáo, an toàn</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="tubi"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>Tubi</span></label>
                            <label class="platform"><input type="checkbox" data-p="plextv"><span
                                    class="platform-label"><span class="platform-icon">🟡</span>Plex</span></label>
                            <label class="platform"><input type="checkbox" data-p="plutotv"><span
                                    class="platform-label"><span class="platform-icon">🪐</span>Pluto TV</span></label>
                            <label class="platform"><input type="checkbox" data-p="rokuchannel"><span
                                    class="platform-label"><span class="platform-icon">📺</span>Roku
                                    Channel</span></label>
                            <label class="platform"><input type="checkbox" data-p="peacock"><span
                                    class="platform-label"><span class="platform-icon">🦚</span>Peacock</span></label>
                            <label class="platform"><input type="checkbox" data-p="freevee"><span
                                    class="platform-label"><span class="platform-icon">📼</span>Freevee</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📚 Database & Reviews <span class="badge">Rating</span></div>
                        <div class="section-desc">Tra cứu điểm số, thông tin phim</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="imdb"><span
                                    class="platform-label"><span class="platform-icon">⭐</span>IMDb</span></label>
                            <label class="platform"><input type="checkbox" data-p="letterboxd"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎞️</span>Letterboxd</span></label>
                            <label class="platform"><input type="checkbox" data-p="rottentomatoes"><span
                                    class="platform-label"><span class="platform-icon">🍅</span>Rotten
                                    Tomatoes</span></label>
                            <label class="platform"><input type="checkbox" data-p="justwatch"><span
                                    class="platform-label"><span class="platform-icon">🔍</span>JustWatch</span></label>
                            <label class="platform"><input type="checkbox" data-p="tmdb"><span
                                    class="platform-label"><span class="platform-icon">🎥</span>TMDb</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 Trung Quốc <span class="badge">Hot 2024</span></div>
                        <div class="section-desc">茶杯狐/Libvio: Tổng hợp lớn nhất • 多瑙/独播库: Ổn định</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="cupfox"><span
                                    class="platform-label"><span class="platform-icon">🦊</span>茶杯狐
                                    Cupfox</span></label>
                            <label class="platform"><input type="checkbox" data-p="libvio"><span
                                    class="platform-label"><span class="platform-icon">📺</span>Libvio</span></label>
                            <label class="platform"><input type="checkbox" data-p="iyf"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>爱壹帆 iYF</span></label>
                            <label class="platform"><input type="checkbox" data-p="duonao"><span
                                    class="platform-label"><span class="platform-icon">🎥</span>多瑙 Duonao</span></label>
                            <label class="platform"><input type="checkbox" data-p="duboku"><span
                                    class="platform-label"><span class="platform-icon">📚</span>独播库
                                    Duboku</span></label>
                            <label class="platform"><input type="checkbox" data-p="cnys"><span
                                    class="platform-label"><span class="platform-icon">🎞️</span>CN影院</span></label>
                            <label class="platform"><input type="checkbox" data-p="olevod"><span
                                    class="platform-label"><span class="platform-icon">🟢</span>欧乐影院</span></label>
                            <label class="platform"><input type="checkbox" data-p="nivod"><span
                                    class="platform-label"><span class="platform-icon">📺</span>泥视频 Nivod</span></label>
                            <label class="platform"><input type="checkbox" data-p="douban"><span
                                    class="platform-label"><span class="platform-icon">🌱</span>豆瓣 Douban</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇷🇺 Nga <span class="badge">Premium</span></div>
                        <div class="section-desc">Kinopoisk: IMDb của Nga • HDRezka: Lậu lớn nhất</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="hdrezka"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>HDRezka</span></label>
                            <label class="platform"><input type="checkbox" data-p="kinopoisk"><span
                                    class="platform-label"><span class="platform-icon">🎥</span>Кинопоиск</span></label>
                            <label class="platform"><input type="checkbox" data-p="ivi"><span
                                    class="platform-label"><span class="platform-icon">📺</span>Ivi</span></label>
                            <label class="platform"><input type="checkbox" data-p="okko"><span
                                    class="platform-label"><span class="platform-icon">🟣</span>Okko</span></label>
                            <label class="platform"><input type="checkbox" data-p="lordfilm"><span
                                    class="platform-label"><span class="platform-icon">👑</span>Lordfilm</span></label>
                            <label class="platform"><input type="checkbox" data-p="kinogo"><span
                                    class="platform-label"><span class="platform-icon">🎞️</span>Kinogo</span></label>
                            <label class="platform"><input type="checkbox" data-p="start"><span
                                    class="platform-label"><span class="platform-icon">▶️</span>START</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="movieSearchBtn">Search<span class="count"
                                id="movieCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('movie')">Toggle</button>
                    </div>
                </div>

                <!-- IMAGE TAB -->
                <div class="tab-content" id="image-tab">
                    <div class="search-wrapper">
                        <input type="text" id="imageInput" class="search-input" placeholder="Từ khóa tìm kiếm...">

                        <!-- Google-style Country Selector -->
                        <div class="country-selector" id="imageCountrySelector">
                            <button class="country-tab active" data-country="" data-lang=""
                                onclick="selectCountryTab('image', this)">Tất cả</button>
                            <button class="country-tab" data-country="VN" data-lang="vi"
                                onclick="selectCountryTab('image', this)">🇻🇳 Việt</button>
                            <button class="country-tab" data-country="US" data-lang="en"
                                onclick="selectCountryTab('image', this)">🇺🇸 Anh</button>
                            <button class="country-tab" data-country="CN" data-lang="zh-CN"
                                onclick="selectCountryTab('image', this)">🇨🇳 Trung</button>
                            <button class="country-tab" data-country="JP" data-lang="ja"
                                onclick="selectCountryTab('image', this)">🇯🇵 Nhật</button>
                            <button class="country-more-btn" onclick="toggleCountryDropdown('image')">Thêm ▼</button>

                            <div class="country-dropdown" id="imageCountryDropdown">
                                <input type="text" class="country-search" placeholder="Tìm kiếm ngôn ngữ"
                                    oninput="filterCountries('image', this.value)">
                                <div class="country-grid" id="imageCountryGrid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Search Engines</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="googleimages"><span
                                    class="platform-label"><span class="platform-icon">🔍</span>Google</span></label>
                            <label class="platform"><input type="checkbox" data-p="yandex"><span
                                    class="platform-label"><span class="platform-icon">🔴</span>Yandex</span></label>
                            <label class="platform"><input type="checkbox" data-p="bingimages"><span
                                    class="platform-label"><span class="platform-icon">🔷</span>Bing</span></label>
                            <label class="platform"><input type="checkbox" data-p="pinterest"><span
                                    class="platform-label"><span class="platform-icon">📌</span>Pinterest</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Reverse Search <span class="badge ai">AI</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="tineye"><span
                                    class="platform-label"><span class="platform-icon">👁️</span>TinEye</span></label>
                            <label class="platform"><input type="checkbox" data-p="lenso"><span
                                    class="platform-label"><span class="platform-icon">🔎</span>Lenso</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Stock Free</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="unsplash"><span
                                    class="platform-label"><span class="platform-icon">📸</span>Unsplash</span></label>
                            <label class="platform"><input type="checkbox" data-p="pexels"><span
                                    class="platform-label"><span class="platform-icon">🖼️</span>Pexels</span></label>
                            <label class="platform"><input type="checkbox" data-p="pixabay"><span
                                    class="platform-label"><span class="platform-icon">🌈</span>Pixabay</span></label>
                            <label class="platform"><input type="checkbox" data-p="freepik"><span
                                    class="platform-label"><span class="platform-icon">🎨</span>Freepik</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">Design</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="behance"><span
                                    class="platform-label"><span class="platform-icon">🅱️</span>Behance</span></label>
                            <label class="platform"><input type="checkbox" data-p="dribbble"><span
                                    class="platform-label"><span class="platform-icon">🏀</span>Dribbble</span></label>
                            <label class="platform"><input type="checkbox" data-p="artstation"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎮</span>ArtStation</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">China <span class="badge hot">HOT</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="baidu"><span
                                    class="platform-label"><span class="platform-icon">🔵</span>Baidu</span></label>
                            <label class="platform"><input type="checkbox" data-p="sogou"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>Sogou</span></label>
                            <label class="platform"><input type="checkbox" data-p="huaban"><span
                                    class="platform-label"><span class="platform-icon">🌸</span>Huaban</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="imageSearchBtn">Search<span class="count"
                                id="imageCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('image')">Toggle</button>
                    </div>
                </div>

                <!-- EBOOK TAB -->
                <div class="tab-content" id="ebook-tab">
                    <div class="search-wrapper">
                        <input type="text" id="ebookInput" class="search-input"
                            placeholder="Tên sách, tác giả, ISBN...">

                        <!-- Google-style Country Selector -->
                        <div class="country-selector" id="ebookCountrySelector">
                            <button class="country-tab active" data-country="" data-lang=""
                                onclick="selectCountryTab('ebook', this)">Tất cả</button>
                            <button class="country-tab" data-country="VN" data-lang="vi"
                                onclick="selectCountryTab('ebook', this)">🇻🇳 Việt</button>
                            <button class="country-tab" data-country="US" data-lang="en"
                                onclick="selectCountryTab('ebook', this)">🇺🇸 Anh</button>
                            <button class="country-tab" data-country="CN" data-lang="zh-CN"
                                onclick="selectCountryTab('ebook', this)">🇨🇳 Trung</button>
                            <button class="country-more-btn" onclick="toggleCountryDropdown('ebook')">Thêm ▼</button>

                            <div class="country-dropdown" id="ebookCountryDropdown">
                                <input type="text" class="country-search" placeholder="Tìm kiếm ngôn ngữ"
                                    oninput="filterCountries('ebook', this.value)">
                                <div class="country-grid" id="ebookCountryGrid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🔥 Mega Search <span class="badge hot">HOT</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="annas"><span
                                    class="platform-label"><span class="platform-icon">📚</span>Anna's
                                    Archive</span></label>
                            <label class="platform"><input type="checkbox" data-p="libgen"><span
                                    class="platform-label"><span class="platform-icon">📖</span>Library
                                    Genesis</span></label>
                            <label class="platform"><input type="checkbox" data-p="zlibrary"><span
                                    class="platform-label"><span class="platform-icon">📕</span>Z-Library</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🌐 Search Engines</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="pdfdrive"><span
                                    class="platform-label"><span class="platform-icon">📄</span>PDF Drive</span></label>
                            <label class="platform"><input type="checkbox" data-p="oceanofpdf"><span
                                    class="platform-label"><span
                                        class="platform-icon">🌊</span>OceanofPDF</span></label>
                            <label class="platform"><input type="checkbox" data-p="pdfbooksworld"><span
                                    class="platform-label"><span
                                        class="platform-icon">🌍</span>PDFBooksWorld</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📖 Public Domain (Hợp pháp)</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="gutenberg"><span
                                    class="platform-label"><span class="platform-icon">📜</span>Project
                                    Gutenberg</span></label>
                            <label class="platform"><input type="checkbox" data-p="openlibrary"><span
                                    class="platform-label"><span class="platform-icon">🏛️</span>Open
                                    Library</span></label>
                            <label class="platform"><input type="checkbox" data-p="archive"><span
                                    class="platform-label"><span class="platform-icon">🗄️</span>Internet
                                    Archive</span></label>
                            <label class="platform"><input type="checkbox" data-p="standardebooks"><span
                                    class="platform-label"><span class="platform-icon">✨</span>Standard
                                    Ebooks</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📕 Indie & Free</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="manybooks"><span
                                    class="platform-label"><span class="platform-icon">📚</span>ManyBooks</span></label>
                            <label class="platform"><input type="checkbox" data-p="smashwords"><span
                                    class="platform-label"><span
                                        class="platform-icon">💥</span>Smashwords</span></label>
                            <label class="platform"><input type="checkbox" data-p="obooko"><span
                                    class="platform-label"><span class="platform-icon">📘</span>Obooko</span></label>
                            <label class="platform"><input type="checkbox" data-p="epubbooks"><span
                                    class="platform-label"><span class="platform-icon">📱</span>epubBooks</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎓 Academic & Textbooks</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="bookboon"><span
                                    class="platform-label"><span class="platform-icon">🎓</span>Bookboon</span></label>
                            <label class="platform"><input type="checkbox" data-p="googlebooks"><span
                                    class="platform-label"><span class="platform-icon">📗</span>Google
                                    Books</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="ebookSearchBtn">Search<span class="count"
                                id="ebookCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('ebook')">Toggle</button>
                    </div>
                </div>


                <!-- APK MOD TAB -->
                <div class="tab-content" id="apk-tab">
                    <div class="search-wrapper">
                        <input type="text" id="apkInput" class="search-input" placeholder="Tên app, game Android...">
                    </div>

                    <div class="section">
                        <div class="section-title">🔥 Forum Uy Tín <span class="badge hot">HOT</span></div>
                        <div class="section-desc">Mobilism, Platinmods: Forum mod APK lớn nhất thế giới</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="mobilism"><span
                                    class="platform-label"><span class="platform-icon">📋</span>Mobilism</span></label>
                            <label class="platform"><input type="checkbox" data-p="platinmods"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎮</span>Platinmods</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🌍 Global Sites</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="modyolo"><span
                                    class="platform-label"><span class="platform-icon">📦</span>Modyolo</span></label>
                            <label class="platform"><input type="checkbox" data-p="liteapks"><span
                                    class="platform-label"><span class="platform-icon">⚡</span>Liteapks</span></label>
                            <label class="platform"><input type="checkbox" data-p="apkdone"><span
                                    class="platform-label"><span class="platform-icon">✅</span>APKdone</span></label>
                            <label class="platform"><input type="checkbox" data-p="happymod"><span
                                    class="platform-label"><span class="platform-icon">😊</span>Happymod</span></label>
                            <label class="platform"><input type="checkbox" data-p="an1"><span
                                    class="platform-label"><span class="platform-icon">1️⃣</span>An1.com</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇷🇺 Nga / Đông Âu</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="androeed"><span
                                    class="platform-label"><span
                                        class="platform-icon">🇷🇺</span>Androeed</span></label>
                            <label class="platform"><input type="checkbox" data-p="5play"><span
                                    class="platform-label"><span class="platform-icon">5️⃣</span>5play.ru</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 Trung Quốc</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="huluxia"><span
                                    class="platform-label"><span class="platform-icon">🫛</span>葫芦侠</span></label>
                            <label class="platform"><input type="checkbox" data-p="coolapk"><span
                                    class="platform-label"><span class="platform-icon">🍏</span>酷安</span></label>
                            <label class="platform"><input type="checkbox" data-p="ddooo"><span
                                    class="platform-label"><span class="platform-icon">📱</span>多多软件</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📦 APK Official</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="apkpure"><span
                                    class="platform-label"><span class="platform-icon">🟣</span>APKPure</span></label>
                            <label class="platform"><input type="checkbox" data-p="apkmirror"><span
                                    class="platform-label"><span class="platform-icon">🪞</span>APKMirror</span></label>
                            <label class="platform"><input type="checkbox" data-p="uptodown"><span
                                    class="platform-label"><span class="platform-icon">⬇️</span>Uptodown</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="apkSearchBtn">Search<span class="count"
                                id="apkCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('apk')">Toggle</button>
                    </div>
                </div>

                <!-- SOFTWARE TAB -->
                <div class="tab-content" id="software-tab">
                    <div class="search-wrapper">
                        <input type="text" id="softwareInput" class="search-input"
                            placeholder="Tên phần mềm, game PC, Windows...">
                    </div>

                    <div class="section">
                        <div class="section-title">🔥 Torrent Hot <span class="badge hot">TOP</span></div>
                        <div class="section-desc">RuTracker: 15.5M users, lớn nhất thế giới • 1337x: Đa năng</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="rutracker"><span
                                    class="platform-label"><span class="platform-icon">🔴</span>RuTracker</span></label>
                            <label class="platform"><input type="checkbox" data-p="1337x"><span
                                    class="platform-label"><span class="platform-icon">🔥</span>1337x</span></label>
                            <label class="platform"><input type="checkbox" data-p="piratebay"><span
                                    class="platform-label"><span
                                        class="platform-icon">🏴‍☠️</span>PirateBay</span></label>
                            <label class="platform"><input type="checkbox" data-p="torrentgalaxy"><span
                                    class="platform-label"><span
                                        class="platform-icon">🌌</span>TorrentGalaxy</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎮 Game PC Repacks</div>
                        <div class="section-desc">FitGirl: Nén cao, tiết kiệm dung lượng • DODI: Cài nhanh</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="fitgirl"><span
                                    class="platform-label"><span class="platform-icon">🎮</span>FitGirl
                                    Repacks</span></label>
                            <label class="platform"><input type="checkbox" data-p="dodi"><span
                                    class="platform-label"><span class="platform-icon">🕹️</span>DODI
                                    Repacks</span></label>
                            <label class="platform"><input type="checkbox" data-p="steamrip"><span
                                    class="platform-label"><span class="platform-icon">💨</span>SteamRip</span></label>
                            <label class="platform"><input type="checkbox" data-p="gog-games"><span
                                    class="platform-label"><span class="platform-icon">📦</span>GOG Games</span></label>
                            <label class="platform"><input type="checkbox" data-p="ovagames"><span
                                    class="platform-label"><span class="platform-icon">🎯</span>OvaGames</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇷🇺 Nga - PC Software <span class="badge">Premium</span></div>
                        <div class="section-desc">RSLoad: Phần mềm Windows đầy đủ • NNM-Club: Torrent semi-private</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="rsload"><span
                                    class="platform-label"><span class="platform-icon">📥</span>RSLoad</span></label>
                            <label class="platform"><input type="checkbox" data-p="nnmclub"><span
                                    class="platform-label"><span class="platform-icon">🎯</span>NNM-Club</span></label>
                            <label class="platform"><input type="checkbox" data-p="rutor"><span
                                    class="platform-label"><span class="platform-icon">🌀</span>Rutor</span></label>
                            <label class="platform"><input type="checkbox" data-p="softportal"><span
                                    class="platform-label"><span
                                        class="platform-icon">📦</span>SoftPortal</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 Trung Quốc - PC Software <span class="badge">破解</span></div>
                        <div class="section-desc">吾爱破解 52pojie: Forum lớn nhất • 果核剥壳: Chất lượng cao</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="52pojie"><span
                                    class="platform-label"><span class="platform-icon">💜</span>吾爱破解
                                    52pojie</span></label>
                            <label class="platform"><input type="checkbox" data-p="ghboke"><span
                                    class="platform-label"><span class="platform-icon">🥜</span>果核剥壳</span></label>
                            <label class="platform"><input type="checkbox" data-p="423down"><span
                                    class="platform-label"><span class="platform-icon">📥</span>423Down</span></label>
                            <label class="platform"><input type="checkbox" data-p="iplaysoft"><span
                                    class="platform-label"><span class="platform-icon">🎨</span>异次元软件</span></label>
                            <label class="platform"><input type="checkbox" data-p="carrotchou"><span
                                    class="platform-label"><span class="platform-icon">🥕</span>胡萝卜周</span></label>
                            <label class="platform"><input type="checkbox" data-p="masuit"><span
                                    class="platform-label"><span class="platform-icon">🔧</span>懒得勤快</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📦 Direct Download</div>
                        <div class="section-desc">Không cần torrent client, tải trực tiếp</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="getintopc"><span
                                    class="platform-label"><span class="platform-icon">💻</span>GetIntoPC</span></label>
                            <label class="platform"><input type="checkbox" data-p="filecr"><span
                                    class="platform-label"><span class="platform-icon">📂</span>FileCR</span></label>
                            <label class="platform"><input type="checkbox" data-p="nsaneforums"><span
                                    class="platform-label"><span class="platform-icon">🔥</span>Nsane
                                    Forums</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="softwareSearchBtn">Search<span class="count"
                                id="softwareCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('software')">Toggle</button>
                    </div>
                </div>

                <!-- AI TAB -->
                <div class="tab-content" id="ai-tab">
                    <div class="section">
                        <div class="section-title">🌍 Global - Big 3 <span class="badge hot">TOP</span></div>
                        <div class="section-desc">
                            <strong>ChatGPT:</strong> Đa năng, viết sáng tạo •
                            <strong>Claude:</strong> Viết dài, phân tích tài liệu •
                            <strong>Gemini:</strong> Tích hợp Google, dữ liệu mới nhất
                        </div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="chatgpt"><span
                                    class="platform-label"><span class="platform-icon">💬</span>ChatGPT</span></label>
                            <label class="platform"><input type="checkbox" data-p="claude"><span
                                    class="platform-label"><span class="platform-icon">🧠</span>Claude</span></label>
                            <label class="platform"><input type="checkbox" data-p="gemini"><span
                                    class="platform-label"><span class="platform-icon">✨</span>Gemini</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🔥 Global - More</div>
                        <div class="section-desc">
                            <strong>Perplexity:</strong> Search AI với nguồn trích dẫn •
                            <strong>Copilot:</strong> Tích hợp Microsoft •
                            <strong>Grok:</strong> X/Twitter real-time •
                            <strong>Poe:</strong> Nhiều AI trong 1 app
                        </div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="perplexity"><span
                                    class="platform-label"><span
                                        class="platform-icon">🔍</span>Perplexity</span></label>
                            <label class="platform"><input type="checkbox" data-p="copilot"><span
                                    class="platform-label"><span class="platform-icon">🪟</span>Copilot</span></label>
                            <label class="platform"><input type="checkbox" data-p="grok"><span
                                    class="platform-label"><span class="platform-icon">🚀</span>Grok (X)</span></label>
                            <label class="platform"><input type="checkbox" data-p="poe"><span
                                    class="platform-label"><span class="platform-icon">📱</span>Poe</span></label>
                            <label class="platform"><input type="checkbox" data-p="you"><span
                                    class="platform-label"><span class="platform-icon">🌐</span>You.com</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">💻 Coding AI</div>
                        <div class="section-desc">
                            <strong>Cursor:</strong> IDE AI tốt nhất cho dev •
                            <strong>Replit:</strong> Online IDE •
                            <strong>Codeium:</strong> Gợi ý code miễn phí •
                            <strong>Phind:</strong> Search cho lập trình viên
                        </div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="cursor"><span
                                    class="platform-label"><span class="platform-icon">⌨️</span>Cursor</span></label>
                            <label class="platform"><input type="checkbox" data-p="replit"><span
                                    class="platform-label"><span class="platform-icon">💾</span>Replit AI</span></label>
                            <label class="platform"><input type="checkbox" data-p="codeium"><span
                                    class="platform-label"><span class="platform-icon">🔧</span>Codeium</span></label>
                            <label class="platform"><input type="checkbox" data-p="phind"><span
                                    class="platform-label"><span class="platform-icon">🔎</span>Phind</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 Trung Quốc</div>
                        <div class="section-desc">
                            <strong>Kimi:</strong> Đọc tài liệu dài 200K •
                            <strong>DeepSeek:</strong> Toán & code xuất sắc •
                            Ernie, Qianwen, Doubao: AI nội địa TQ
                        </div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="ernie"><span
                                    class="platform-label"><span class="platform-icon">🐼</span>文心一言</span></label>
                            <label class="platform"><input type="checkbox" data-p="qianwen"><span
                                    class="platform-label"><span class="platform-icon">☁️</span>通义千问</span></label>
                            <label class="platform"><input type="checkbox" data-p="kimi"><span
                                    class="platform-label"><span class="platform-icon">🌙</span>Kimi</span></label>
                            <label class="platform"><input type="checkbox" data-p="doubao"><span
                                    class="platform-label"><span class="platform-icon">🎁</span>豆包</span></label>
                            <label class="platform"><input type="checkbox" data-p="deepseek"><span
                                    class="platform-label"><span class="platform-icon">🔬</span>DeepSeek</span></label>
                            <label class="platform"><input type="checkbox" data-p="zhipu"><span
                                    class="platform-label"><span class="platform-icon">🎯</span>智谱清言</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎨 Image AI</div>
                        <div class="section-desc">
                            <strong>Midjourney:</strong> Ảnh nghệ thuật đẹp nhất •
                            <strong>DALL-E:</strong> Tích hợp ChatGPT •
                            <strong>Ideogram:</strong> Render chữ chuẩn •
                            <strong>Leonardo:</strong> Game art & concept
                        </div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="midjourney"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎨</span>Midjourney</span></label>
                            <label class="platform"><input type="checkbox" data-p="dalle"><span
                                    class="platform-label"><span class="platform-icon">🖼️</span>DALL-E 3</span></label>
                            <label class="platform"><input type="checkbox" data-p="ideogram"><span
                                    class="platform-label"><span class="platform-icon">✏️</span>Ideogram</span></label>
                            <label class="platform"><input type="checkbox" data-p="leonardo"><span
                                    class="platform-label"><span class="platform-icon">🎭</span>Leonardo</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="aiSearchBtn">Open<span class="count"
                                id="aiCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('ai')">Toggle</button>
                    </div>
                </div>

                <!-- WIKI TAB -->
                <div class="tab-content" id="wiki-tab">
                    <div class="search-wrapper" style="display:flex;gap:0.5rem;align-items:center;">
                        <input type="text" id="wikiInput" class="search-input" style="flex:1;"
                            placeholder="Tìm kiến thức, thuật ngữ, khái niệm..."
                            onkeypress="if(event.key==='Enter')previewWikipedia()">
                        <button class="btn-preview" onclick="previewWikipedia()">📖 Preview</button>
                    </div>

                    <!-- Wikipedia Preview Result - Above Global -->
                    <div id="wikiPreviewResult" class="wiki-preview-container" style="display:none;">
                        <div class="wiki-preview-loading" id="wikiLoading" style="display:none;">
                            <span class="loading"></span> Đang tải từ Wikipedia tiếng Việt...
                        </div>
                        <div id="wikiPreviewContent"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">🌍 Global <span class="badge hot">TOP</span></div>
                        <div class="section-desc">Wikipedia: 62M+ bài lớn nhất TG • Britannica: Uy tín nhất từ 1768
                        </div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="wikipedia"><span
                                    class="platform-label"><span class="platform-icon">🌐</span>Wikipedia</span></label>
                            <label class="platform"><input type="checkbox" data-p="britannica"><span
                                    class="platform-label"><span
                                        class="platform-icon">📘</span>Britannica</span></label>
                            <label class="platform"><input type="checkbox" data-p="scholarpedia"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎓</span>Scholarpedia</span></label>
                            <label class="platform"><input type="checkbox" data-p="encyclopedia"><span
                                    class="platform-label"><span
                                        class="platform-icon">📖</span>Encyclopedia.com</span></label>
                            <label class="platform"><input type="checkbox" data-p="stanfordphil"><span
                                    class="platform-label"><span class="platform-icon">🏛️</span>Stanford
                                    Philosophy</span></label>
                            <label class="platform"><input type="checkbox" data-p="handwiki"><span
                                    class="platform-label"><span class="platform-icon">✋</span>HandWiki</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 Trung Quốc <span class="badge">28.6M bài</span></div>
                        <div class="section-desc">百度百科: Lớn nhất TQ 28.6M bài • 知乎: 220M users Q&A chuyên sâu</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="baidubaike"><span
                                    class="platform-label"><span class="platform-icon">📙</span>百度百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="zhihu"><span
                                    class="platform-label"><span class="platform-icon">🔵</span>知乎</span></label>
                            <label class="platform"><input type="checkbox" data-p="sogoubaike"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>搜狗百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="360baike"><span
                                    class="platform-label"><span class="platform-icon">🟢</span>360百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="kuaidong"><span
                                    class="platform-label"><span class="platform-icon">📱</span>快懂百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="zgbk"><span
                                    class="platform-label"><span class="platform-icon">🏛️</span>中国大百科</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇷🇺 Nga <span class="badge">NEW 2024</span></div>
                        <div class="section-desc">Рувики: 2M+ bài, YandexGPT AI • Кругосвет: Bộ GD Nga khuyên dùng</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="ruwiki"><span
                                    class="platform-label"><span class="platform-icon">📕</span>Рувики</span></label>
                            <label class="platform"><input type="checkbox" data-p="ruwikipedia"><span
                                    class="platform-label"><span class="platform-icon">🌐</span>Русская
                                    Wikipedia</span></label>
                            <label class="platform"><input type="checkbox" data-p="krugosvet"><span
                                    class="platform-label"><span class="platform-icon">🌍</span>Кругосвет</span></label>
                            <label class="platform"><input type="checkbox" data-p="akademik"><span
                                    class="platform-label"><span class="platform-icon">📚</span>Академик</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="wikiSearchBtn">Search<span class="count"
                                id="wikiCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('wiki')">Toggle</button>
                    </div>
                </div>

                <!-- CREATE TAB - Prompt Builder -->
                <div class="tab-content" id="create-tab">
                    <!-- Formula Cards Section -->
                    <div class="section formula-section">
                        <div class="section-title" onclick="toggleFormulaCards()" style="cursor:pointer;">
                            📋 Công thức gợi ý <span class="toggle-hint">(click để mở/đóng)</span>
                            <span id="formulaToggleIcon" style="float:right;">▼</span>
                        </div>
                        <div id="formulaCards" class="formula-cards" style="display:none;">
                            <!-- Stock Photography Recipes -->
                            <div class="recipe-category">
                                <div class="recipe-category-title">📷 Stock Photography</div>
                                <div class="recipe-grid">
                                    <div class="recipe-card" onclick="applyRecipe('business')">
                                        <div class="recipe-name">💼 Business/Corporate</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Stock - Business</span>
                                            <span class="recipe-tag">Window Light</span>
                                            <span class="recipe-tag">Medium Shot</span>
                                            <span class="recipe-tag">Professional</span>
                                            <span class="recipe-tag">Cool Tones</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('lifestyle')">
                                        <div class="recipe-name">🏡 Lifestyle</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Stock - Lifestyle</span>
                                            <span class="recipe-tag">Golden Hour</span>
                                            <span class="recipe-tag">Wide Shot</span>
                                            <span class="recipe-tag">Authentic</span>
                                            <span class="recipe-tag">Warm Tones</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('food')">
                                        <div class="recipe-name">🍽️ Food</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Stock - Food</span>
                                            <span class="recipe-tag">Window Light</span>
                                            <span class="recipe-tag">Overhead Flat Lay</span>
                                            <span class="recipe-tag">Playful</span>
                                            <span class="recipe-tag">Warm Tones</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('product')">
                                        <div class="recipe-name">📦 Product</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Stock - Product</span>
                                            <span class="recipe-tag">High-Key</span>
                                            <span class="recipe-tag">Close-up</span>
                                            <span class="recipe-tag">Minimalist</span>
                                            <span class="recipe-tag">Monochromatic</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vector/Illustration Recipes -->
                            <div class="recipe-category">
                                <div class="recipe-category-title">🎨 Vector/Illustration</div>
                                <div class="recipe-grid">
                                    <div class="recipe-card" onclick="applyRecipe('vector-corporate')">
                                        <div class="recipe-name">🏢 Corporate Flat</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Vector - Corporate</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Isometric</span>
                                            <span class="recipe-tag">Professional</span>
                                            <span class="recipe-tag">Cool Tones</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('vector-icon')">
                                        <div class="recipe-name">🎯 Icons/UI</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Vector - Icons</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Minimalist</span>
                                            <span class="recipe-tag">Monochromatic</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('vector-mascot')">
                                        <div class="recipe-name">🦊 Mascot</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Vector - Character</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Portrait</span>
                                            <span class="recipe-tag">Playful</span>
                                            <span class="recipe-tag">Vibrant</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('vector-pattern')">
                                        <div class="recipe-name">🌸 Pattern</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Vector - Pattern</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Bold</span>
                                            <span class="recipe-tag">Pastel</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Backgrounds Recipes -->
                            <div class="recipe-category">
                                <div class="recipe-category-title">🖼️ Backgrounds</div>
                                <div class="recipe-grid">
                                    <div class="recipe-card" onclick="applyRecipe('bg-gradient')">
                                        <div class="recipe-name">🌈 Gradient Abstract</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">BG - Gradient</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Dreamy</span>
                                            <span class="recipe-tag">Pastel</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('bg-tech')">
                                        <div class="recipe-name">🌃 Tech/Cyber</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">BG - Tech</span>
                                            <span class="recipe-tag">Neon</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Mysterious</span>
                                            <span class="recipe-tag">Neon</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('bg-nature')">
                                        <div class="recipe-name">🌿 Nature Blur</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">BG - Nature Blur</span>
                                            <span class="recipe-tag">Golden Hour</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Serene</span>
                                            <span class="recipe-tag">Earth Tones</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('bg-studio')">
                                        <div class="recipe-name">⬜ Studio Clean</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">BG - Studio</span>
                                            <span class="recipe-tag">High-Key</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Minimalist</span>
                                            <span class="recipe-tag">Monochromatic</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trending 2025-2026 -->
                            <div class="recipe-category">
                                <div class="recipe-category-title">🔥 Xu hướng 2025-2026</div>
                                <div class="recipe-grid">
                                    <div class="recipe-card" onclick="applyRecipe('trend-authentic')">
                                        <div class="recipe-name">📸 Authentic Human</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Trend - Authentic</span>
                                            <span class="recipe-tag">Natural</span>
                                            <span class="recipe-tag">Rule of Thirds</span>
                                            <span class="recipe-tag">Authentic</span>
                                            <span class="recipe-tag">Muted</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('trend-hyperreal')">
                                        <div class="recipe-name">✨ Hyperreal AI</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Trend - Hyperreal</span>
                                            <span class="recipe-tag">Cinematic</span>
                                            <span class="recipe-tag">Close-up</span>
                                            <span class="recipe-tag">Dreamy</span>
                                            <span class="recipe-tag">Vibrant</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('trend-y2k')">
                                        <div class="recipe-name">💿 Y2K Revival</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Trend - Y2K</span>
                                            <span class="recipe-tag">Neon</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Nostalgic</span>
                                            <span class="recipe-tag">Neon</span>
                                        </div>
                                    </div>
                                    <div class="recipe-card" onclick="applyRecipe('trend-mixed')">
                                        <div class="recipe-name">🎭 Mixed Media</div>
                                        <div class="recipe-items">
                                            <span class="recipe-tag">Trend - Mixed</span>
                                            <span class="recipe-tag">Dramatic</span>
                                            <span class="recipe-tag">N/A</span>
                                            <span class="recipe-tag">Bold</span>
                                            <span class="recipe-tag">Complementary</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="formula-legend">
                                <strong>Công thức:</strong>
                                <span class="legend-item">Style</span> +
                                <span class="legend-item">Ánh sáng</span> +
                                <span class="legend-item">Góc máy</span> +
                                <span class="legend-item">Mood</span> +
                                <span class="legend-item">Màu sắc</span>
                                <br><small>💡 Click vào công thức để tự động điền!</small>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎨 Prompt Builder</div>
                        <div class="prompt-builder">
                            <!-- Sub-tabs Navigation -->
                            <div class="sub-tabs-nav">
                                <button class="sub-tab-btn active" onclick="switchCreateSubTab('basic')">🎨
                                    Basic</button>
                                <button class="sub-tab-btn" onclick="switchCreateSubTab('advanced')">⚙️
                                    Advanced</button>
                                <button class="sub-tab-btn" onclick="switchCreateSubTab('templates')">📋
                                    Templates</button>
                            </div>

                            <!-- BASIC TAB -->
                            <div id="subTabBasic" class="sub-tab-content active">
                                <div class="pb-row">
                                    <label class="pb-label">1. Chủ thể *</label>
                                    <div class="pb-input-group">
                                        <input type="text" id="pbSubject" class="pb-input"
                                            placeholder="Ví dụ: A young woman with red hair"
                                            oninput="updateFinalPrompt()">
                                        <button type="button" class="ai-assist-btn" onclick="aiAssistFill()"
                                            title="AI gợi ý tự động">
                                            🤖 AI
                                        </button>
                                        <button type="button" class="copy-style-btn" onclick="openCopyStyleModal()"
                                            title="Copy Style từ Ảnh/Prompt">
                                            🎨 Style
                                        </button>
                                    </div>
                                </div>
                                <!-- AI Intent Field (New) -->
                                <div class="pb-row">
                                    <label class="pb-label">✨ Ý tưởng & Mục đích (Giúp AI tối ưu hóa)</label>
                                    <textarea id="pbIntent" class="pb-textarea" rows="2"
                                        placeholder="Ví dụ: Làm thumbnail YouTube cho video du lịch, cần màu sắc rực rỡ và khoảng trống bên phải để chèn chữ..."></textarea>
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">2. Style</label>
                                    <select id="pbStyle" class="pb-select" onchange="updateFinalPrompt()">
                                        <option value="">-- Chọn style --</option>
                                        <optgroup label="📷 Stock Photography">
                                            <option
                                                value="stock photography, authentic lifestyle, natural lighting, diverse subjects, commercial use, editorial quality, candid moment, genuine emotion">
                                                📷 Stock - Lifestyle</option>
                                            <option
                                                value="corporate stock photography, professional business setting, modern office, diverse team collaboration, clean composition, commercial license">
                                                📷 Stock - Business/Corporate</option>
                                            <option
                                                value="food photography, appetizing presentation, overhead flat lay, natural lighting, fresh ingredients, culinary art, food magazine style">
                                                📷 Stock - Food</option>
                                            <option
                                                value="product photography, clean white background, studio lighting, commercial quality, e-commerce ready, sharp focus, professional">
                                                📷 Stock - Product</option>
                                            <option
                                                value="travel stock photography, destination scenery, wanderlust, vibrant colors, tourism, adventure, landscape, cultural">
                                                📷 Stock - Travel</option>
                                            <option
                                                value="technology stock, modern devices, startup environment, digital workspace, screens and gadgets, clean tech aesthetic">
                                                📷 Stock - Technology</option>
                                            <option
                                                value="healthcare stock photography, medical professionals, patient care, hospital setting, clinical, compassionate, clean">
                                                📷 Stock - Healthcare</option>
                                        </optgroup>
                                        <optgroup label="🎨 Vector/Flat Design">
                                            <option
                                                value="flat vector illustration, clean geometric shapes, bold colors, minimalist design, 2D, scalable, consistent line weight, print-ready">
                                                🎨 Vector - Flat Design</option>
                                            <option
                                                value="isometric vector illustration, 3D-like perspective, clean geometry, modern infographic style, technical precision, soft shadows">
                                                🎨 Vector - Isometric</option>
                                            <option
                                                value="line art illustration, clean outlines, minimal detail, elegant simplicity, single weight stroke, modern graphic design">
                                                🎨 Vector - Line Art</option>
                                            <option
                                                value="icon design, flat vector icons, consistent style, UI/UX ready, simple shapes, scalable SVG, professional iconography">
                                                🎨 Vector - Icons/UI</option>
                                            <option
                                                value="corporate flat illustration, business concept, professional color palette, simplified human figures, presentation ready, brand-safe">
                                                🎨 Vector - Corporate</option>
                                            <option
                                                value="character illustration, cartoon style, mascot design, friendly expression, vibrant colors, scalable vector">
                                                🎨 Vector - Character/Mascot</option>
                                            <option
                                                value="seamless pattern design, repeating tile, textile print, geometric or floral, vector pattern, surface design">
                                                🎨 Vector - Pattern/Seamless</option>
                                        </optgroup>
                                        <optgroup label="🖼️ Backgrounds">
                                            <option
                                                value="soft gradient background, smooth color transition, abstract, minimalist, suitable for text overlay, clean design">
                                                🖼️ BG - Gradient</option>
                                            <option
                                                value="marble texture background, elegant stone surface, white and gray veins, luxurious, high-resolution, product backdrop">
                                                🖼️ BG - Marble/Texture</option>
                                            <option
                                                value="blurred nature background, soft bokeh, green foliage, out of focus, dreamy atmosphere, natural light">
                                                🖼️ BG - Nature Blur</option>
                                            <option
                                                value="studio backdrop, clean solid color, professional photography background, seamless, shadow gradient">
                                                🖼️ BG - Studio/Solid</option>
                                            <option
                                                value="futuristic tech background, neon lights, cyber grid, dark atmosphere, sci-fi aesthetic, digital matrix">
                                                🖼️ BG - Tech/Futuristic</option>
                                            <option
                                                value="abstract geometric background, modern shapes, overlapping forms, bold colors, dynamic composition, contemporary art">
                                                🖼️ BG - Geometric Abstract</option>
                                            <option
                                                value="watercolor wash background, soft bleeds, artistic texture, pastel tones, paper texture, hand-painted feel">
                                                🖼️ BG - Watercolor Wash</option>
                                        </optgroup>
                                        <optgroup label="🔥 Trending 2025-2026">
                                            <option
                                                value="authentic human storytelling, genuine emotion, candid documentary style, diverse representation, real moments, unposed, natural imperfections">
                                                🔥 Trend - Authentic Human</option>
                                            <option
                                                value="hyperreal AI photography, surreal details, impossible perfection combined with reality, dreamlike quality, cutting-edge visual">
                                                🔥 Trend - Hyperreal AI</option>
                                            <option
                                                value="neo-traditionalism, hand-drawn aesthetic, organic lines, visible brush strokes, imperfect by design, tactile texture, post-AI authenticity">
                                                🔥 Trend - Neo-Traditional</option>
                                            <option
                                                value="mixed media collage, layered textures, scanned materials, digital meets analog, experimental composition, artistic fusion">
                                                🔥 Trend - Mixed Media</option>
                                            <option
                                                value="maximalist psychedelia, hyper-colorful, intricate patterns, 70s retrofuturism, bold and vibrant, surreal dreamscape">
                                                🔥 Trend - Maximalist</option>
                                            <option
                                                value="Y2K aesthetic, early 2000s nostalgia, chrome effects, bubble fonts, digital glitch, retro-futuristic">
                                                🔥 Trend - Y2K Revival</option>
                                            <option
                                                value="3D meets flat design, dimensional vector, volumetric shapes with 2D elements, modern hybrid style">
                                                🔥 Trend - 3D + Flat</option>
                                        </optgroup>
                                        <optgroup label="📸 Photorealistic">
                                            <option
                                                value="photorealistic, 8K UHD, ultra-detailed, DSLR quality, shot on Canon EOS R5, 85mm f/1.4 lens, shallow depth of field, natural bokeh, detailed skin texture, visible pores">
                                                📷 Photo - Chân dung</option>
                                            <option
                                                value="street photography, candid shot, natural lighting, urban environment, 35mm film, slight grain, authentic moment, shallow depth of field">
                                                📷 Photo - Đường phố</option>
                                            <option
                                                value="product photography, studio lighting, clean background, commercial quality, sharp focus, professional, 4K, ultra-detailed texture">
                                                📷 Photo - Sản phẩm</option>
                                            <option
                                                value="landscape photography, golden hour, dramatic sky, wide angle lens, 16K resolution, HDR, vibrant colors, sharp details from foreground to background">
                                                📷 Photo - Phong cảnh</option>
                                            <option
                                                value="photorealistic, hyper-realistic, 8K, shot on medium format camera, natural imperfections, film grain, authentic lighting, no AI artifacts, no plastic skin">
                                                📷 Photo - Như thật</option>
                                        </optgroup>
                                        <optgroup label="🎨 General">
                                            <option value="digital art">Digital Art</option>
                                            <option value="oil painting">Oil Painting</option>
                                            <option value="watercolor">Watercolor</option>
                                            <option value="anime style">Anime</option>
                                            <option value="cyberpunk style">Cyberpunk</option>
                                            <option value="fantasy art">Fantasy</option>
                                            <option value="minimalist">Minimalist</option>
                                            <option value="3D render">3D Render</option>
                                            <option value="Studio Ghibli style">Studio Ghibli</option>
                                        </optgroup>
                                        <optgroup label="🦕 Paleoart">
                                            <option
                                                value="scientific paleoart, anatomically accurate, feathered dinosaur, natural colors, museum quality illustration">
                                                Paleoart - Khoa học</option>
                                            <option
                                                value="fantasy paleoart, mythical prehistoric creature, dramatic, epic scale">
                                                Paleoart - Giả tưởng</option>
                                            <option
                                                value="dinosaur art, detailed scales and feathers, Mesozoic era, lush prehistoric jungle">
                                                Paleoart - Khủng long</option>
                                            <option
                                                value="marine reptile paleoart, plesiosaur, ichthyosaur, ancient ocean, underwater scene">
                                                Paleoart - Bò sát biển</option>
                                            <option
                                                value="prehistoric mammal art, Ice Age, mammoth, saber-tooth, megafauna, tundra landscape">
                                                Paleoart - Động vật có vú</option>
                                            <option
                                                value="ecological paleoart, ancient ecosystem, prehistoric environment, flora and fauna coexisting">
                                                Paleoart - Hệ sinh thái</option>
                                            <option
                                                value="fossil reconstruction art, skeletal anatomy, museum display, scientific diagram">
                                                Paleoart - Hóa thạch</option>
                                            <option
                                                value="concept art, prehistoric creature design, game asset, detailed texture">
                                                Paleoart - Concept Art</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            <!-- END BASIC TAB -->

                            <!-- ADVANCED TAB -->
                            <div id="subTabAdvanced" class="sub-tab-content">
                                <div class="pb-row">
                                    <label class="pb-label">3. Chi tiết</label>
                                    <input type="text" id="pbDetails" class="pb-input"
                                        placeholder="Ví dụ: wearing vintage dress, smiling, green eyes"
                                        oninput="updateFinalPrompt()">
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">4. Bối cảnh</label>
                                    <input type="text" id="pbSetting" class="pb-input"
                                        placeholder="Ví dụ: in a mystical forest with glowing mushrooms"
                                        oninput="updateFinalPrompt()">
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">5. Ánh sáng</label>
                                    <select id="pbLighting" class="pb-select" onchange="updateFinalPrompt()">
                                        <option value="">-- Chọn ánh sáng --</option>
                                        <optgroup label="🌞 Natural">
                                            <option value="natural lighting, soft daylight">Natural Daylight</option>
                                            <option value="golden hour lighting, warm sun">Golden Hour</option>
                                            <option value="soft window light, indirect sunlight">Window Light</option>
                                            <option value="overcast lighting, soft diffused, no harsh shadows">
                                                Overcast/Cloudy
                                            </option>
                                            <option value="blue hour lighting, twilight, cool tones">Blue Hour</option>
                                        </optgroup>
                                        <optgroup label="🎬 Studio/Professional">
                                            <option value="professional studio lighting, three-point setup">Studio
                                                3-Point
                                            </option>
                                            <option value="high-key lighting, bright, minimal shadows, clean">High-Key
                                                (Bright)
                                            </option>
                                            <option value="low-key lighting, dramatic shadows, moody">Low-Key
                                                (Dark/Moody)
                                            </option>
                                            <option value="ring light, beauty lighting, even illumination">Ring Light
                                            </option>
                                            <option value="softbox lighting, diffused, professional portrait">Softbox
                                            </option>
                                            <option value="product lighting, clean, commercial quality">Product Lighting
                                            </option>
                                        </optgroup>
                                        <optgroup label="✨ Creative/Dramatic">
                                            <option value="dramatic lighting, strong contrast">Dramatic</option>
                                            <option value="backlit, rim lighting, silhouette edge">Backlit/Rim</option>
                                            <option value="neon lights, colorful glow, cyberpunk">Neon</option>
                                            <option value="cinematic lighting, movie quality, depth">Cinematic</option>
                                            <option value="chiaroscuro, Renaissance lighting, strong shadow">Chiaroscuro
                                            </option>
                                            <option value="volumetric lighting, god rays, atmospheric">Volumetric/God
                                                Rays
                                            </option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">6. Góc máy</label>
                                    <select id="pbComposition" class="pb-select" onchange="updateFinalPrompt()">
                                        <option value="">-- Chọn góc máy --</option>
                                        <optgroup label="📐 Standard">
                                            <option value="close-up portrait, face detail">Close-up</option>
                                            <option value="medium shot, waist up">Medium Shot</option>
                                            <option value="wide shot, full body, environment">Wide Shot</option>
                                            <option value="portrait composition, centered subject">Portrait/Centered
                                            </option>
                                            <option value="extreme close-up, macro detail">Macro/Extreme Close-up
                                            </option>
                                        </optgroup>
                                        <optgroup label="🎥 Angles">
                                            <option value="bird's eye view, top-down, aerial">Bird's Eye (Top-Down)
                                            </option>
                                            <option value="overhead flat lay, product arrangement">Overhead Flat Lay
                                            </option>
                                            <option value="low angle shot, heroic perspective">Low Angle</option>
                                            <option value="high angle shot, looking down">High Angle</option>
                                            <option value="dutch angle, tilted frame, dynamic">Dutch Angle (Tilted)
                                            </option>
                                            <option value="point of view, first person, POV">POV (First Person)</option>
                                        </optgroup>
                                        <optgroup label="🖼️ Composition">
                                            <option value="symmetrical composition, balanced">Symmetrical</option>
                                            <option value="rule of thirds, off-center subject">Rule of Thirds</option>
                                            <option value="isometric view, 3D-like angle, vector style">Isometric
                                            </option>
                                            <option value="negative space, minimalist composition">Negative Space
                                            </option>
                                            <option value="leading lines, depth perspective">Leading Lines</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">7. Tỷ lệ khung hình</label>
                                    <select id="pbAspectRatio" class="pb-select" onchange="updateFinalPrompt()">
                                        <option value="">-- Chọn tỷ lệ --</option>
                                        <option value="1:1 square format">1:1 (Vuông)</option>
                                        <option value="9:16 vertical portrait format">9:16 (Dọc - Story/Reels)</option>
                                        <option value="16:9 horizontal landscape format">16:9 (Ngang - Video)</option>
                                        <option value="3:4 portrait format">3:4 (Dọc - Instagram)</option>
                                        <option value="4:3 landscape format">4:3 (Ngang - Ảnh cổ điển)</option>
                                        <option value="3:2 classic photo format">3:2 (DSLR - Film)</option>
                                    </select>
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">8. Mood/Không khí</label>
                                    <select id="pbMood" class="pb-select" onchange="updateFinalPrompt()">
                                        <option value="">-- Chọn mood --</option>
                                        <option value="professional, corporate, clean, business-appropriate">💼
                                            Professional/Corporate</option>
                                        <option value="authentic, candid, genuine emotion, real moment">📷
                                            Authentic/Candid
                                        </option>
                                        <option value="dreamy, ethereal, soft focus, romantic">✨ Dreamy/Ethereal
                                        </option>
                                        <option value="bold, vibrant, energetic, dynamic">⚡ Bold/Vibrant</option>
                                        <option value="minimalist, clean, simple, uncluttered">🔲 Minimalist/Clean
                                        </option>
                                        <option value="nostalgic, vintage, retro, film grain">📼 Nostalgic/Vintage
                                        </option>
                                        <option value="luxury, premium, elegant, high-end">💎 Luxury/Premium</option>
                                        <option value="playful, fun, cheerful, colorful">🎉 Playful/Fun</option>
                                        <option value="mysterious, moody, dark, atmospheric">🌙 Mysterious/Moody
                                        </option>
                                        <option value="serene, peaceful, calm, tranquil">🧘 Serene/Peaceful</option>
                                    </select>
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">9. Bảng màu</label>
                                    <select id="pbColorPalette" class="pb-select" onchange="updateFinalPrompt()">
                                        <option value="">-- Chọn bảng màu --</option>
                                        <option value="warm color palette, golden tones, amber, orange">🌅 Warm Tones
                                        </option>
                                        <option value="cool color palette, blue tones, teal, cyan">❄️ Cool/Blue Tones
                                        </option>
                                        <option value="pastel colors, soft muted tones, gentle">🎀 Pastel</option>
                                        <option value="vibrant saturated colors, bold, vivid">🌈 Vibrant/Saturated
                                        </option>
                                        <option value="monochromatic, single color scheme, variations">⬛ Monochromatic
                                        </option>
                                        <option value="earth tones, natural colors, brown, green, beige">🌿 Earth Tones
                                        </option>
                                        <option value="black and white, grayscale, high contrast">🖤 Black & White
                                        </option>
                                        <option value="neon colors, cyberpunk palette, electric">💜 Neon/Electric
                                        </option>
                                        <option value="muted desaturated colors, film look, cinematic">🎬
                                            Muted/Cinematic
                                        </option>
                                        <option value="complementary colors, color contrast, dynamic">🎨 Complementary
                                        </option>
                                    </select>
                                </div>
                                <div class="pb-row">
                                    <label class="pb-label">10. Loại bỏ (Negative Prompt)</label>
                                    <div class="negative-prompt-grid">
                                        <label class="neg-checkbox"><input type="checkbox" id="negText"
                                                onchange="updateFinalPrompt()"> 🚫 No text/watermark</label>
                                        <label class="neg-checkbox"><input type="checkbox" id="negBlur"
                                                onchange="updateFinalPrompt()"> 🚫 No blur/artifacts</label>
                                        <label class="neg-checkbox"><input type="checkbox" id="negFingers"
                                                onchange="updateFinalPrompt()"> 🚫 No extra fingers</label>
                                        <label class="neg-checkbox"><input type="checkbox" id="negPlastic"
                                                onchange="updateFinalPrompt()"> 🚫 No plastic skin</label>
                                        <label class="neg-checkbox"><input type="checkbox" id="negDeformed"
                                                onchange="updateFinalPrompt()"> 🚫 No deformed faces</label>
                                        <label class="neg-checkbox"><input type="checkbox" id="negLowQuality"
                                                onchange="updateFinalPrompt()"> 🚫 No low quality</label>
                                    </div>
                                </div>
                            </div>
                            <!-- END ADVANCED TAB -->

                            <!-- TEMPLATES TAB -->
                            <div id="subTabTemplates" class="sub-tab-content">
                                <p style="padding: 12px; background: #f0f4ff; border-radius: 8px; margin-bottom: 16px;">
                                    💡 <strong>Tip:</strong> Click vào công thức bên dưới để tự động điền các thông số!
                                </p>
                                <!-- Formula Cards will be displayed here via the existing section -->
                            </div>
                            <!-- END TEMPLATES TAB -->
                        </div>

                        <div class="section">
                            <div class="section-title">📝 Prompt cuối cùng</div>
                            <div class="final-prompt-box">
                                <textarea id="finalPrompt" class="final-prompt" readonly
                                    placeholder="Prompt sẽ tự động tạo khi bạn điền thông tin..."></textarea>
                                <button class="copy-prompt-btn" onclick="copyFinalPrompt()">📋 Copy</button>
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-title">🌍 Chọn AI</div>
                            <span class="ai-section-label">🌐 International</span>
                            <div class="ai-icon-grid" id="aiIconGrid">
                                <button type="button" class="ai-icon-btn selected" data-ai="chatgpt-dalle"
                                    title="DALL-E 3 (ChatGPT)" onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=chat.openai.com&sz=32"
                                        alt="DALL-E"></button>
                                <button type="button" class="ai-icon-btn" data-ai="midjourney" title="Midjourney"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=midjourney.com&sz=32"
                                        alt="MJ"></button>
                                <button type="button" class="ai-icon-btn" data-ai="flux" title="Flux AI"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=blackforestlabs.ai&sz=32"
                                        alt="Flux"></button>
                                <button type="button" class="ai-icon-btn" data-ai="ideogram" title="Ideogram"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=ideogram.ai&sz=32"
                                        alt="Ideogram"></button>
                                <button type="button" class="ai-icon-btn" data-ai="leonardo" title="Leonardo AI"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=leonardo.ai&sz=32"
                                        alt="Leonardo"></button>
                                <button type="button" class="ai-icon-btn" data-ai="firefly" title="Adobe Firefly"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=firefly.adobe.com&sz=32"
                                        alt="Firefly"></button>
                                <button type="button" class="ai-icon-btn selected" data-ai="gemini-image"
                                    title="Google Gemini" onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=gemini.google.com&sz=32"
                                        alt="Gemini"></button>
                                <button type="button" class="ai-icon-btn" data-ai="stable-diffusion"
                                    title="Stable Diffusion" onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=stability.ai&sz=32"
                                        alt="SD"></button>
                                <button type="button" class="ai-icon-btn" data-ai="aistudio" title="Google AI Studio"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=aistudio.google.com&sz=32"
                                        alt="AI Studio"></button>
                                <button type="button" class="ai-icon-btn" data-ai="kittl" title="Kittl"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=kittl.com&sz=32"
                                        alt="Kittl"></button>
                                <button type="button" class="ai-icon-btn" data-ai="recraft" title="Recraft"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=recraft.ai&sz=32"
                                        alt="Recraft"></button>
                                <button type="button" class="ai-icon-btn" data-ai="reve" title="Reve Image"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=reve.art&sz=32"
                                        alt="Reve"></button>
                                <button type="button" class="ai-icon-btn" data-ai="freepik-ai" title="Freepik AI"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=freepik.com&sz=32"
                                        alt="Freepik"></button>
                            </div>
                            <span class="ai-section-label" style="margin-top: 12px;">🇨🇳 Trung Quốc</span>
                            <div class="ai-icon-grid">
                                <button type="button" class="ai-icon-btn" data-ai="keling" title="Keling AI"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=klingai.com&sz=32"
                                        alt="Keling"></button>
                                <button type="button" class="ai-icon-btn" data-ai="jimeng" title="Jimeng AI"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=jimeng.jianying.com&sz=32"
                                        alt="Jimeng"></button>
                                <button type="button" class="ai-icon-btn" data-ai="doubao-image" title="Doubao"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=doubao.com&sz=32"
                                        alt="Doubao"></button>
                                <button type="button" class="ai-icon-btn" data-ai="tongyi" title="Tongyi Wanxiang"
                                    onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=tongyi.aliyun.com&sz=32"
                                        alt="Tongyi"></button>
                                <button type="button" class="ai-icon-btn" data-ai="ernie-vilg"
                                    title="ERNIE-ViLG (Baidu)" onclick="toggleAiIcon(this)"><img
                                        src="https://www.google.com/s2/favicons?domain=yiyan.baidu.com&sz=32"
                                        alt="ERNIE"></button>
                            </div>
                        </div>

                        <div class="actions">
                            <button class="btn-search" id="createImageBtn" onclick="generateAIImage()">🚀 Tạo ảnh<span
                                    class="count" id="createCount">1</span></button>
                        </div>
                    </div>

                </div> <!-- End create-tab -->

                <!-- REVERSE IMAGE SEARCH TAB -->
                <div class="tab-content" id="reverse-tab">
                    <!-- Upload Section -->
                    <div class="upload-section" id="uploadSection">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="imageFile" accept="image/*" style="display: none;">
                            <div class="upload-icon">📤</div>
                            <div class="upload-text">
                                <strong>Kéo thả ảnh vào đây</strong>
                                <span>hoặc click để chọn file</span>
                            </div>
                            <div class="upload-formats">PNG, JPG, GIF, WEBP (max 32MB)</div>
                        </div>
                        <div class="upload-or">hoặc</div>
                        <div class="paste-area">
                            <input type="text" id="imageUrlInput" class="url-input"
                                placeholder="Paste URL ảnh vào đây...">
                        </div>
                        <div class="upload-preview" id="uploadPreview" style="display: none;">
                            <img id="previewImg" src="">
                            <button class="remove-preview" onclick="removePreview()">✕</button>
                        </div>
                        <div class="upload-status" id="uploadStatus"></div>
                        <div class="url-result" id="urlResult" style="display: none;">
                            <input type="text" id="resultUrl" class="result-url-input" readonly>
                            <button class="copy-url-btn" onclick="copyUrl()">📋 Copy</button>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🔥 Top Reverse Search <span class="badge ai">BEST</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="tineye"><span
                                    class="platform-label"><span class="platform-icon">👁️</span>TinEye</span></label>
                            <label class="platform"><input type="checkbox" data-p="yandexreverse"><span
                                    class="platform-label"><span class="platform-icon">🔴</span>Yandex</span></label>
                            <label class="platform"><input type="checkbox" data-p="googlereverse"><span
                                    class="platform-label"><span class="platform-icon">🔍</span>Google
                                    Lens</span></label>
                            <label class="platform"><input type="checkbox" data-p="bingreverse"><span
                                    class="platform-label"><span class="platform-icon">🔷</span>Bing
                                    Visual</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🤖 AI-Powered <span class="badge ai">AI</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="lenso"><span
                                    class="platform-label"><span class="platform-icon">🔎</span>Lenso.ai</span></label>
                            <label class="platform"><input type="checkbox" data-p="copyseeker"><span
                                    class="platform-label"><span
                                        class="platform-icon">📋</span>CopySeeker</span></label>
                            <label class="platform"><input type="checkbox" data-p="pimeyes"><span
                                    class="platform-label"><span class="platform-icon">👤</span>PimEyes</span></label>
                            <label class="platform"><input type="checkbox" data-p="reversely"><span
                                    class="platform-label"><span class="platform-icon">🔄</span>Reversely</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🛠️ Aggregators</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="imgops"><span
                                    class="platform-label"><span class="platform-icon">⚙️</span>ImgOps</span></label>
                            <label class="platform"><input type="checkbox" data-p="duplichecker"><span
                                    class="platform-label"><span
                                        class="platform-icon">🔗</span>Duplichecker</span></label>
                            <label class="platform"><input type="checkbox" data-p="smallseotools"><span
                                    class="platform-label"><span class="platform-icon">🔧</span>SmallSEO</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎌 Anime / Manga</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="saucenao"><span
                                    class="platform-label"><span class="platform-icon">🍜</span>SauceNAO</span></label>
                            <label class="platform"><input type="checkbox" data-p="iqdb"><span
                                    class="platform-label"><span class="platform-icon">🎨</span>IQDB</span></label>
                            <label class="platform"><input type="checkbox" data-p="trace"><span
                                    class="platform-label"><span class="platform-icon">📺</span>trace.moe</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 China 以图搜图 <span class="badge hot">HOT</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="baidureverse"><span
                                    class="platform-label"><span class="platform-icon">🔵</span>百度识图</span></label>
                            <label class="platform"><input type="checkbox" data-p="sogouimage"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>搜狗识图</span></label>
                            <label class="platform"><input type="checkbox" data-p="360reverse"><span
                                    class="platform-label"><span class="platform-icon">🟢</span>360识图</span></label>
                            <label class="platform"><input type="checkbox" data-p="taobaoimage"><span
                                    class="platform-label"><span class="platform-icon">🛒</span>拍立淘</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="reverseSearchBtn">Open Tools<span class="count"
                                id="reverseCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('reverse')">Toggle</button>
                    </div>
                </div>

                <!-- DISCOVER TAB -->
                <div class="tab-content" id="discover-tab">
                    <div class="section">
                        <div class="section-title">📚 Mega Directories <span class="badge hot">HOT</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="fmhy"><span
                                    class="platform-label"><span class="platform-icon">⭐</span>FMHY</span></label>
                            <label class="platform"><input type="checkbox" data-p="rippedguide"><span
                                    class="platform-label"><span
                                        class="platform-icon">📖</span>ripped.guide</span></label>
                            <label class="platform"><input type="checkbox" data-p="wotaku"><span
                                    class="platform-label"><span class="platform-icon">🎌</span>Wotaku</span></label>
                            <label class="platform"><input type="checkbox" data-p="theindex"><span
                                    class="platform-label"><span class="platform-icon">📑</span>TheIndex</span></label>
                            <label class="platform"><input type="checkbox" data-p="alternativeto"><span
                                    class="platform-label"><span
                                        class="platform-icon">🔄</span>AlternativeTo</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🔥 Content Discovery</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="producthunt"><span
                                    class="platform-label"><span class="platform-icon">🚀</span>Product
                                    Hunt</span></label>
                            <label class="platform"><input type="checkbox" data-p="mixcom"><span
                                    class="platform-label"><span class="platform-icon">🎲</span>Mix.com</span></label>
                            <label class="platform"><input type="checkbox" data-p="flipboard"><span
                                    class="platform-label"><span class="platform-icon">📰</span>Flipboard</span></label>
                            <label class="platform"><input type="checkbox" data-p="digg"><span
                                    class="platform-label"><span class="platform-icon">📊</span>Digg</span></label>
                            <label class="platform"><input type="checkbox" data-p="feedly"><span
                                    class="platform-label"><span class="platform-icon">📡</span>Feedly</span></label>
                            <label class="platform"><input type="checkbox" data-p="hackernews"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>Hacker
                                    News</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎯 Random Discovery</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="discuvver"><span
                                    class="platform-label"><span class="platform-icon">🎰</span>Discuvver</span></label>
                            <label class="platform"><input type="checkbox" data-p="cloudhiker"><span
                                    class="platform-label"><span
                                        class="platform-icon">☁️</span>CloudHiker</span></label>
                            <label class="platform"><input type="checkbox" data-p="boredbutton"><span
                                    class="platform-label"><span class="platform-icon">🔘</span>Bored
                                    Button</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🤖 AI Tool Directories</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="futurepedia"><span
                                    class="platform-label"><span
                                        class="platform-icon">🔮</span>Futurepedia</span></label>
                            <label class="platform"><input type="checkbox" data-p="toolify"><span
                                    class="platform-label"><span
                                        class="platform-icon">🛠️</span>Toolify.ai</span></label>
                            <label class="platform"><input type="checkbox" data-p="theresanai"><span
                                    class="platform-label"><span class="platform-icon">✨</span>There's An
                                    AI</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎨 Design Inspiration</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="awwwards"><span
                                    class="platform-label"><span class="platform-icon">🏆</span>Awwwards</span></label>
                            <label class="platform"><input type="checkbox" data-p="godlywebsite"><span
                                    class="platform-label"><span class="platform-icon">✨</span>Godly</span></label>
                            <label class="platform"><input type="checkbox" data-p="lapaninja"><span
                                    class="platform-label"><span class="platform-icon">🥷</span>Lapa
                                    Ninja</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📚 Encyclopedia - Global <span class="badge hot">TOP</span></div>
                        <div class="section-desc">Wikipedia: 62M+ bài • Britannica: Uy tín nhất từ 1768</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="wikipedia"><span
                                    class="platform-label"><span class="platform-icon">🌐</span>Wikipedia</span></label>
                            <label class="platform"><input type="checkbox" data-p="britannica"><span
                                    class="platform-label"><span
                                        class="platform-icon">📘</span>Britannica</span></label>
                            <label class="platform"><input type="checkbox" data-p="scholarpedia"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎓</span>Scholarpedia</span></label>
                            <label class="platform"><input type="checkbox" data-p="encyclopedia"><span
                                    class="platform-label"><span
                                        class="platform-icon">📖</span>Encyclopedia.com</span></label>
                            <label class="platform"><input type="checkbox" data-p="stanfordphil"><span
                                    class="platform-label"><span class="platform-icon">🏛️</span>Stanford
                                    Phil.</span></label>
                            <label class="platform"><input type="checkbox" data-p="handwiki"><span
                                    class="platform-label"><span class="platform-icon">✋</span>HandWiki</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 Encyclopedia - China <span class="badge">28M+</span></div>
                        <div class="section-desc">百度百科: 28.6 triệu bài • 知乎: 220M users</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="baidubaike"><span
                                    class="platform-label"><span class="platform-icon">📙</span>百度百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="zhihu"><span
                                    class="platform-label"><span class="platform-icon">🔵</span>知乎</span></label>
                            <label class="platform"><input type="checkbox" data-p="sogoubaike"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>搜狗百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="360baike"><span
                                    class="platform-label"><span class="platform-icon">🟢</span>360百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="kuaidong"><span
                                    class="platform-label"><span class="platform-icon">📱</span>快懂百科</span></label>
                            <label class="platform"><input type="checkbox" data-p="zgbk"><span
                                    class="platform-label"><span class="platform-icon">🏛️</span>中国大百科</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇷🇺 Encyclopedia - Russia <span class="badge">NEW 2024</span>
                        </div>
                        <div class="section-desc">Рувики: 2M+ bài, AI YandexGPT • Кругосвет: Bộ GD khuyên dùng</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="ruwiki"><span
                                    class="platform-label"><span class="platform-icon">📕</span>Рувики</span></label>
                            <label class="platform"><input type="checkbox" data-p="ruwikipedia"><span
                                    class="platform-label"><span class="platform-icon">🌐</span>Русская
                                    Вики</span></label>
                            <label class="platform"><input type="checkbox" data-p="krugosvet"><span
                                    class="platform-label"><span class="platform-icon">🌍</span>Кругосвет</span></label>
                            <label class="platform"><input type="checkbox" data-p="akademik"><span
                                    class="platform-label"><span class="platform-icon">📚</span>Академик</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 China Navigation</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="hao123"><span
                                    class="platform-label"><span class="platform-icon">🏠</span>hao123</span></label>
                            <label class="platform"><input type="checkbox" data-p="360nav"><span
                                    class="platform-label"><span class="platform-icon">🌐</span>360导航</span></label>
                            <label class="platform"><input type="checkbox" data-p="265nav"><span
                                    class="platform-label"><span class="platform-icon">📱</span>265导航</span></label>
                            <label class="platform"><input type="checkbox" data-p="360ai"><span
                                    class="platform-label"><span class="platform-icon">🤖</span>360AI导航</span></label>
                            <label class="platform"><input type="checkbox" data-p="uisdc"><span
                                    class="platform-label"><span class="platform-icon">🎨</span>优设导航</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇷🇺 Russia</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="yandexru"><span
                                    class="platform-label"><span class="platform-icon">🔴</span>Yandex</span></label>
                            <label class="platform"><input type="checkbox" data-p="dzen"><span
                                    class="platform-label"><span class="platform-icon">📰</span>Dzen</span></label>
                            <label class="platform"><input type="checkbox" data-p="vk"><span
                                    class="platform-label"><span class="platform-icon">💬</span>VK</span></label>
                            <label class="platform"><input type="checkbox" data-p="2gis"><span
                                    class="platform-label"><span class="platform-icon">🗺️</span>2GIS</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="discoverSearchBtn">Open<span class="count"
                                id="discoverCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('discover')">Toggle</button>
                    </div>
                </div>

                <!-- VISION TAB -->
                <div class="tab-content" id="vision-tab">
                    <div class="section">
                        <div class="section-title">📸 Image Description <span class="badge hot">HOT</span></div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="chatgptvision"><span
                                    class="platform-label"><span class="platform-icon">💬</span>ChatGPT
                                    Vision</span></label>
                            <label class="platform"><input type="checkbox" data-p="geminivision"><span
                                    class="platform-label"><span class="platform-icon">💎</span>Gemini
                                    Vision</span></label>
                            <label class="platform"><input type="checkbox" data-p="claudevision"><span
                                    class="platform-label"><span class="platform-icon">🟠</span>Claude
                                    Vision</span></label>
                            <label class="platform"><input type="checkbox" data-p="llava"><span
                                    class="platform-label"><span class="platform-icon">🦙</span>LLaVA
                                    (Free)</span></label>
                            <label class="platform"><input type="checkbox" data-p="huggingfacecaption"><span
                                    class="platform-label"><span
                                        class="platform-icon">🤗</span>HuggingFace</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎬 Video Storyboard - Global</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="storyboardhero"><span
                                    class="platform-label"><span
                                        class="platform-icon">🎬</span>StoryboardHero</span></label>
                            <label class="platform"><input type="checkbox" data-p="adobefirefly"><span
                                    class="platform-label"><span class="platform-icon">🔥</span>Adobe
                                    Firefly</span></label>
                            <label class="platform"><input type="checkbox" data-p="ltxstudio"><span
                                    class="platform-label"><span class="platform-icon">🎥</span>LTX
                                    Studio</span></label>
                            <label class="platform"><input type="checkbox" data-p="boords"><span
                                    class="platform-label"><span class="platform-icon">📋</span>Boords</span></label>
                            <label class="platform"><input type="checkbox" data-p="katalist"><span
                                    class="platform-label"><span class="platform-icon">🎯</span>Katalist
                                    AI</span></label>
                            <label class="platform"><input type="checkbox" data-p="higgsfield"><span
                                    class="platform-label"><span
                                        class="platform-icon">🍿</span>Higgsfield</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🇨🇳 China Vision AI</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="qwenvl"><span
                                    class="platform-label"><span class="platform-icon">☁️</span>通义千问VL</span></label>
                            <label class="platform"><input type="checkbox" data-p="glm4v"><span
                                    class="platform-label"><span class="platform-icon">🎯</span>智谱GLM-4V</span></label>
                            <label class="platform"><input type="checkbox" data-p="doubaovision"><span
                                    class="platform-label"><span class="platform-icon">🎁</span>豆包Vision</span></label>
                            <label class="platform"><input type="checkbox" data-p="deepseekv"><span
                                    class="platform-label"><span
                                        class="platform-icon">🔬</span>DeepSeek-VL</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">🎞️ China Storyboard</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="kemengai"><span
                                    class="platform-label"><span class="platform-icon">🎭</span>可梦AI</span></label>
                            <label class="platform"><input type="checkbox" data-p="senseseko"><span
                                    class="platform-label"><span class="platform-icon">🤖</span>Seko
                                    2.0</span></label>
                            <label class="platform"><input type="checkbox" data-p="yiyuanai"><span
                                    class="platform-label"><span class="platform-icon">📹</span>易元AI</span></label>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">📝 Video Caption</div>
                        <div class="platforms">
                            <label class="platform"><input type="checkbox" data-p="submagic"><span
                                    class="platform-label"><span class="platform-icon">✨</span>Submagic</span></label>
                            <label class="platform"><input type="checkbox" data-p="captionsai"><span
                                    class="platform-label"><span
                                        class="platform-icon">💬</span>Captions.ai</span></label>
                            <label class="platform"><input type="checkbox" data-p="veedio"><span
                                    class="platform-label"><span class="platform-icon">🎬</span>VEED.io</span></label>
                            <label class="platform"><input type="checkbox" data-p="vmakerai"><span
                                    class="platform-label"><span class="platform-icon">🆓</span>Vmaker
                                    (Free)</span></label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-search" id="visionSearchBtn">Open<span class="count"
                                id="visionCount">0</span></button>
                        <button class="btn-select" onclick="toggleAll('vision')">Toggle</button>
                    </div>
                </div>

                <!-- MY TOOL TAB -->
                <div class="tab-content" id="mytool-tab">
                    <div class="section">
                        <div class="section-title">🧰 Công cụ của tôi</div>
                        <div class="section-desc">Lưu và quản lý các trang web công cụ yêu thích</div>

                        <div class="mytool-add-form" id="mytoolForm">
                            <input type="text" id="mytoolName" class="mytool-input"
                                placeholder="Tên công cụ (VD: Video to Prompt)">
                            <input type="url" id="mytoolUrl" class="mytool-input"
                                placeholder="URL (VD: https://example.com)">
                            <input type="text" id="mytoolIcon" class="mytool-input mytool-icon-input"
                                placeholder="Icon emoji (VD: 🎬)" maxlength="4">
                            <div class="mytool-form-btns">
                                <button class="btn-add-tool" onclick="addMyTool()">➕ Thêm mới</button>
                                <button class="btn-cancel-tool" id="btnCancelEdit" onclick="cancelEditTool()"
                                    style="display:none;">❌ Hủy</button>
                            </div>
                        </div>

                        <div class="mytool-search">
                            <input type="text" id="mytoolSearch" class="mytool-search-input"
                                placeholder="🔍 Tìm công cụ..." oninput="filterMyTools(this.value)">
                        </div>

                        <div class="mytool-list" id="mytoolList">
                            <div class="mytool-empty">Chưa có công cụ nào. Thêm công cụ mới ở trên! 👆</div>
                        </div>
                    </div>
                </div>

                <!-- PROMPT MANAGER TAB -->
                <div class="tab-content" id="prompt-tab">
                    <div class="section">
                        <div class="section-title">📝 Prompt Manager</div>
                        <div class="section-desc">Lưu và quản lý prompt AI với category, tags và biến {{variable}}
                        </div>

                        <div class="prompt-add-form" id="promptForm">
                            <textarea id="promptContent" class="prompt-textarea"
                                placeholder="Nội dung prompt... Dùng {{biến}} để tạo template&#10;VD: Viết bài về {{topic}} với giọng văn {{tone}}"
                                rows="4"></textarea>
                            <div class="prompt-form-row">
                                <select id="promptCategory" class="prompt-select">
                                    <option value="">-- Chọn Category --</option>
                                    <option value="Writing">✍️ Writing</option>
                                    <option value="Coding">💻 Coding</option>
                                    <option value="Marketing">📢 Marketing</option>
                                    <option value="Image">🎨 Image</option>
                                    <option value="Video">🎬 Video</option>
                                    <option value="Business">💼 Business</option>
                                    <option value="Education">📚 Education</option>
                                    <option value="Other">📋 Other</option>
                                </select>
                                <input type="text" id="promptTags" class="prompt-input"
                                    placeholder="Tags (phân cách bằng dấu phẩy)">
                            </div>
                            <div class="prompt-form-row">
                                <select id="promptWorkflow" class="prompt-select" onchange="onWorkflowSelectChange()"
                                    onfocus="updateWorkflowFormDropdown()">
                                    <option value="">-- Không thuộc Workflow --</option>
                                    <option value="__new__">➕ Tạo Workflow mới...</option>
                                </select>
                                <input type="text" id="promptWorkflowNew" class="prompt-input"
                                    placeholder="Tên workflow mới" style="display:none;">
                            </div>
                            <textarea id="promptNote" class="prompt-textarea prompt-note"
                                placeholder="Ghi chú / Ví dụ output (tùy chọn)" rows="2"></textarea>
                            <div class="prompt-form-btns">
                                <button class="btn-add-prompt" onclick="addPrompt()">➕ Lưu Prompt</button>
                                <button class="btn-cancel-prompt" id="btnCancelPromptEdit" onclick="cancelEditPrompt()"
                                    style="display:none;">❌ Hủy</button>
                            </div>
                        </div>

                        <div class="prompt-filters">
                            <input type="text" id="promptSearch" class="prompt-search-input"
                                placeholder="🔍 Tìm prompt..." oninput="filterPrompts()">
                            <select id="promptCategoryFilter" class="prompt-filter-select" onchange="filterPrompts()">
                                <option value="">Tất cả Category</option>
                                <option value="Writing">✍️ Writing</option>
                                <option value="Coding">💻 Coding</option>
                                <option value="Marketing">📢 Marketing</option>
                                <option value="Image">🎨 Image</option>
                                <option value="Video">🎬 Video</option>
                                <option value="Business">💼 Business</option>
                                <option value="Education">📚 Education</option>
                                <option value="Other">📋 Other</option>
                            </select>
                            <select id="promptWorkflowFilter" class="prompt-filter-select" onchange="filterPrompts()">
                                <option value="">🔄 Tất cả Workflow</option>
                            </select>
                            <button class="btn-copy-workflow" id="btnCopyWorkflow" onclick="copyWorkflowSteps()"
                                style="display:none;">
                                📋 Copy All Steps
                            </button>
                            <span class="prompt-count" id="promptCount">0 prompts</span>
                        </div>

                        <div class="prompt-list" id="promptList">
                            <div class="prompt-empty">Chưa có prompt nào. Thêm prompt mới ở trên! 👆</div>
                        </div>
                    </div>
                </div>

                <!-- KNOWLEDGE BASE TAB -->
                <div class="tab-content" id="knowledge-tab">
                    <div class="section">
                        <div class="section-title">📚 Scriptwriting Knowledge Base</div>
                        <div class="section-desc">Tài liệu hướng dẫn viết kịch bản YouTube với AI - Click để xem chi
                            tiết,
                            copy
                            nhanh để dùng</div>

                        <!-- Quick Filter Buttons -->
                        <div class="kb-filter-bar">
                            <button class="kb-filter-btn active" onclick="filterGuides('all')">📚 Tất cả</button>
                            <button class="kb-filter-btn" onclick="filterGuides('shorts')">🎬 Shorts</button>
                            <button class="kb-filter-btn" onclick="filterGuides('longform')">📺 Long-form</button>
                            <button class="kb-filter-btn" onclick="filterGuides('workflow')">🔄 Workflow</button>
                            <button class="kb-filter-btn" onclick="filterGuides('tools')">🛠️ Tools</button>
                        </div>

                        <!-- Guide Cards Grid -->
                        <div class="kb-cards" id="kbCards">
                            <!-- Card 1: YouTube Shorts Guide -->
                            <div class="kb-card" data-category="shorts" onclick="openGuideModal('shorts')">
                                <div class="kb-card-icon">🎬</div>
                                <div class="kb-card-content">
                                    <h3>YouTube Shorts Scriptwriting</h3>
                                    <p>Hướng dẫn viết kịch bản YouTube Shorts viral với hook mạnh, cấu trúc H-B-C-L
                                    </p>
                                    <div class="kb-card-tags">
                                        <span>Hook</span><span>60s</span><span>Retention</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn" onclick="event.stopPropagation(); copyGuide('shorts')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>

                            <!-- Card 2: Long-form Guide -->
                            <div class="kb-card" data-category="longform" onclick="openGuideModal('longform')">
                                <div class="kb-card-icon">📺</div>
                                <div class="kb-card-content">
                                    <h3>YouTube Long-form Scriptwriting</h3>
                                    <p>Hướng dẫn viết kịch bản video dài 10-30 phút với cấu trúc H-I-C-C-C</p>
                                    <div class="kb-card-tags">
                                        <span>Re-hooks</span><span>10-30min</span><span>Retention</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn" onclick="event.stopPropagation(); copyGuide('longform')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>

                            <!-- Card 3: Workflow -->
                            <div class="kb-card" data-category="workflow" onclick="openGuideModal('workflow')">
                                <div class="kb-card-icon">🔄</div>
                                <div class="kb-card-content">
                                    <h3>AI Scriptwriting Workflow</h3>
                                    <p>Quy trình 4 phases từ Foundation đến Finalize với prompts chi tiết</p>
                                    <div class="kb-card-tags">
                                        <span>4 Phases</span><span>Prompts</span><span>Step-by-step</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn" onclick="event.stopPropagation(); copyGuide('workflow')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>

                            <!-- Card 4: Evaluator -->
                            <div class="kb-card" data-category="tools" onclick="openGuideModal('evaluator')">
                                <div class="kb-card-icon">🤖</div>
                                <div class="kb-card-content">
                                    <h3>AI Script Evaluator System</h3>
                                    <p>Hệ thống đánh giá script 100 điểm với rubric chi tiết và prompts</p>
                                    <div class="kb-card-tags">
                                        <span>100 điểm</span><span>Rubric</span><span>Before/After</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn"
                                        onclick="event.stopPropagation(); copyGuide('evaluator')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>

                            <!-- Card 5: Douyin Guide -->
                            <div class="kb-card" data-category="shorts" onclick="openGuideModal('douyin')">
                                <div class="kb-card-icon">🇨🇳</div>
                                <div class="kb-card-content">
                                    <h3>Douyin → YouTube Shorts</h3>
                                    <p>Quy trình 7 bước chuyển đổi video Douyin thành YouTube Shorts VN</p>
                                    <div class="kb-card-tags">
                                        <span>Localize</span><span>Adapt</span><span>7 Steps</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn" onclick="event.stopPropagation(); copyGuide('douyin')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>

                            <!-- Card 6: Claude Techniques -->
                            <div class="kb-card" data-category="tools" onclick="openGuideModal('claude')">
                                <div class="kb-card-icon">🎭</div>
                                <div class="kb-card-content">
                                    <h3>Claude Natural Writing</h3>
                                    <p>Kỹ thuật để Claude viết script tự nhiên, không giọng robot AI</p>
                                    <div class="kb-card-tags">
                                        <span>Prompts</span><span>Natural</span><span>Anti-AI</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn" onclick="event.stopPropagation(); copyGuide('claude')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>

                            <!-- Card 7: Create Assistant -->
                            <div class="kb-card" data-category="tools" onclick="openGuideModal('assistant')">
                                <div class="kb-card-icon">🛠️</div>
                                <div class="kb-card-content">
                                    <h3>Tạo AI Script Assistant</h3>
                                    <p>5 phương pháp tạo AI assistant: Custom GPT, Claude, Gemini, API</p>
                                    <div class="kb-card-tags">
                                        <span>GPT</span><span>Claude</span><span>Gemini</span>
                                    </div>
                                </div>
                                <div class="kb-card-actions">
                                    <button class="kb-copy-btn"
                                        onclick="event.stopPropagation(); copyGuide('assistant')"
                                        title="Copy toàn bộ">📋</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guide Modal -->
                <div id="guideModal" class="guide-modal-overlay" onclick="if(event.target===this)closeGuideModal()">
                    <div class="guide-modal">
                        <div class="guide-modal-header">
                            <h2 id="guideModalTitle">Guide Title</h2>
                            <div class="guide-modal-actions">
                                <button class="guide-copy-all-btn" onclick="copyCurrentGuide()">📋 Copy toàn
                                    bộ</button>
                                <button class="guide-close-btn" onclick="closeGuideModal()">✕</button>
                            </div>
                        </div>
                        <div class="guide-modal-body markdown-body" id="guideModalContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="section" style="margin-top: 2rem;">
                    <div class="section-title">Recent</div>
                    <div class="history" id="historyList"><span class="empty">No recent</span></div>
                </div>
        </div>

        <!-- Scroll to Top FAB -->
        <button class="scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()">↑</button>

        <!-- Batch Warning Modal -->
        <div class="modal-overlay" id="batchModal">
            <div class="modal-box">
                <div class="modal-icon">⚠️</div>
                <div class="modal-title" id="modalTitle">Mở nhiều tab</div>
                <div class="modal-text" id="modalText">Bạn đang mở <span id="tabCount">0</span> trang cùng lúc.
                    Trình
                    duyệt
                    có thể chặn popup.</div>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="closeBatchModal()" id="btnCancel">Hủy</button>
                    <button class="modal-btn confirm" onclick="confirmBatchOpen()" id="btnConfirm">Tiếp
                        tục</button>
                </div>
            </div>
        </div>

        <!-- Add Custom Site Modal -->
        <div class="modal-overlay add-site-modal" id="addSiteModal">
            <div class="modal-box">
                <div class="modal-icon">➕</div>
                <div class="modal-title" id="addSiteTitle">Thêm trang web</div>
                <form id="addSiteForm" onsubmit="return submitCustomSite(event)">
                    <div class="form-group">
                        <label>Tên hiển thị *</label>
                        <input type="text" id="customSiteName" placeholder="Ví dụ: My Site" required>
                    </div>
                    <div class="form-group">
                        <label>URL trang chủ *</label>
                        <input type="url" id="customSiteUrl" placeholder="https://example.com" required>
                    </div>
                    <div class="form-group">
                        <label>URL tìm kiếm (tuỳ chọn)</label>
                        <input type="text" id="customSiteSearch" placeholder="https://example.com/search?q={query}">
                        <div class="hint">Dùng {query} làm placeholder cho từ khoá</div>
                    </div>
                    <div class="form-group">
                        <div class="hint">💡 Icon sẽ được tự động lấy từ website</div>
                    </div>
                    <input type="hidden" id="customSiteTab" value="">
                    <div class="modal-btns">
                        <button type="button" class="modal-btn cancel" onclick="closeAddSiteModal()">Hủy</button>
                        <button type="submit" class="modal-btn confirm">Thêm</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Platform Context Menu -->
        <div class="platform-context-menu" id="platformContextMenu">
            <div class="context-menu-item" onclick="editPlatformHomepage()">
                <span>🏠</span> Chỉnh sửa Homepage
            </div>
            <div class="context-menu-item" onclick="openPlatformHomepage()">
                <span>🔗</span> Mở trang chủ
            </div>
            <div class="context-menu-item" onclick="resetPlatformHomepage()">
                <span>🔄</span> Đặt lại mặc định
            </div>
        </div>

        <!-- Edit Homepage Modal -->
        <div class="modal-overlay" id="editHomepageModal">
            <div class="modal-box">
                <div class="modal-icon">🏠</div>
                <div class="modal-title">Chỉnh sửa Homepage</div>
                <div class="form-group">
                    <label>Tên platform: <strong id="editPlatformName"></strong></label>
                </div>
                <div class="form-group">
                    <label>Homepage URL *</label>
                    <input type="url" id="editHomepageUrl" placeholder="https://example.com" required>
                    <div class="hint">URL sẽ mở khi click vào platform mà không có từ khoá tìm kiếm</div>
                </div>
                <div class="modal-btns">
                    <button type="button" class="modal-btn cancel" onclick="closeEditHomepageModal()">Hủy</button>
                    <button type="button" class="modal-btn confirm" onclick="saveHomepageUrl()">Lưu</button>
                </div>
            </div>
        </div>

        <script>
            const VIDEO_URLS = {
                youtube: q => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
                tiktok: q => `https://www.tiktok.com/search?q=${encodeURIComponent(q)}`,
                instagram: q => `https://www.instagram.com/explore/tags/${encodeURIComponent(q.replace(/\s+/g, ''))}/`,
                facebook: q => `https://www.facebook.com/search/videos?q=${encodeURIComponent(q)}`,
                googlevideos: q => `https://www.google.com/search?q=${encodeURIComponent(q)}&tbm=vid`,
                douyin: q => `https://www.douyin.com/search/${encodeURIComponent(q)}`,
                bilibili: q => `https://search.bilibili.com/all?keyword=${encodeURIComponent(q)}`,
                kuaishou: q => `https://www.kuaishou.com/search/video?searchKey=${encodeURIComponent(q)}`,
                xiaohongshu: q => `https://www.xiaohongshu.com/search_result?keyword=${encodeURIComponent(q)}`,
                weibo: q => `https://s.weibo.com/video?q=${encodeURIComponent(q)}`,
                // Stock Free
                pexelsvideo: q => `https://www.pexels.com/search/videos/${encodeURIComponent(q)}/`,
                pixabayvideo: q => `https://pixabay.com/videos/search/${encodeURIComponent(q)}/`,
                coverr: q => `https://coverr.co/search?q=${encodeURIComponent(q)}`,
                videezy: q => `https://www.videezy.com/free-video/${encodeURIComponent(q)}`,
                lifeofvids: q => `https://lifeofvids.com/?s=${encodeURIComponent(q)}`,
                mazwai: q => `https://mazwai.com/search?q=${encodeURIComponent(q)}`,
                vidsplay: q => `https://www.vidsplay.com/?s=${encodeURIComponent(q)}`,
                // More Global
                vimeo: q => `https://vimeo.com/search?q=${encodeURIComponent(q)}`,
                dailymotion: q => `https://www.dailymotion.com/search/${encodeURIComponent(q)}`,
                twitch: q => `https://www.twitch.tv/search?term=${encodeURIComponent(q)}`,
                rumble: q => `https://rumble.com/search/video?q=${encodeURIComponent(q)}`,
                // More China
                youku: q => `https://so.youku.com/search_video/q_${encodeURIComponent(q)}`,
                iqiyi: q => `https://so.iqiyi.com/so/q_${encodeURIComponent(q)}`,
                tencentvideo: q => `https://v.qq.com/x/search/?q=${encodeURIComponent(q)}`,
                mangotv: q => `https://so.mgtv.com/so?k=${encodeURIComponent(q)}`,
                vecteezy: q => `https://www.vecteezy.com/free-videos/${encodeURIComponent(q)}`,
                dareful: q => `https://www.dareful.com/?s=${encodeURIComponent(q)}`
            };

            const IMAGE_URLS = {
                googleimages: q => `https://www.google.com/search?q=${encodeURIComponent(q)}&tbm=isch`,
                yandex: q => `https://yandex.com/images/search?text=${encodeURIComponent(q)}`,
                bingimages: q => `https://www.bing.com/images/search?q=${encodeURIComponent(q)}`,
                pinterest: q => `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(q)}`,
                tineye: q => `https://tineye.com/search?url=&query=${encodeURIComponent(q)}`,
                lenso: q => `https://lenso.ai/search?q=${encodeURIComponent(q)}`,
                unsplash: q => `https://unsplash.com/s/photos/${encodeURIComponent(q)}`,
                pexels: q => `https://www.pexels.com/search/${encodeURIComponent(q)}/`,
                pixabay: q => `https://pixabay.com/images/search/${encodeURIComponent(q)}/`,
                freepik: q => `https://www.freepik.com/search?format=search&query=${encodeURIComponent(q)}`,
                behance: q => `https://www.behance.net/search/projects?search=${encodeURIComponent(q)}`,
                dribbble: q => `https://dribbble.com/search/${encodeURIComponent(q)}`,
                artstation: q => `https://www.artstation.com/search?sort_by=relevance&query=${encodeURIComponent(q)}`,
                baidu: q => `https://image.baidu.com/search/index?tn=baiduimage&word=${encodeURIComponent(q)}`,
                sogou: q => `https://pic.sogou.com/pics?query=${encodeURIComponent(q)}`,
                huaban: q => `https://huaban.com/search?q=${encodeURIComponent(q)}`
            };

            // EBOOK SEARCH URLS
            const EBOOK_URLS = {
                // Mega Search (Top 3)
                annas: q => `https://annas-archive.org/search?q=${encodeURIComponent(q)}`,
                libgen: q => `https://libgen.is/search.php?req=${encodeURIComponent(q)}`,
                zlibrary: q => `https://z-lib.id/s/${encodeURIComponent(q)}`,

                // Search Engines
                pdfdrive: q => `https://www.pdfdrive.com/search?q=${encodeURIComponent(q)}`,
                oceanofpdf: q => `https://oceanofpdf.com/?s=${encodeURIComponent(q)}`,
                pdfbooksworld: q => `https://www.pdfbooksworld.com/search?query=${encodeURIComponent(q)}`,

                // Public Domain
                gutenberg: q => `https://www.gutenberg.org/ebooks/search/?query=${encodeURIComponent(q)}`,
                openlibrary: q => `https://openlibrary.org/search?q=${encodeURIComponent(q)}`,
                archive: q => `https://archive.org/search?query=${encodeURIComponent(q)}&and[]=mediatype%3A%22texts%22`,
                standardebooks: q => `https://standardebooks.org/ebooks?query=${encodeURIComponent(q)}`,

                // Indie & Free
                manybooks: q => `https://manybooks.net/search-book?search=${encodeURIComponent(q)}`,
                smashwords: q => `https://www.smashwords.com/books/search?query=${encodeURIComponent(q)}`,
                obooko: q => `https://www.obooko.com/search?query=${encodeURIComponent(q)}`,
                epubbooks: q => `https://www.epubbooks.com/?s=${encodeURIComponent(q)}`,

                // Academic
                bookboon: q => `https://bookboon.com/en/search?q=${encodeURIComponent(q)}`,
                googlebooks: q => `https://www.google.com/search?tbm=bks&q=${encodeURIComponent(q)}`
            };

            // MOVIE SEARCH URLS
            const MOVIE_URLS = {
                // Global Hot - Reddit recommended 2024
                hydrahd: q => `https://hydrahd.cc/search/${encodeURIComponent(q)}`,
                cineby: q => `https://cineby.app/search?q=${encodeURIComponent(q)}`,
                fmovies: q => `https://fmoviesz.to/search/${encodeURIComponent(q)}`,
                m4uhd: q => `https://m4uhd.tv/search/${encodeURIComponent(q)}.html`,
                movie456: q => `https://456movie.com/search/${encodeURIComponent(q)}`,
                sflix: q => `https://sflix.to/search/${encodeURIComponent(q)}`,
                flixhq: q => `https://flixhq.to/search/${encodeURIComponent(q)}`,
                soap2day: q => `https://www2.soap2day.tf/search/${encodeURIComponent(q)}`,

                // Legal Free Streaming
                tubi: q => `https://tubitv.com/search/${encodeURIComponent(q)}`,
                plextv: q => `https://watch.plex.tv/search?q=${encodeURIComponent(q)}`,
                plutotv: q => `https://pluto.tv/en/search/details/${encodeURIComponent(q)}`,
                rokuchannel: q => `https://therokuchannel.roku.com/search?q=${encodeURIComponent(q)}`,
                peacock: q => `https://www.peacocktv.com/watch/search?q=${encodeURIComponent(q)}`,
                freevee: q => `https://www.amazon.com/gp/video/search?phrase=${encodeURIComponent(q)}`,

                // Database & Reviews
                imdb: q => `https://www.imdb.com/find/?q=${encodeURIComponent(q)}`,
                letterboxd: q => `https://letterboxd.com/search/${encodeURIComponent(q)}/`,
                rottentomatoes: q => `https://www.rottentomatoes.com/search?search=${encodeURIComponent(q)}`,
                justwatch: q => `https://www.justwatch.com/us/search?q=${encodeURIComponent(q)}`,
                tmdb: q => `https://www.themoviedb.org/search?query=${encodeURIComponent(q)}`,

                // China - Hot 2024
                cupfox: q => `https://cupfox.app/search?key=${encodeURIComponent(q)}`,
                libvio: q => `https://www.libvio.cc/search/${encodeURIComponent(q)}.html`,
                iyf: q => `https://www.iyf.tv/search?q=${encodeURIComponent(q)}`,
                duonao: q => `https://www.duonaovod.com/search?wd=${encodeURIComponent(q)}`,
                duboku: q => `https://www.duboku.tv/vodsearch/-------------.html?wd=${encodeURIComponent(q)}`,
                cnys: q => `https://cnys.tv/vodsearch/-------------.html?wd=${encodeURIComponent(q)}`,
                olevod: q => `https://www.olevod.com/index.php/vod/search.html?wd=${encodeURIComponent(q)}`,
                nivod: q => `https://www.nivod.tv/search?keyword=${encodeURIComponent(q)}`,
                douban: q => `https://search.douban.com/movie/subject_search?search_text=${encodeURIComponent(q)}`,

                // Russia - Hot 2024
                hdrezka: q => `https://hdrezka.ag/search/?do=search&subaction=search&q=${encodeURIComponent(q)}`,
                kinopoisk: q => `https://www.kinopoisk.ru/s/type/all/find/${encodeURIComponent(q)}/`,
                ivi: q => `https://www.ivi.ru/search/?q=${encodeURIComponent(q)}`,
                okko: q => `https://okko.tv/search/${encodeURIComponent(q)}`,
                lordfilm: q => `https://lordfilm.gg/search/${encodeURIComponent(q)}`,
                kinogo: q => `https://kinogo.cc/search/${encodeURIComponent(q)}`,
                start: q => `https://start.ru/search?text=${encodeURIComponent(q)}`
            };

            // APK MOD SEARCH URLS
            const APK_URLS = {
                // PC Software - Torrent
                rutracker: q => `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(q)}`,
                '1337x': q => `https://1337x.to/search/${encodeURIComponent(q)}/1/`,
                fitgirl: q => `https://fitgirl-repacks.site/?s=${encodeURIComponent(q)}`,
                dodi: q => `https://dodi-repacks.site/?s=${encodeURIComponent(q)}`,
                steamrip: q => `https://steamrip.com/?s=${encodeURIComponent(q)}`,

                // Russia - PC Software
                rsload: q => `https://rsload.net/search/?q=${encodeURIComponent(q)}`,
                nnmclub: q => `https://nnmclub.to/forum/tracker.php?nm=${encodeURIComponent(q)}`,
                rutor: q => `https://rutor.info/search/0/0/000/0/${encodeURIComponent(q)}`,
                softportal: q => `https://www.softportal.com/search/?text=${encodeURIComponent(q)}`,

                // China - PC Software
                '52pojie': q => `https://www.52pojie.cn/search.php?searchsubmit=yes&srchtxt=${encodeURIComponent(q)}`,
                ghboke: q => `https://www.ghxi.com/?s=${encodeURIComponent(q)}`,
                '423down': q => `https://www.423down.com/?s=${encodeURIComponent(q)}`,
                iplaysoft: q => `https://www.iplaysoft.com/?s=${encodeURIComponent(q)}`,
                carrotchou: q => `https://www.carrotchou.blog/?s=${encodeURIComponent(q)}`,

                // Forum Uy Tín
                mobilism: q => `https://forum.mobilism.org/search.php?keywords=${encodeURIComponent(q)}&sr=topics&sf=titleonly`,
                platinmods: q => `https://platinmods.com/search/?q=${encodeURIComponent(q)}`,

                // Global Sites
                modyolo: q => `https://modyolo.com/?s=${encodeURIComponent(q)}`,
                liteapks: q => `https://liteapks.com/?s=${encodeURIComponent(q)}`,
                apkdone: q => `https://apkdone.com/?s=${encodeURIComponent(q)}`,
                happymod: q => `https://happymod.com/search.html?q=${encodeURIComponent(q)}`,
                an1: q => `https://an1.com/search/?q=${encodeURIComponent(q)}`,

                // Russia
                androeed: q => `https://androeed.ru/search/?q=${encodeURIComponent(q)}`,
                '5play': q => `https://5play.ru/en/search/?q=${encodeURIComponent(q)}`,

                // China
                huluxia: q => `https://www.huluxia.com/search?q=${encodeURIComponent(q)}`,
                coolapk: q => `https://www.coolapk.com/search?q=${encodeURIComponent(q)}`,
                ddooo: q => `https://www.ddooo.com/search?wd=${encodeURIComponent(q)}`,

                // APK Official
                apkpure: q => `https://apkpure.com/search?q=${encodeURIComponent(q)}`,
                apkmirror: q => `https://www.apkmirror.com/?s=${encodeURIComponent(q)}`,
                uptodown: q => `https://en.uptodown.com/android/search?q=${encodeURIComponent(q)}`
            };

            // SOFTWARE SEARCH URLS
            const SOFTWARE_URLS = {
                // Torrent Hot
                rutracker: q => `https://rutracker.org/forum/tracker.php?nm=${encodeURIComponent(q)}`,
                '1337x': q => `https://1337x.to/search/${encodeURIComponent(q)}/1/`,
                piratebay: q => `https://thepiratebay.org/search.php?q=${encodeURIComponent(q)}`,
                torrentgalaxy: q => `https://torrentgalaxy.to/torrents.php?search=${encodeURIComponent(q)}`,

                // Game PC Repacks
                fitgirl: q => `https://fitgirl-repacks.site/?s=${encodeURIComponent(q)}`,
                dodi: q => `https://dodi-repacks.site/?s=${encodeURIComponent(q)}`,
                steamrip: q => `https://steamrip.com/?s=${encodeURIComponent(q)}`,
                'gog-games': q => `https://gog-games.to/?s=${encodeURIComponent(q)}`,
                ovagames: q => `https://www.ovagames.com/?s=${encodeURIComponent(q)}`,

                // Russia - PC Software
                rsload: q => `https://rsload.net/search/?q=${encodeURIComponent(q)}`,
                nnmclub: q => `https://nnmclub.to/forum/tracker.php?nm=${encodeURIComponent(q)}`,
                rutor: q => `https://rutor.info/search/0/0/000/0/${encodeURIComponent(q)}`,
                softportal: q => `https://www.softportal.com/search/?text=${encodeURIComponent(q)}`,

                // China - PC Software
                '52pojie': q => `https://www.52pojie.cn/search.php?searchsubmit=yes&srchtxt=${encodeURIComponent(q)}`,
                ghboke: q => `https://www.ghxi.com/?s=${encodeURIComponent(q)}`,
                '423down': q => `https://www.423down.com/?s=${encodeURIComponent(q)}`,
                iplaysoft: q => `https://www.iplaysoft.com/?s=${encodeURIComponent(q)}`,
                carrotchou: q => `https://www.carrotchou.blog/?s=${encodeURIComponent(q)}`,
                masuit: q => `https://masuit.com/?s=${encodeURIComponent(q)}`,

                // Direct Download
                getintopc: q => `https://getintopc.com/?s=${encodeURIComponent(q)}`,
                filecr: q => `https://filecr.com/?s=${encodeURIComponent(q)}`,
                nsaneforums: q => `https://nsaneforums.com/search/?q=${encodeURIComponent(q)}`
            };

            // WIKI/ENCYCLOPEDIA SEARCH URLS
            const WIKI_URLS = {
                // Global
                wikipedia: q => `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(q)}`,
                britannica: q => `https://www.britannica.com/search?query=${encodeURIComponent(q)}`,
                scholarpedia: q => `http://www.scholarpedia.org/article/Special:Search?search=${encodeURIComponent(q)}`,
                encyclopedia: q => `https://www.encyclopedia.com/gsearch?q=${encodeURIComponent(q)}`,
                stanfordphil: q => `https://plato.stanford.edu/search/searcher.py?query=${encodeURIComponent(q)}`,
                handwiki: q => `https://handwiki.org/wiki/index.php?search=${encodeURIComponent(q)}`,

                // China
                baidubaike: q => `https://baike.baidu.com/search?word=${encodeURIComponent(q)}`,
                zhihu: q => `https://www.zhihu.com/search?type=content&q=${encodeURIComponent(q)}`,
                sogoubaike: q => `https://baike.sogou.com/Search.e?sp=${encodeURIComponent(q)}`,
                '360baike': q => `https://baike.so.com/search/?q=${encodeURIComponent(q)}`,
                kuaidong: q => `https://www.baike.com/search?keyword=${encodeURIComponent(q)}`,
                zgbk: q => `https://www.zgbk.com/ecph/words?SiteID=1&Name=${encodeURIComponent(q)}`,

                // Russia
                ruwiki: q => `https://ruwiki.ru/w/index.php?search=${encodeURIComponent(q)}`,
                ruwikipedia: q => `https://ru.wikipedia.org/wiki/Служебная:Поиск?search=${encodeURIComponent(q)}`,
                krugosvet: q => `https://www.krugosvet.ru/search/node/${encodeURIComponent(q)}`,
                akademik: q => `https://dic.academic.ru/searchall.php?SWord=${encodeURIComponent(q)}`
            };

            // HOMEPAGE URLs - for when no search query
            const HOMEPAGE_URLS = {
                // Video
                youtube: 'https://www.youtube.com',
                tiktok: 'https://www.tiktok.com',
                instagram: 'https://www.instagram.com/explore/',
                facebook: 'https://www.facebook.com/watch/',
                googlevideos: 'https://www.google.com/videohp',
                douyin: 'https://www.douyin.com',
                bilibili: 'https://www.bilibili.com',
                kuaishou: 'https://www.kuaishou.com',
                xiaohongshu: 'https://www.xiaohongshu.com',
                weibo: 'https://weibo.com',
                pexelsvideo: 'https://www.pexels.com/videos/',
                pixabayvideo: 'https://pixabay.com/videos/',
                coverr: 'https://coverr.co',
                videezy: 'https://www.videezy.com',
                lifeofvids: 'https://lifeofvids.com',
                mazwai: 'https://mazwai.com',
                vidsplay: 'https://www.vidsplay.com',
                vimeo: 'https://vimeo.com',
                dailymotion: 'https://www.dailymotion.com',
                twitch: 'https://www.twitch.tv',
                rumble: 'https://rumble.com',
                youku: 'https://www.youku.com',
                iqiyi: 'https://www.iqiyi.com',
                tencentvideo: 'https://v.qq.com',
                mangotv: 'https://www.mgtv.com',
                vecteezy: 'https://www.vecteezy.com/free-videos',
                dareful: 'https://www.dareful.com',

                // Image
                googleimages: 'https://images.google.com',
                yandex: 'https://yandex.com/images/',
                bingimages: 'https://www.bing.com/images',
                pinterest: 'https://www.pinterest.com',
                tineye: 'https://tineye.com',
                lenso: 'https://lenso.ai',
                unsplash: 'https://unsplash.com',
                pexels: 'https://www.pexels.com',
                pixabay: 'https://pixabay.com',
                freepik: 'https://www.freepik.com',
                behance: 'https://www.behance.net',
                dribbble: 'https://dribbble.com',
                artstation: 'https://www.artstation.com',
                baidu: 'https://image.baidu.com',
                sogou: 'https://pic.sogou.com',
                huaban: 'https://huaban.com',

                // Ebook
                annas: 'https://annas-archive.org',
                libgen: 'https://libgen.is',
                zlibrary: 'https://z-lib.id',
                pdfdrive: 'https://www.pdfdrive.com',
                oceanofpdf: 'https://oceanofpdf.com',
                gutenberg: 'https://www.gutenberg.org',
                openlibrary: 'https://openlibrary.org',
                standardebooks: 'https://standardebooks.org',
                manybooks: 'https://manybooks.net',
                smashwords: 'https://www.smashwords.com',
                obooko: 'https://www.obooko.com',
                epubbooks: 'https://www.epubbooks.com',
                bookboon: 'https://bookboon.com',
                googlebooks: 'https://books.google.com',

                // Movie - Global Hot
                hydrahd: 'https://hydrahd.cc',
                cineby: 'https://cineby.app',
                fmovies: 'https://fmoviesz.to',
                m4uhd: 'https://m4uhd.tv',
                movie456: 'https://456movie.com',
                sflix: 'https://sflix.to',
                flixhq: 'https://flixhq.to',
                soap2day: 'https://www2.soap2day.tf',
                // Movie - Legal Free
                tubi: 'https://tubitv.com',
                plextv: 'https://watch.plex.tv',
                plutotv: 'https://pluto.tv',
                rokuchannel: 'https://therokuchannel.roku.com',
                peacock: 'https://www.peacocktv.com',
                freevee: 'https://www.amazon.com/gp/video/storefront',
                // Movie - Database
                imdb: 'https://www.imdb.com',
                letterboxd: 'https://letterboxd.com',
                rottentomatoes: 'https://www.rottentomatoes.com',
                justwatch: 'https://www.justwatch.com',
                tmdb: 'https://www.themoviedb.org',
                // Movie - China
                cupfox: 'https://cupfox.app',
                libvio: 'https://www.libvio.cc',
                iyf: 'https://www.iyf.tv',
                duonao: 'https://www.duonaovod.com',
                duboku: 'https://www.duboku.tv',
                cnys: 'https://cnys.tv',
                olevod: 'https://www.olevod.com',
                nivod: 'https://www.nivod.tv',
                douban: 'https://movie.douban.com',
                // Movie - Russia
                hdrezka: 'https://hdrezka.ag',
                kinopoisk: 'https://www.kinopoisk.ru',
                ivi: 'https://www.ivi.ru',
                okko: 'https://okko.tv',
                lordfilm: 'https://lordfilm.gg',
                kinogo: 'https://kinogo.cc',
                start: 'https://start.ru',

                // PC Software - Torrent
                rutracker: 'https://rutracker.org',
                '1337x': 'https://1337x.to',
                fitgirl: 'https://fitgirl-repacks.site',
                dodi: 'https://dodi-repacks.site',
                steamrip: 'https://steamrip.com',
                // PC Software - Russia
                rsload: 'https://rsload.net',
                nnmclub: 'https://nnmclub.to',
                rutor: 'https://rutor.info',
                softportal: 'https://www.softportal.com',
                // PC Software - China
                '52pojie': 'https://www.52pojie.cn',
                ghboke: 'https://www.ghxi.com',
                '423down': 'https://www.423down.com',
                iplaysoft: 'https://www.iplaysoft.com',
                carrotchou: 'https://www.carrotchou.blog',
                // Software - Additional
                piratebay: 'https://thepiratebay.org',
                torrentgalaxy: 'https://torrentgalaxy.to',
                'gog-games': 'https://gog-games.to',
                ovagames: 'https://www.ovagames.com',
                masuit: 'https://masuit.com',
                getintopc: 'https://getintopc.com',
                filecr: 'https://filecr.com',
                nsaneforums: 'https://nsaneforums.com',

                // APK
                mobilism: 'https://forum.mobilism.org',
                platinmods: 'https://platinmods.com',
                modyolo: 'https://modyolo.com',
                liteapks: 'https://liteapks.com',
                apkdone: 'https://apkdone.com',
                happymod: 'https://happymod.com',
                an1: 'https://an1.com',
                androeed: 'https://androeed.ru',
                '5play': 'https://5play.ru',
                huluxia: 'https://www.huluxia.com',
                coolapk: 'https://www.coolapk.com',
                ddooo: 'https://www.ddooo.com',
                apkpure: 'https://apkpure.com',
                apkmirror: 'https://www.apkmirror.com',
                uptodown: 'https://en.uptodown.com/android',

                // Reverse
                tineye: 'https://tineye.com',
                yandexreverse: 'https://yandex.com/images/',
                googlereverse: 'https://images.google.com',
                bingreverse: 'https://www.bing.com/visualsearch',
                lenso: 'https://lenso.ai',
                copyseeker: 'https://copyseeker.net',
                pimeyes: 'https://pimeyes.com',
                reversely: 'https://reversely.ai',
                imgops: 'https://imgops.com',
                duplichecker: 'https://www.duplichecker.com/reverse-image-search.php',
                smallseotools: 'https://smallseotools.com/reverse-image-search/',
                saucenao: 'https://saucenao.com',
                iqdb: 'https://iqdb.org',
                trace: 'https://trace.moe',
                baidureverse: 'https://graph.baidu.com',
                sogouimage: 'https://pic.sogou.com',
                '360reverse': 'https://st.so.com',
                taobaoimage: 'https://s.taobao.com',

                // AI
                chatgpt: 'https://chat.openai.com',
                claude: 'https://claude.ai',
                gemini: 'https://gemini.google.com',
                perplexity: 'https://www.perplexity.ai',
                copilot: 'https://copilot.microsoft.com',
                grok: 'https://grok.x.ai',
                poe: 'https://poe.com',
                you: 'https://you.com',
                cursor: 'https://cursor.sh',
                replit: 'https://replit.com',
                codeium: 'https://codeium.com',
                phind: 'https://www.phind.com',
                ernie: 'https://yiyan.baidu.com',
                qianwen: 'https://tongyi.aliyun.com',
                kimi: 'https://kimi.moonshot.cn',
                doubao: 'https://www.doubao.com',
                deepseek: 'https://chat.deepseek.com',
                zhipu: 'https://chatglm.cn',
                midjourney: 'https://www.midjourney.com',
                dalle: 'https://openai.com/dall-e-3',
                ideogram: 'https://ideogram.ai',
                leonardo: 'https://leonardo.ai',

                // Discover - Mega Directories
                fmhy: 'https://fmhy.net',
                rippedguide: 'https://ripped.guide',
                wotaku: 'https://wotaku.wiki',
                theindex: 'https://theindex.moe',
                alternativeto: 'https://alternativeto.net',
                // Discover - Content Discovery
                producthunt: 'https://www.producthunt.com',
                mixcom: 'https://mix.com',
                flipboard: 'https://flipboard.com',
                digg: 'https://digg.com',
                feedly: 'https://feedly.com',
                hackernews: 'https://news.ycombinator.com',
                // Discover - Random
                discuvver: 'https://www.discuvver.com',
                cloudhiker: 'https://cloudhiker.net',
                boredbutton: 'https://www.boredbutton.com',
                // Discover - AI
                futurepedia: 'https://www.futurepedia.io',
                toolify: 'https://www.toolify.ai',
                theresanai: 'https://theresanaiforthat.com',
                // Discover - Design
                awwwards: 'https://www.awwwards.com',
                godlywebsite: 'https://godly.website',
                lapaninja: 'https://www.lapa.ninja',
                // Discover - China
                hao123: 'https://www.hao123.com',
                '360nav': 'https://hao.360.com',
                '265nav': 'https://www.265.com',
                '360ai': 'https://ai.360.com',
                uisdc: 'https://hao.uisdc.com',
                // Discover - Russia
                yandexru: 'https://yandex.ru',
                dzen: 'https://dzen.ru',
                vk: 'https://vk.com',
                '2gis': 'https://2gis.ru',
                // Encyclopedia - Global
                wikipedia: 'https://www.wikipedia.org',
                britannica: 'https://www.britannica.com',
                scholarpedia: 'http://www.scholarpedia.org',
                encyclopedia: 'https://www.encyclopedia.com',
                stanfordphil: 'https://plato.stanford.edu',
                handwiki: 'https://handwiki.org',
                // Encyclopedia - China
                baidubaike: 'https://baike.baidu.com',
                zhihu: 'https://www.zhihu.com',
                sogoubaike: 'https://baike.sogou.com',
                '360baike': 'https://baike.so.com',
                kuaidong: 'https://www.baike.com',
                zgbk: 'https://www.zgbk.com',
                // Encyclopedia - Russia
                ruwiki: 'https://ruwiki.ru',
                ruwikipedia: 'https://ru.wikipedia.org',
                krugosvet: 'https://www.krugosvet.ru',
                akademik: 'https://dic.academic.ru',

                // Vision - Image Description
                chatgptvision: 'https://chat.openai.com',
                geminivision: 'https://gemini.google.com',
                claudevision: 'https://claude.ai',
                llava: 'https://llava-vl.github.io',
                huggingfacecaption: 'https://huggingface.co/spaces/Salesforce/BLIP',
                // Vision - Video Storyboard Global
                storyboardhero: 'https://storyboardhero.ai',
                adobefirefly: 'https://firefly.adobe.com',
                ltxstudio: 'https://ltx.studio',
                boords: 'https://boords.com',
                katalist: 'https://katalist.ai',
                higgsfield: 'https://higgsfield.ai',
                // Vision - China
                qwenvl: 'https://tongyi.aliyun.com',
                glm4v: 'https://chatglm.cn',
                doubaovision: 'https://www.doubao.com',
                deepseekv: 'https://chat.deepseek.com',
                // Vision - China Storyboard
                kemengai: 'https://www.kemeng.com',
                senseseko: 'https://www.sensetime.com/seko',
                yiyuanai: 'https://yiyuanai.com',
                // Vision - Video Caption
                submagic: 'https://www.submagic.co',
                captionsai: 'https://www.captions.ai',
                veedio: 'https://www.veed.io',
                vmakerai: 'https://www.vmaker.com',


            };

            // REVERSE IMAGE SEARCH URLS - Direct upload pages
            const REVERSE_URLS = {
                // Top Reverse Search
                tineye: () => `https://tineye.com/`,
                yandexreverse: () => `https://yandex.com/images/`,
                googlereverse: () => `https://images.google.com/`,
                bingreverse: () => `https://www.bing.com/visualsearch`,

                // AI-Powered
                lenso: () => `https://lenso.ai/en`,
                copyseeker: () => `https://copyseeker.net/`,
                pimeyes: () => `https://pimeyes.com/en`,
                reversely: () => `https://reversely.ai/`,

                // Aggregators
                imgops: () => `https://imgops.com/`,
                duplichecker: () => `https://www.duplichecker.com/reverse-image-search.php`,
                smallseotools: () => `https://smallseotools.com/reverse-image-search/`,

                // Anime
                saucenao: () => `https://saucenao.com/`,
                iqdb: () => `https://iqdb.org/`,
                trace: () => `https://trace.moe/`,

                // China
                baidureverse: () => `https://graph.baidu.com/pcpage/index?tpl_from=pc`,
                sogouimage: () => `https://pic.sogou.com/ris`,
                '360reverse': () => `https://st.so.com/stu`,
                taobaoimage: () => `https://s.taobao.com/search?app=imgsearch`
            };

            let currentTab = 'video';
            let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${currentTab}-tab`).classList.add('active');
                });
            });

            // Analyze Script - Extract keywords (Pattern + AI)
            async function analyzeScript(type) {
                const textarea = document.getElementById(`${type}Script`);
                const script = textarea.value.trim();

                if (!script) {
                    toast('Nhập nội dung cần phân tích');
                    return;
                }

                const btn = document.getElementById('analyzeBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Đang phân tích...';

                try {
                    // 1. Run Pattern Analysis (instant)
                    const keywords = extractKeywords(script);
                    displaySuggestions(type, keywords, script);

                    // 2. Run AI Analysis (async, if enabled)
                    const apiKey = localStorage.getItem('geminiApiKey');
                    const enableAI = localStorage.getItem('enableAI') !== 'false';

                    if (apiKey && enableAI) {
                        // Show AI loading
                        const aiSection = document.getElementById('aiSuggestions');
                        const aiLoading = document.getElementById('aiLoading');
                        const aiContent = document.getElementById('aiSuggestionContent');

                        aiSection.style.display = 'block';
                        aiLoading.style.display = 'flex';
                        aiContent.innerHTML = '';

                        // Call AI
                        const aiResult = await analyzeWithAI(script);
                        aiLoading.style.display = 'none';

                        if (aiResult) {
                            displayAISuggestions(type, aiResult);
                        } else {
                            aiContent.innerHTML = '<p style="color:var(--text-light);font-size:0.7rem;">AI không phản hồi. Kiểm tra API key trong Settings.</p>';
                        }
                    }
                } catch (e) {
                    console.error(e);
                    toast('Lỗi phân tích');
                }

                btn.disabled = false;
                btn.innerHTML = '✨ Gợi ý từ khóa';
            }

            // Display AI Suggestions
            function displayAISuggestions(type, aiResult) {
                const content = document.getElementById('aiSuggestionContent');

                let html = `
                <div class="ai-section">
                    <div class="ai-section-title">🤖 AI gợi ý: ${escapeHtml(aiResult.topic || '')}</div>
                    ${aiResult.context ? `<p style="font-size:0.7rem;color:var(--text-light);margin-bottom:0.5rem;">${escapeHtml(aiResult.context)}</p>` : ''}
            `;

                const categories = [
                    { key: 'main', label: '🏗️ Dự án nổi bật', isMain: true },
                    { key: 'realProjects', label: '🌍 Công trình thực tế' },
                    { key: 'countrySpecific', label: '🗺️ Theo quốc gia' },
                    { key: 'official', label: '🏢 Nguồn chính thức' },
                    { key: 'broll', label: '🎬 B-roll footage' },
                    { key: 'trending', label: '🔥 Trending 2024-2025' }
                ];

                categories.forEach(cat => {
                    const kws = aiResult.keywords?.[cat.key] || [];
                    if (kws.length > 0) {
                        html += `
                        <div class="suggestion-group">
                            <div class="suggestion-label">${cat.label}</div>
                            <div class="suggestion-keywords">
                                ${kws.map(k => `<span class="keyword-chip ai${cat.isMain ? ' official' : ''}" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                            </div>
                        </div>
                    `;
                    }
                });

                html += '</div>';
                content.innerHTML = html;
            }

            // Extract keywords from script - Enhanced version with 50+ categories
            function extractKeywords(script) {
                const result = {
                    subjects: [],      // Chủ thể
                    locations: [],     // Địa điểm
                    events: [],        // Sự kiện, năm
                    technical: [],     // Từ khóa kỹ thuật
                    official: [],      // Nguồn chính thức
                    broll: [],         // B-roll keywords
                    emotions: []       // Cảm xúc, mood
                };

                const lowerScript = script.toLowerCase();

                // 1. EXTRACT PROPER NOUNS
                const engNouns = script.match(/[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*/g) || [];

                // Extract places
                const placePatterns = [
                    /(?:dự án|kênh đào|sông|hồ|núi|thành phố|tỉnh|quốc gia|nước|đập|cầu|tòa nhà)\s+([^\s,\.]+(?:\s+[^\s,\.]+){0,3})/gi,
                    /(?:tại|ở|thuộc)\s+([A-Za-zÀ-ỹ]+(?:\s+[A-Za-zÀ-ỹ]+){0,2})/gi
                ];

                placePatterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(script)) !== null) {
                        if (match[1] && match[1].length > 2) {
                            result.locations.push(match[1].trim());
                        }
                    }
                });

                // 2. EXTRACT YEARS AND NUMBERS
                const years = script.match(/\b(19|20)\d{2}\b/g) || [];
                const numbers = script.match(/\d+[,.]?\d*\s*(?:km|m|ha|hecta|triệu|tỷ|billion|million|người|hectare|MW|GW|%)/gi) || [];

                years.forEach(y => result.events.push(y));
                numbers.forEach(n => result.technical.push(n.trim()));

                // 3. EXPANDED TOPIC-BASED KEYWORD DICTIONARY (50+ categories)
                const topicKeywords = {
                    // === INFRASTRUCTURE ===
                    'kênh|canal': {
                        subjects: ['canal project', 'water canal'],
                        broll: ['canal construction', 'irrigation canal', 'water flow aerial', 'canal drone footage'],
                        technical: ['irrigation system', 'water management']
                    },
                    'đập|dam': {
                        subjects: ['hydroelectric dam', 'dam construction'],
                        broll: ['dam aerial view', 'water reservoir', 'hydropower station', 'dam spillway'],
                        technical: ['hydroelectric power', 'water storage']
                    },
                    'cầu|bridge': {
                        subjects: ['bridge construction', 'famous bridge'],
                        broll: ['bridge aerial', 'suspension bridge', 'bridge timelapse', 'cable-stayed bridge']
                    },
                    'đường cao tốc|highway|expressway': {
                        broll: ['highway aerial', 'traffic timelapse', 'road construction', 'freeway drone']
                    },
                    'sân bay|airport': {
                        broll: ['airport aerial', 'runway timelapse', 'airplane takeoff', 'terminal interior']
                    },
                    'metro|tàu điện|subway': {
                        broll: ['metro station', 'subway train', 'underground railway', 'metro construction']
                    },

                    // === TECHNOLOGY ===
                    'AI|artificial intelligence|trí tuệ nhân tạo': {
                        subjects: ['artificial intelligence', 'AI technology'],
                        broll: ['AI visualization', 'neural network', 'robot automation', 'machine learning', 'data center'],
                        emotions: ['futuristic', 'innovation']
                    },
                    'robot|tự động hóa|automation': {
                        broll: ['industrial robot', 'robot arm', 'factory automation', 'robotic assembly line']
                    },
                    'blockchain|crypto|bitcoin': {
                        broll: ['cryptocurrency visualization', 'blockchain animation', 'bitcoin mining', 'digital currency']
                    },
                    'điện thoại|smartphone|mobile': {
                        broll: ['smartphone usage', 'mobile app', 'phone screen', 'tech lifestyle']
                    },
                    'xe điện|electric vehicle|EV|tesla': {
                        subjects: ['electric vehicles', 'Tesla'],
                        broll: ['EV charging', 'electric car', 'Tesla factory', 'EV battery']
                    },
                    'năng lượng tái tạo|renewable energy|solar|wind': {
                        broll: ['solar farm aerial', 'wind turbines', 'renewable energy', 'green energy'],
                        technical: ['solar panel', 'wind power']
                    },
                    '5G|6G|network': {
                        broll: ['5G tower', 'network visualization', 'data transmission', 'telecommunication']
                    },
                    'vũ trụ|space|NASA|SpaceX|rocket': {
                        subjects: ['space exploration', 'SpaceX', 'NASA'],
                        broll: ['rocket launch', 'space station', 'satellite orbit', 'astronaut', 'Earth from space']
                    },

                    // === FAMOUS PEOPLE ===
                    'elon musk': {
                        subjects: ['Elon Musk interview', 'Elon Musk speech'],
                        broll: ['Tesla factory', 'SpaceX launch', 'Starlink satellite'],
                        official: ['Elon Musk Twitter', 'Tesla announcement']
                    },
                    'jeff bezos|amazon': {
                        subjects: ['Jeff Bezos', 'Amazon'],
                        broll: ['Amazon warehouse', 'Blue Origin', 'e-commerce logistics']
                    },
                    'bill gates|microsoft': {
                        subjects: ['Bill Gates interview', 'Microsoft'],
                        broll: ['tech conference', 'philanthropy', 'Gates Foundation']
                    },
                    'mark zuckerberg|meta|facebook': {
                        subjects: ['Mark Zuckerberg', 'Meta'],
                        broll: ['VR headset', 'metaverse', 'social media', 'Facebook headquarters']
                    },
                    'steve jobs|apple': {
                        subjects: ['Steve Jobs keynote', 'Apple'],
                        broll: ['iPhone reveal', 'Apple store', 'Silicon Valley']
                    },
                    'trump|biden|obama': {
                        subjects: ['US President', 'White House'],
                        broll: ['White House speech', 'political rally', 'press conference'],
                        official: ['presidential address', 'State of the Union']
                    },
                    'putin|russia': {
                        subjects: ['Putin speech', 'Russia'],
                        broll: ['Kremlin', 'Russian military', 'Moscow cityscape']
                    },
                    'xi jinping|china': {
                        subjects: ['Xi Jinping', 'China'],
                        broll: ['Beijing cityscape', 'Great Wall', 'Chinese technology']
                    },

                    // === HISTORICAL EVENTS ===
                    'chiến tranh|war|world war': {
                        broll: ['war footage', 'military operation', 'battlefield', 'soldiers marching'],
                        emotions: ['dramatic', 'historical']
                    },
                    'cách mạng|revolution': {
                        broll: ['protest crowd', 'revolution footage', 'historical archive']
                    },
                    'động đất|earthquake': {
                        broll: ['earthquake damage', 'rescue operation', 'collapsed building', 'seismic activity']
                    },
                    'sóng thần|tsunami': {
                        broll: ['tsunami wave', 'flood damage', 'coastal destruction', 'emergency rescue']
                    },
                    'núi lửa|volcano': {
                        broll: ['volcano eruption', 'lava flow', 'volcanic ash', 'magma']
                    },
                    'covid|pandemic|đại dịch': {
                        subjects: ['COVID-19 pandemic'],
                        broll: ['hospital ICU', 'vaccine injection', 'lockdown city', 'medical workers', 'PCR test'],
                        emotions: ['crisis', 'resilience']
                    },

                    // === NATURE ===
                    'rừng|forest|jungle': {
                        broll: ['forest aerial', 'jungle wildlife', 'rainforest drone', 'misty forest']
                    },
                    'sa mạc|desert': {
                        broll: ['desert landscape', 'sand dunes', 'desert aerial', 'oasis']
                    },
                    'băng|ice|glacier|arctic': {
                        broll: ['glacier aerial', 'iceberg', 'arctic landscape', 'polar ice']
                    },
                    'động vật|animal|wildlife': {
                        broll: ['wildlife documentary', 'animal behavior', 'nature footage', 'safari']
                    },
                    'sông|river': {
                        broll: ['river aerial view', 'flowing river', 'river landscape drone']
                    },
                    'biển|ocean|sea': {
                        broll: ['ocean waves', 'underwater footage', 'coastal drone', 'marine life']
                    },
                    'núi|mountain': {
                        broll: ['mountain aerial', 'snowy peaks', 'mountain hiking', 'alpine landscape']
                    },

                    // === BUSINESS & ECONOMY ===
                    'chứng khoán|stock|trading': {
                        broll: ['stock market', 'trading floor', 'stock chart', 'Wall Street']
                    },
                    'startup|doanh nghiệp|business': {
                        broll: ['office meeting', 'startup team', 'business handshake', 'corporate office']
                    },
                    'bất động sản|real estate': {
                        broll: ['luxury apartment', 'real estate aerial', 'construction site', 'property development']
                    },
                    'ngân hàng|bank|finance': {
                        broll: ['bank building', 'money counting', 'ATM', 'financial district']
                    },

                    // === SPORTS ===
                    'bóng đá|football|soccer|world cup': {
                        broll: ['soccer match', 'stadium aerial', 'goal celebration', 'football crowd']
                    },
                    'olympic|thế vận': {
                        broll: ['Olympic ceremony', 'Olympic sports', 'medal ceremony', 'athletic competition']
                    },
                    'F1|formula 1|racing': {
                        broll: ['F1 race', 'pit stop', 'racing car', 'race track aerial']
                    },
                    'boxing|MMA|UFC': {
                        broll: ['boxing match', 'fighter training', 'UFC octagon', 'knockout']
                    },

                    // === ENTERTAINMENT ===
                    'phim|movie|cinema|hollywood': {
                        broll: ['movie premiere', 'film set', 'cinema audience', 'red carpet']
                    },
                    'âm nhạc|music|concert': {
                        broll: ['concert crowd', 'live performance', 'music festival', 'recording studio']
                    },
                    'game|gaming|esport': {
                        broll: ['esports tournament', 'gaming setup', 'gamer playing', 'game graphics']
                    },

                    // === HEALTH & SCIENCE ===
                    'bệnh viện|hospital|medical': {
                        broll: ['hospital interior', 'surgery room', 'medical equipment', 'doctor patient']
                    },
                    'vaccine|thuốc|medicine': {
                        broll: ['vaccine injection', 'laboratory research', 'pharmaceutical factory', 'medical testing']
                    },
                    'DNA|gene|genetics': {
                        broll: ['DNA helix', 'laboratory microscope', 'genetic research', 'biotech']
                    },

                    // === FOOD ===
                    'ẩm thực|food|cooking|chef': {
                        broll: ['cooking preparation', 'restaurant kitchen', 'food plating', 'chef cooking']
                    },
                    'cà phê|coffee': {
                        broll: ['coffee brewing', 'cafe atmosphere', 'barista', 'coffee plantation']
                    },

                    // === COUNTRY SPECIFIC ===
                    'việt nam|vietnam': {
                        locations: ['Vietnam'],
                        broll: ['Hanoi cityscape', 'Ho Chi Minh City', 'Vietnamese culture', 'rice field Vietnam'],
                        official: ['VTV news', 'Vietnam government']
                    },
                    'trung quốc|china|chinese': {
                        locations: ['China'],
                        broll: ['Shanghai skyline', 'Beijing cityscape', 'Chinese technology', 'Great Wall drone']
                    },
                    'mỹ|america|USA|united states': {
                        locations: ['USA'],
                        broll: ['New York City', 'American flag', 'US cityscape', 'Silicon Valley']
                    },
                    'nhật bản|japan|japanese': {
                        locations: ['Japan'],
                        broll: ['Tokyo cityscape', 'Japanese culture', 'Mount Fuji', 'bullet train']
                    },
                    'hàn quốc|korea|korean': {
                        locations: ['South Korea'],
                        broll: ['Seoul cityscape', 'K-pop', 'Korean technology', 'Korean culture']
                    },
                    'ấn độ|india|indian': {
                        locations: ['India'],
                        broll: ['Mumbai skyline', 'Taj Mahal', 'Indian technology', 'Bollywood']
                    },
                    'dubai|UAE|emirates': {
                        locations: ['Dubai', 'UAE'],
                        broll: ['Burj Khalifa', 'Dubai aerial', 'luxury Dubai', 'Palm Jumeirah']
                    }
                };

                // Match topics
                for (const [pattern, keywords] of Object.entries(topicKeywords)) {
                    if (new RegExp(pattern, 'i').test(script)) {
                        if (keywords.subjects) result.subjects.push(...keywords.subjects);
                        if (keywords.locations) result.locations.push(...keywords.locations);
                        if (keywords.broll) result.broll.push(...keywords.broll);
                        if (keywords.technical) result.technical.push(...keywords.technical);
                        if (keywords.official) result.official.push(...keywords.official);
                        if (keywords.emotions) result.emotions.push(...keywords.emotions);
                    }
                }

                // 4. ADD ENGLISH PROPER NOUNS TO SUBJECTS
                engNouns.filter(n => n.length > 3).forEach(n => {
                    if (!result.subjects.includes(n) && !result.locations.includes(n)) {
                        result.subjects.push(n);
                    }
                });

                // 5. GENERATE OFFICIAL KEYWORDS FROM MAIN SUBJECT
                if (result.subjects.length > 0 || result.locations.length > 0) {
                    const mainSubject = result.subjects[0] || result.locations[0];
                    if (mainSubject) {
                        result.official.push(
                            `${mainSubject} official`,
                            `${mainSubject} documentary`,
                            `${mainSubject} drone footage 4K`,
                            `${mainSubject} news report`
                        );
                    }
                }

                // 6. ADD YEAR CONTEXT TO SUBJECTS
                if (years.length > 0) {
                    const year = years[0];
                    result.subjects = result.subjects.slice(0, 3).map(s => `${s} ${year}`);
                }

                // 7. DEDUPLICATE ALL ARRAYS
                Object.keys(result).forEach(key => {
                    result[key] = [...new Set(result[key])];
                });

                return result;
            }

            // ========== AI ANALYSIS WITH GEMINI ==========
            async function analyzeWithAI(input) {
                const apiKey = localStorage.getItem('geminiApiKey');
                const enableAI = localStorage.getItem('enableAI') !== 'false';

                if (!apiKey || !enableAI) return null;

                const prompt = `Bạn là chuyên gia nghiên cứu các dự án công trình lớn trên thế giới. Phân tích input sau và GỢI Ý CÁC DỰ ÁN/CÔNG TRÌNH CÓ THẬT để tìm video minh họa.

QUAN TRỌNG: Luôn gợi ý TÊN CỤ THỂ của các dự án/công trình thật, không dùng từ khóa chung chung.

Input: "${input}"

Ví dụ: Nếu input là "kênh dẫn nước", hãy gợi ý:
- Các dự án thật: "Kachhi Canal Pakistan", "Three Gorges Dam", "Grand Ethiopian Renaissance Dam", "South-North Water Transfer China"
- KHÔNG gợi ý: "water canal", "irrigation system" (quá chung chung)

Trả về JSON (chỉ JSON, không text khác):
{
  "topic": "tên chủ đề chính bằng tiếng Anh",
  "context": "giải thích ngắn về chủ đề và các dự án nổi bật",
  "keywords": {
    "main": ["3-5 TÊN DỰ ÁN/CÔNG TRÌNH CỤ THỂ CÓ THẬT nổi tiếng nhất liên quan"],
    "realProjects": ["5-8 dự án thực tế khác trên thế giới, ưu tiên các dự án lớn, gây tranh cãi, hoặc mới hoàn thành"],
    "official": ["2-3 nguồn chính thức: tên cơ quan, tổ chức quản lý dự án"],
    "broll": ["5-8 từ khóa b-roll stock footage cho loại công trình này"],
    "countrySpecific": ["3-5 dự án tương tự ở các quốc gia khác nhau, format: TênDựÁn + Quốc gia"],
    "trending": ["2-3 dự án đang được chú ý năm 2024-2025"]
  }
}`;

                // Try multiple model versions for compatibility
                const models = [
                    'gemini-2.0-flash-exp',
                    'gemini-1.5-flash-latest',
                    'gemini-1.5-flash',
                    'gemini-pro'
                ];

                for (const model of models) {
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: prompt }] }],
                                    generationConfig: {
                                        temperature: 0.7,
                                        maxOutputTokens: 1024
                                    }
                                })
                            }
                        );

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.log(`Model ${model} failed:`, errorData);
                            continue; // Try next model
                        }

                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                        // Extract JSON from response
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            console.log(`AI success with model: ${model}`);
                            return JSON.parse(jsonMatch[0]);
                        }
                    } catch (e) {
                        console.error(`Model ${model} error:`, e);
                        continue;
                    }
                }

                console.error('All AI models failed');
                return null;
            }

            // ========== SETTINGS FUNCTIONS ==========
            function toggleSettings() {
                const panel = document.getElementById('settingsPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }

            function saveSettings() {
                const apiKey = document.getElementById('geminiApiKey').value;
                const enableAI = document.getElementById('enableAI').checked;

                localStorage.setItem('geminiApiKey', apiKey);
                localStorage.setItem('enableAI', enableAI);

                toast('Đã lưu cài đặt!');
                autoSyncToDrive();
                toggleSettings();
            }

            function loadSettings() {
                const apiKey = localStorage.getItem('geminiApiKey') || '';
                const enableAI = localStorage.getItem('enableAI') !== 'false';

                document.getElementById('geminiApiKey').value = apiKey;
                document.getElementById('enableAI').checked = enableAI;
            }

            // Load settings on page load
            document.addEventListener('DOMContentLoaded', () => {
                loadSettings();
                initLanguageDropdowns();
            });

            // ========== COUNTRY DROPDOWN (with primary language) ==========
            const ALL_COUNTRIES = [
                // Global
                { code: '', name: 'Tất cả quốc gia', flag: '🌐', lang: '' },

                // Đông Nam Á
                { code: 'VN', name: 'Việt Nam', flag: '🇻🇳', lang: 'vi' },
                { code: 'TH', name: 'Thái Lan', flag: '🇹🇭', lang: 'th' },
                { code: 'ID', name: 'Indonesia', flag: '🇮🇩', lang: 'id' },
                { code: 'MY', name: 'Malaysia', flag: '🇲🇾', lang: 'ms' },
                { code: 'SG', name: 'Singapore', flag: '🇸🇬', lang: 'en' },
                { code: 'PH', name: 'Philippines', flag: '🇵🇭', lang: 'tl' },
                { code: 'MM', name: 'Myanmar', flag: '🇲🇲', lang: 'my' },
                { code: 'KH', name: 'Campuchia', flag: '🇰🇭', lang: 'km' },
                { code: 'LA', name: 'Lào', flag: '🇱🇦', lang: 'lo' },
                { code: 'BN', name: 'Brunei', flag: '🇧🇳', lang: 'ms' },
                { code: 'TL', name: 'Timor-Leste', flag: '🇹🇱', lang: 'pt' },

                // Đông Á
                { code: 'CN', name: 'Trung Quốc', flag: '🇨🇳', lang: 'zh-CN' },
                { code: 'TW', name: 'Đài Loan', flag: '🇹🇼', lang: 'zh-TW' },
                { code: 'HK', name: 'Hồng Kông', flag: '🇭🇰', lang: 'zh-TW' },
                { code: 'JP', name: 'Nhật Bản', flag: '🇯🇵', lang: 'ja' },
                { code: 'KR', name: 'Hàn Quốc', flag: '🇰🇷', lang: 'ko' },
                { code: 'MN', name: 'Mông Cổ', flag: '🇲🇳', lang: 'mn' },

                // Nam Á
                { code: 'IN', name: 'Ấn Độ', flag: '🇮🇳', lang: 'hi' },
                { code: 'PK', name: 'Pakistan', flag: '🇵🇰', lang: 'ur' },
                { code: 'BD', name: 'Bangladesh', flag: '🇧🇩', lang: 'bn' },
                { code: 'NP', name: 'Nepal', flag: '🇳🇵', lang: 'ne' },
                { code: 'LK', name: 'Sri Lanka', flag: '🇱🇰', lang: 'si' },
                { code: 'AF', name: 'Afghanistan', flag: '🇦🇫', lang: 'fa' },

                // Trung Đông
                { code: 'SA', name: 'Ả Rập Saudi', flag: '🇸🇦', lang: 'ar' },
                { code: 'AE', name: 'UAE', flag: '🇦🇪', lang: 'ar' },
                { code: 'IR', name: 'Iran', flag: '🇮🇷', lang: 'fa' },
                { code: 'IQ', name: 'Iraq', flag: '🇮🇶', lang: 'ar' },
                { code: 'IL', name: 'Israel', flag: '🇮🇱', lang: 'he' },
                { code: 'TR', name: 'Thổ Nhĩ Kỳ', flag: '🇹🇷', lang: 'tr' },
                { code: 'EG', name: 'Ai Cập', flag: '🇪🇬', lang: 'ar' },
                { code: 'QA', name: 'Qatar', flag: '🇶🇦', lang: 'ar' },
                { code: 'KW', name: 'Kuwait', flag: '🇰🇼', lang: 'ar' },
                { code: 'OM', name: 'Oman', flag: '🇴🇲', lang: 'ar' },
                { code: 'JO', name: 'Jordan', flag: '🇯🇴', lang: 'ar' },
                { code: 'LB', name: 'Lebanon', flag: '🇱🇧', lang: 'ar' },
                { code: 'SY', name: 'Syria', flag: '🇸🇾', lang: 'ar' },

                // Châu Âu - Tây
                { code: 'GB', name: 'Anh', flag: '🇬🇧', lang: 'en' },
                { code: 'US', name: 'Mỹ', flag: '🇺🇸', lang: 'en' },
                { code: 'FR', name: 'Pháp', flag: '🇫🇷', lang: 'fr' },
                { code: 'DE', name: 'Đức', flag: '🇩🇪', lang: 'de' },
                { code: 'ES', name: 'Tây Ban Nha', flag: '🇪🇸', lang: 'es' },
                { code: 'IT', name: 'Ý', flag: '🇮🇹', lang: 'it' },
                { code: 'PT', name: 'Bồ Đào Nha', flag: '🇵🇹', lang: 'pt' },
                { code: 'NL', name: 'Hà Lan', flag: '🇳🇱', lang: 'nl' },
                { code: 'BE', name: 'Bỉ', flag: '🇧🇪', lang: 'nl' },
                { code: 'CH', name: 'Thụy Sĩ', flag: '🇨🇭', lang: 'de' },
                { code: 'AT', name: 'Áo', flag: '🇦🇹', lang: 'de' },
                { code: 'IE', name: 'Ireland', flag: '🇮🇪', lang: 'en' },
                { code: 'LU', name: 'Luxembourg', flag: '🇱🇺', lang: 'fr' },

                // Châu Âu - Bắc
                { code: 'SE', name: 'Thụy Điển', flag: '🇸🇪', lang: 'sv' },
                { code: 'NO', name: 'Na Uy', flag: '🇳🇴', lang: 'no' },
                { code: 'DK', name: 'Đan Mạch', flag: '🇩🇰', lang: 'da' },
                { code: 'FI', name: 'Phần Lan', flag: '🇫🇮', lang: 'fi' },
                { code: 'IS', name: 'Iceland', flag: '🇮🇸', lang: 'is' },

                // Châu Âu - Đông
                { code: 'RU', name: 'Nga', flag: '🇷🇺', lang: 'ru' },
                { code: 'UA', name: 'Ukraine', flag: '🇺🇦', lang: 'uk' },
                { code: 'PL', name: 'Ba Lan', flag: '🇵🇱', lang: 'pl' },
                { code: 'CZ', name: 'Séc', flag: '🇨🇿', lang: 'cs' },
                { code: 'SK', name: 'Slovakia', flag: '🇸🇰', lang: 'sk' },
                { code: 'HU', name: 'Hungary', flag: '🇭🇺', lang: 'hu' },
                { code: 'RO', name: 'Romania', flag: '🇷🇴', lang: 'ro' },
                { code: 'BG', name: 'Bulgaria', flag: '🇧🇬', lang: 'bg' },
                { code: 'BY', name: 'Belarus', flag: '🇧🇾', lang: 'be' },
                { code: 'MD', name: 'Moldova', flag: '🇲🇩', lang: 'ro' },

                // Châu Âu - Nam / Balkan
                { code: 'GR', name: 'Hy Lạp', flag: '🇬🇷', lang: 'el' },
                { code: 'HR', name: 'Croatia', flag: '🇭🇷', lang: 'hr' },
                { code: 'RS', name: 'Serbia', flag: '🇷🇸', lang: 'sr' },
                { code: 'SI', name: 'Slovenia', flag: '🇸🇮', lang: 'sl' },
                { code: 'BA', name: 'Bosnia', flag: '🇧🇦', lang: 'bs' },
                { code: 'ME', name: 'Montenegro', flag: '🇲🇪', lang: 'sr' },
                { code: 'MK', name: 'Bắc Macedonia', flag: '🇲🇰', lang: 'mk' },
                { code: 'AL', name: 'Albania', flag: '🇦🇱', lang: 'sq' },
                { code: 'MT', name: 'Malta', flag: '🇲🇹', lang: 'mt' },
                { code: 'CY', name: 'Cyprus', flag: '🇨🇾', lang: 'el' },

                // Châu Âu - Baltic
                { code: 'EE', name: 'Estonia', flag: '🇪🇪', lang: 'et' },
                { code: 'LV', name: 'Latvia', flag: '🇱🇻', lang: 'lv' },
                { code: 'LT', name: 'Lithuania', flag: '🇱🇹', lang: 'lt' },

                // Châu Âu - Caucasus
                { code: 'GE', name: 'Georgia', flag: '🇬🇪', lang: 'ka' },
                { code: 'AM', name: 'Armenia', flag: '🇦🇲', lang: 'hy' },
                { code: 'AZ', name: 'Azerbaijan', flag: '🇦🇿', lang: 'az' },

                // Trung Á
                { code: 'KZ', name: 'Kazakhstan', flag: '🇰🇿', lang: 'kk' },
                { code: 'UZ', name: 'Uzbekistan', flag: '🇺🇿', lang: 'uz' },
                { code: 'TM', name: 'Turkmenistan', flag: '🇹🇲', lang: 'tk' },
                { code: 'KG', name: 'Kyrgyzstan', flag: '🇰🇬', lang: 'ky' },
                { code: 'TJ', name: 'Tajikistan', flag: '🇹🇯', lang: 'tg' },

                // Châu Mỹ
                { code: 'CA', name: 'Canada', flag: '🇨🇦', lang: 'en' },
                { code: 'MX', name: 'Mexico', flag: '🇲🇽', lang: 'es' },
                { code: 'BR', name: 'Brazil', flag: '🇧🇷', lang: 'pt' },
                { code: 'AR', name: 'Argentina', flag: '🇦🇷', lang: 'es' },
                { code: 'CO', name: 'Colombia', flag: '🇨🇴', lang: 'es' },
                { code: 'CL', name: 'Chile', flag: '🇨🇱', lang: 'es' },
                { code: 'PE', name: 'Peru', flag: '🇵🇪', lang: 'es' },
                { code: 'VE', name: 'Venezuela', flag: '🇻🇪', lang: 'es' },
                { code: 'CU', name: 'Cuba', flag: '🇨🇺', lang: 'es' },

                // Châu Phi
                { code: 'ZA', name: 'Nam Phi', flag: '🇿🇦', lang: 'af' },
                { code: 'NG', name: 'Nigeria', flag: '🇳🇬', lang: 'en' },
                { code: 'KE', name: 'Kenya', flag: '🇰🇪', lang: 'sw' },
                { code: 'ET', name: 'Ethiopia', flag: '🇪🇹', lang: 'am' },
                { code: 'GH', name: 'Ghana', flag: '🇬🇭', lang: 'en' },
                { code: 'TZ', name: 'Tanzania', flag: '🇹🇿', lang: 'sw' },
                { code: 'MA', name: 'Morocco', flag: '🇲🇦', lang: 'ar' },
                { code: 'DZ', name: 'Algeria', flag: '🇩🇿', lang: 'ar' },
                { code: 'TN', name: 'Tunisia', flag: '🇹🇳', lang: 'ar' },

                // Châu Đại Dương
                { code: 'AU', name: 'Úc', flag: '🇦🇺', lang: 'en' },
                { code: 'NZ', name: 'New Zealand', flag: '🇳🇿', lang: 'en' },
                { code: 'FJ', name: 'Fiji', flag: '🇫🇯', lang: 'en' },
                { code: 'PG', name: 'Papua New Guinea', flag: '🇵🇬', lang: 'en' }
            ];

            let selectedCountry = { video: { code: '', lang: '' }, image: { code: '', lang: '' }, ebook: { code: '', lang: '' } };

            function initLanguageDropdowns() {
                renderCountryGrid('video');
                renderCountryGrid('image');
                renderCountryGrid('ebook');

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.country-selector')) {
                        document.querySelectorAll('.country-dropdown').forEach(d => d.classList.remove('show'));
                    }
                });
            }

            // Render country grid (3-column layout like Google)
            function renderCountryGrid(type, filter = '') {
                const grid = document.getElementById(`${type}CountryGrid`);
                if (!grid) return;

                const filterLower = filter.toLowerCase();
                const filtered = ALL_COUNTRIES.filter(c =>
                    c.name.toLowerCase().includes(filterLower) ||
                    c.code.toLowerCase().includes(filterLower)
                );

                grid.innerHTML = filtered.map(country => `
                <div class="country-item ${selectedCountry[type].code === country.code ? 'selected' : ''}" 
                     onclick="selectCountryFromGrid('${type}', '${country.code}', '${country.lang}', '${country.flag} ${country.name}')">
                    <span class="flag">${country.flag}</span>
                    <span>${country.name}</span>
                </div>
            `).join('');
            }

            // Filter countries in dropdown
            function filterCountries(type, value) {
                renderCountryGrid(type, value);
            }

            // Toggle country dropdown
            function toggleCountryDropdown(type) {
                const dropdown = document.getElementById(`${type}CountryDropdown`);
                const isOpen = dropdown.classList.contains('show');

                // Close all dropdowns
                document.querySelectorAll('.country-dropdown').forEach(d => d.classList.remove('show'));

                if (!isOpen) {
                    dropdown.classList.add('show');
                    dropdown.querySelector('.country-search').focus();
                }
            }

            // Select country from horizontal tabs
            async function selectCountryTab(type, btn) {
                const selector = document.getElementById(`${type}CountrySelector`);
                selector.querySelectorAll('.country-tab').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');

                const countryCode = btn.dataset.country;
                const langCode = btn.dataset.lang;
                selectedCountry[type] = { code: countryCode, lang: langCode };

                // Auto-translate if there's text
                const input = document.getElementById(`${type}Input`);
                if (langCode && input.value.trim()) {
                    await translateInput(type, langCode);
                }
            }

            // Select country from dropdown grid
            async function selectCountryFromGrid(type, countryCode, langCode, displayName) {
                selectedCountry[type] = { code: countryCode, lang: langCode };

                // Update active tab
                const selector = document.getElementById(`${type}CountrySelector`);
                selector.querySelectorAll('.country-tab').forEach(t => t.classList.remove('active'));

                // Close dropdown
                document.getElementById(`${type}CountryDropdown`).classList.remove('show');
                renderCountryGrid(type);

                toast(`Đã chọn: ${displayName}`);

                // Auto-translate if there's text
                const input = document.getElementById(`${type}Input`);
                if (langCode && input.value.trim()) {
                    await translateInput(type, langCode);
                }
            }

            function renderCountryList(type, filter = '') {
                const list = document.getElementById(`${type}LangList`);
                const filterLower = filter.toLowerCase();

                const filtered = ALL_COUNTRIES.filter(country =>
                    country.name.toLowerCase().includes(filterLower) ||
                    country.code.toLowerCase().includes(filterLower)
                );

                list.innerHTML = filtered.map(country => `
                <div class="lang-item ${selectedCountry[type].code === country.code ? 'selected' : ''}" 
                     onclick="selectCountry('${type}', '${country.code}', '${country.lang}', '${country.flag} ${country.name}')">
                    <span class="flag">${country.flag}</span>
                    <span>${country.name}</span>
                </div>
            `).join('');
            }

            function toggleLangDropdown(type) {
                const dropdown = document.getElementById(`${type}LangDropdown`);
                const isOpen = dropdown.classList.contains('show');

                // Close all dropdowns
                document.querySelectorAll('.lang-dropdown').forEach(d => d.classList.remove('show'));

                if (!isOpen) {
                    dropdown.classList.add('show');
                    dropdown.querySelector('.lang-search').focus();
                }
            }

            function filterLanguages(type, value) {
                renderCountryList(type, value);
            }

            function selectLang(type, code, displayName) {
                // Find country by code or lang
                const country = ALL_COUNTRIES.find(c => c.code === code || c.lang === code) || ALL_COUNTRIES[0];
                selectCountry(type, country.code, country.lang, displayName);
            }

            async function selectCountry(type, countryCode, langCode, displayName) {
                selectedCountry[type] = { code: countryCode, lang: langCode };
                document.getElementById(`${type}SelectedLang`).textContent = displayName;
                document.getElementById(`${type}LangDropdown`).classList.remove('show');
                renderCountryList(type);

                // Auto-translate if language is selected and there's text in the input
                const input = document.getElementById(`${type}Input`);
                if (langCode && input.value.trim()) {
                    await translateInput(type, langCode);
                }
            }

            // Translate input text to target language
            async function translateInput(type, targetLang) {
                const input = document.getElementById(`${type}Input`);
                const text = input.value.trim();

                if (!text || !targetLang) return;

                toast('Đang dịch...');

                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
                    const data = await res.json();
                    let result = '';
                    if (data[0]) data[0].forEach(d => { if (d[0]) result += d[0]; });
                    if (result && result !== text) {
                        input.value = result;
                        toast(`✅ Đã dịch sang ${targetLang.toUpperCase()}`);
                    } else {
                        toast('Không cần dịch');
                    }
                } catch (e) {
                    toast('Lỗi dịch');
                    console.error('Translation error:', e);
                }
            }

            function getSelectedLang(type) {
                return selectedCountry[type].lang || '';
            }

            // Display suggestions
            function displaySuggestions(type, keywords, script) {
                const container = document.getElementById(`${type}Suggestions`);
                const content = document.getElementById(`${type}SuggestionContent`);

                let html = '';

                // Check if any keywords exist
                const hasKeywords = Object.values(keywords).some(arr => arr.length > 0);

                if (!hasKeywords) {
                    html = '<p style="color:#94a3b8;font-size:0.8rem;">Không tìm thấy từ khóa. Thử mô tả cụ thể hơn.</p>';
                    content.innerHTML = html;
                    container.classList.add('show');
                    return;
                }

                // 1. Subjects (Main topics)
                if (keywords.subjects.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">🎯 Chủ thể chính</div>
                        <div class="suggestion-keywords">
                            ${keywords.subjects.slice(0, 6).map(k => `<span class="keyword-chip official" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 2. Locations
                if (keywords.locations.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">📍 Địa điểm</div>
                        <div class="suggestion-keywords">
                            ${keywords.locations.slice(0, 5).map(k => `<span class="keyword-chip" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 3. Events/Years
                if (keywords.events.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">📅 Năm / Sự kiện</div>
                        <div class="suggestion-keywords">
                            ${keywords.events.slice(0, 4).map(k => `<span class="keyword-chip" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 4. Official sources
                if (keywords.official.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">🏢 Nguồn chính thức</div>
                        <div class="suggestion-keywords">
                            ${keywords.official.slice(0, 5).map(k => `<span class="keyword-chip" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 5. B-roll
                if (keywords.broll.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">🎬 B-roll / Stock</div>
                        <div class="suggestion-keywords">
                            ${keywords.broll.slice(0, 8).map(k => `<span class="keyword-chip" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 6. Technical terms
                if (keywords.technical.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">⚙️ Kỹ thuật</div>
                        <div class="suggestion-keywords">
                            ${keywords.technical.slice(0, 5).map(k => `<span class="keyword-chip" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 7. Emotions/Mood
                if (keywords.emotions.length > 0) {
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">💫 Mood / Cảm xúc</div>
                        <div class="suggestion-keywords">
                            ${keywords.emotions.slice(0, 4).map(k => `<span class="keyword-chip" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                        </div>
                    </div>
                `;
                }

                // 8. Quick translations
                const mainKeyword = keywords.subjects[0] || keywords.locations[0] || '';
                if (mainKeyword) {
                    const cleanKeyword = mainKeyword.replace(/'/g, "\\'");
                    html += `
                    <div class="suggestion-group">
                        <div class="suggestion-label">🌐 Dịch đa ngôn ngữ</div>
                        <div class="suggestion-keywords">
                            <span class="keyword-chip" onclick="translateAndUse('${type}', '${cleanKeyword}', 'zh-CN')">🇨🇳 Trung</span>
                            <span class="keyword-chip" onclick="translateAndUse('${type}', '${cleanKeyword}', 'ja')">🇯🇵 Nhật</span>
                            <span class="keyword-chip" onclick="translateAndUse('${type}', '${cleanKeyword}', 'ko')">🇰🇷 Hàn</span>
                            <span class="keyword-chip" onclick="translateAndUse('${type}', '${cleanKeyword}', 'hi')">🇮🇳 Hindi</span>
                            <span class="keyword-chip" onclick="translateAndUse('${type}', '${cleanKeyword}', 'ar')">🇸🇦 Ả Rập</span>
                        </div>
                    </div>
                `;
                }

                content.innerHTML = html;
                container.classList.add('show');
            }

            // Escape HTML
            function escapeHtml(str) {
                return str.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[c]));
            }

            // Use keyword - now triggers deep dive AI analysis
            window.useKeyword = async function (type, keyword) {
                const input = document.getElementById(`${type}Input`);
                input.value = keyword;
                input.focus();
                toast(`🔍 Phân tích sâu: ${keyword}`);

                // Trigger deep dive analysis for this specific keyword
                await deepDiveAnalysis(type, keyword);
            };

            // Deep dive analysis for a specific keyword
            async function deepDiveAnalysis(type, keyword) {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    toast('Cần API key để phân tích sâu');
                    return;
                }

                const aiSuggestions = document.getElementById('aiSuggestions');
                const aiLoading = document.getElementById('aiLoading');
                const aiContent = document.getElementById('aiSuggestionContent');

                aiSuggestions.style.display = 'block';
                aiLoading.style.display = 'flex';
                aiContent.innerHTML = '';

                const deepPrompt = `Bạn là chuyên gia nghiên cứu dự án "${keyword}". 

Hãy phân tích CHI TIẾT và cung cấp thông tin CỤ THỂ về dự án/công trình này.

Trả về JSON (chỉ JSON, không text khác):
{
  "topic": "${keyword}",
  "context": "Mô tả ngắn gọn về dự án: vị trí, quy mô, mục đích, năm hoàn thành",
  "keywords": {
    "main": ["3-5 khía cạnh chính của dự án này: giai đoạn xây dựng, công ty thi công, chi phí, etc"],
    "phases": ["Các giai đoạn cụ thể của dự án: Phase 1, Phase 2, hoặc các mốc thời gian quan trọng"],
    "companies": ["Các công ty, tổ chức tham gia: nhà thầu, nhà đầu tư, công ty kỹ thuật"],
    "impacts": ["Tác động của dự án: môi trường, kinh tế, xã hội, dân cư bị ảnh hưởng"],
    "related": ["Các dự án tương tự hoặc cạnh tranh trên thế giới"],
    "controversy": ["Tranh cãi hoặc vấn đề nổi bật: chi phí vượt mức, delay, phản đối"],
    "broll": ["5-8 từ khóa b-roll specific cho dự án này"],
    "news": ["Từ khóa tìm tin tức mới nhất về dự án"]
  }
}`;

                try {
                    const models = ['gemini-2.0-flash-exp', 'gemini-1.5-flash-latest', 'gemini-1.5-flash'];
                    let result = null;

                    for (const model of models) {
                        try {
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ parts: [{ text: deepPrompt }] }],
                                        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
                                    })
                                }
                            );

                            if (response.ok) {
                                const data = await response.json();
                                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                                if (text) {
                                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                                    if (jsonMatch) {
                                        result = JSON.parse(jsonMatch[0]);
                                        break;
                                    }
                                }
                            }
                        } catch (e) { continue; }
                    }

                    aiLoading.style.display = 'none';

                    if (result) {
                        displayDeepDiveSuggestions(type, result);
                        toast('✅ Đã phân tích xong');
                    } else {
                        aiContent.innerHTML = '<p style="color:var(--text-secondary)">Không thể phân tích. Thử lại sau.</p>';
                    }
                } catch (e) {
                    aiLoading.style.display = 'none';
                    console.error(e);
                    toast('Lỗi phân tích sâu');
                }
            }

            // Display deep dive suggestions
            function displayDeepDiveSuggestions(type, aiResult) {
                const content = document.getElementById('aiSuggestionContent');

                let html = `
                <div class="ai-section">
                    <div class="ai-section-title" style="color: var(--google-blue);">🔬 Phân tích sâu: ${escapeHtml(aiResult.topic || '')}</div>
                    ${aiResult.context ? `<p style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.75rem;line-height:1.5;">${escapeHtml(aiResult.context)}</p>` : ''}
            `;

                const categories = [
                    { key: 'main', label: '📌 Chi tiết dự án' },
                    { key: 'phases', label: '📅 Các giai đoạn' },
                    { key: 'companies', label: '🏢 Công ty tham gia' },
                    { key: 'impacts', label: '💥 Tác động' },
                    { key: 'controversy', label: '⚠️ Tranh cãi' },
                    { key: 'related', label: '🔗 Dự án liên quan' },
                    { key: 'broll', label: '🎬 B-roll footage' },
                    { key: 'news', label: '📰 Tin tức mới nhất' }
                ];

                categories.forEach(cat => {
                    const kws = aiResult.keywords?.[cat.key] || [];
                    if (kws.length > 0) {
                        html += `
                        <div class="suggestion-group">
                            <div class="suggestion-label">${cat.label}</div>
                            <div class="suggestion-keywords">
                                ${kws.map(k => `<span class="keyword-chip ai" onclick="useKeyword('${type}', '${escapeHtml(k)}')">${escapeHtml(k)}</span>`).join('')}
                            </div>
                        </div>
                    `;
                    }
                });

                html += '</div>';
                content.innerHTML = html;
            }

            // Translate and use
            window.translateAndUse = async function (type, keyword, lang) {
                const input = document.getElementById(`${type}Input`);
                toast('Đang dịch...');

                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${lang}&dt=t&q=${encodeURIComponent(keyword)}`);
                    const data = await res.json();
                    let result = '';
                    if (data[0]) data[0].forEach(d => { if (d[0]) result += d[0]; });
                    if (result) {
                        input.value = result;
                        toast(`Đã dịch: ${result}`);
                    }
                } catch (e) {
                    toast('Lỗi dịch');
                }
            };

            // Language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const row = this.closest('.lang-row');
                    row.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const lang = this.dataset.lang;
                    const input = currentTab === 'video' ? document.getElementById('videoInput') : document.getElementById('imageInput');

                    if (lang && input.value.trim()) {
                        await translate(input.value.trim(), lang, input);
                    }
                });
            });

            async function translate(text, lang, input) {
                try {
                    toast('Translating...');
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${lang}&dt=t&q=${encodeURIComponent(text)}`);
                    const data = await res.json();
                    let result = '';
                    if (data[0]) data[0].forEach(d => { if (d[0]) result += d[0]; });
                    if (result && result !== text) {
                        input.value = result;
                        toast('Translated ✓');
                    }
                } catch (e) { toast('Translation failed'); }
            }

            // Platform count
            function updateCount() {
                document.getElementById('videoCount').textContent = document.querySelectorAll('#video-tab .platform input:checked').length;
                document.getElementById('movieCount').textContent = document.querySelectorAll('#movie-tab .platform input:checked').length;
                document.getElementById('imageCount').textContent = document.querySelectorAll('#image-tab .platform input:checked').length;
                document.getElementById('ebookCount').textContent = document.querySelectorAll('#ebook-tab .platform input:checked').length;
                document.getElementById('apkCount').textContent = document.querySelectorAll('#apk-tab .platform input:checked').length;
                document.getElementById('softwareCount').textContent = document.querySelectorAll('#software-tab .platform input:checked').length;
                document.getElementById('aiCount').textContent = document.querySelectorAll('#ai-tab .platform input:checked').length;
                document.getElementById('wikiCount').textContent = document.querySelectorAll('#wiki-tab .platform input:checked').length;
                document.getElementById('reverseCount').textContent = document.querySelectorAll('#reverse-tab .platform input:checked').length;
                document.getElementById('discoverCount').textContent = document.querySelectorAll('#discover-tab .platform input:checked').length;
                document.getElementById('visionCount').textContent = document.querySelectorAll('#vision-tab .platform input:checked').length;
            }

            document.querySelectorAll('.platform input').forEach(cb => cb.addEventListener('change', updateCount));

            window.toggleAll = function (type) {
                const cbs = document.querySelectorAll(`#${type}-tab .platform input`);
                const all = [...cbs].every(cb => cb.checked);
                cbs.forEach(cb => cb.checked = !all);
                updateCount();
            };

            // Search
            function search() {
                let input, urls, query = '';

                if (currentTab === 'video') {
                    input = document.getElementById('videoInput');
                    urls = VIDEO_URLS;
                    query = input ? input.value.trim() : '';
                } else if (currentTab === 'movie') {
                    input = document.getElementById('movieInput');
                    urls = MOVIE_URLS;
                    query = input ? input.value.trim() : '';
                } else if (currentTab === 'image') {
                    input = document.getElementById('imageInput');
                    urls = IMAGE_URLS;
                    query = input ? input.value.trim() : '';
                } else if (currentTab === 'ebook') {
                    input = document.getElementById('ebookInput');
                    urls = EBOOK_URLS;
                    query = input ? input.value.trim() : '';
                } else if (currentTab === 'apk') {
                    input = document.getElementById('apkInput');
                    urls = APK_URLS;
                    query = input ? input.value.trim() : '';
                } else if (currentTab === 'software') {
                    input = document.getElementById('softwareInput');
                    urls = SOFTWARE_URLS;
                    query = input ? input.value.trim() : '';
                } else if (currentTab === 'wiki') {
                    input = document.getElementById('wikiInput');
                    urls = WIKI_URLS;
                    query = input ? input.value.trim() : '';
                } else {
                    // Reverse tab - no input needed
                    urls = REVERSE_URLS;
                }

                const selected = [];
                document.querySelectorAll(`#${currentTab}-tab .platform input:checked`).forEach(cb => selected.push(cb.dataset.p));

                if (!selected.length) {
                    // No platform selected - open default homepage (first platform in tab)
                    if (!query) {
                        const defaultHomepage = getTabDefaultHomepage();
                        if (defaultHomepage) {
                            toast('Mở trang chủ mặc định...');
                            window.open(defaultHomepage, '_blank');
                            return;
                        }
                    }
                    toast('Chọn ít nhất 1 trang');
                    return;
                }

                if (query) {
                    // Search with keyword
                    addHistory(query);
                    toast(`Tìm "${query}" trên ${selected.length} trang...`);
                    selected.forEach((p, i) => setTimeout(() => window.open(urls[p](query), '_blank'), i * 400));
                } else {
                    // No keyword - open homepages
                    toast(`Mở ${selected.length} trang chủ...`);
                    selected.forEach((p, i) => {
                        const homepage = HOMEPAGE_URLS[p] || (urls[p] ? urls[p]('') : null);
                        if (homepage) {
                            setTimeout(() => window.open(homepage, '_blank'), i * 400);
                        }
                    });
                }
            }

            document.getElementById('videoSearchBtn').addEventListener('click', search);
            document.getElementById('movieSearchBtn').addEventListener('click', search);
            document.getElementById('imageSearchBtn').addEventListener('click', search);
            document.getElementById('ebookSearchBtn').addEventListener('click', search);
            document.getElementById('apkSearchBtn').addEventListener('click', search);
            document.getElementById('softwareSearchBtn').addEventListener('click', search);
            document.getElementById('aiSearchBtn').addEventListener('click', search);
            document.getElementById('wikiSearchBtn').addEventListener('click', search);
            document.getElementById('reverseSearchBtn').addEventListener('click', search);
            document.getElementById('discoverSearchBtn').addEventListener('click', search);
            document.getElementById('visionSearchBtn').addEventListener('click', search);
            document.getElementById('videoInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
            document.getElementById('movieInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
            document.getElementById('imageInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
            document.getElementById('ebookInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
            document.getElementById('apkInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
            document.getElementById('softwareInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
            document.getElementById('wikiInput').addEventListener('keypress', e => { if (e.key === 'Enter') search(); });

            // Direct click on platform label to open homepage (only when no query)
            document.querySelectorAll('.platform-label').forEach(label => {
                label.style.cursor = 'pointer';
                label.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // Get current input value
                    let query = '';

                    if (currentTab === 'video') {
                        const input = document.getElementById('videoInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'movie') {
                        const input = document.getElementById('movieInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'image') {
                        const input = document.getElementById('imageInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'ebook') {
                        const input = document.getElementById('ebookInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'apk') {
                        const input = document.getElementById('apkInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'software') {
                        const input = document.getElementById('softwareInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'wiki') {
                        const input = document.getElementById('wikiInput');
                        query = input ? input.value.trim() : '';
                    } else if (currentTab === 'reverse') {
                        // Check both pasted URL and uploaded result URL
                        const urlInput = document.getElementById('imageUrlInput');
                        const resultInput = document.getElementById('resultUrl');
                        query = (urlInput && urlInput.value.trim()) || (resultInput && resultInput.value.trim()) || '';
                    }

                    // Only open homepage if NO query (if has query, must use Search button)
                    if (query) {
                        // Has query - just toggle checkbox, user must click Search
                        const checkbox = label.parentElement.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            updateCount();
                        }
                        return;
                    }

                    // No query - open homepage directly
                    const checkbox = label.parentElement.querySelector('input[type="checkbox"]');
                    const platformKey = checkbox ? checkbox.dataset.p : null;
                    if (!platformKey) return;

                    const homepage = HOMEPAGE_URLS[platformKey];
                    if (homepage) {
                        window.open(homepage, '_blank');
                    }
                });
            });

            // History
            function addHistory(q) {
                history = history.filter(h => h !== q);
                history.unshift(q);
                if (history.length > 10) history.pop();
                localStorage.setItem('searchHistory', JSON.stringify(history));
                autoSyncToDrive();
                renderHistory();
            }

            function renderHistory() {
                const list = document.getElementById('historyList');
                if (!history.length) { list.innerHTML = '<span class="empty">No recent</span>'; return; }
                list.innerHTML = history.map(q => `<span class="history-item">${q}</span>`).join('');
                list.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const input = currentTab === 'video' ? document.getElementById('videoInput') : document.getElementById('imageInput');
                        input.value = item.textContent;
                        input.focus();
                    });
                });
            }

            function toast(msg) {
                let t = document.querySelector('.toast');
                if (!t) { t = document.createElement('div'); t.className = 'toast'; document.body.appendChild(t); }
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            }

            updateCount();
            renderHistory();

            // ===== IMAGE UPLOAD FOR REVERSE SEARCH =====
            const IMGBB_API_KEY = '7a7d6a0f8e6b4c5d9e8f7a6b5c4d3e2f'; // Free tier key
            let uploadedImageUrl = '';

            const uploadArea = document.getElementById('uploadArea');
            const imageFile = document.getElementById('imageFile');
            const imageUrlInput = document.getElementById('imageUrlInput');
            const uploadPreview = document.getElementById('uploadPreview');
            const previewImg = document.getElementById('previewImg');
            const uploadStatus = document.getElementById('uploadStatus');

            // Click to upload
            uploadArea.addEventListener('click', () => imageFile.click());

            // File selected
            imageFile.addEventListener('change', (e) => {
                if (e.target.files[0]) handleFile(e.target.files[0]);
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
            });

            // Paste image from clipboard
            document.addEventListener('paste', (e) => {
                if (currentTab !== 'reverse') return;
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.startsWith('image/')) {
                        handleFile(item.getAsFile());
                        break;
                    }
                }
            });

            // URL input
            imageUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const url = imageUrlInput.value.trim();
                    if (url) {
                        uploadedImageUrl = url;
                        showPreview(url);
                        setStatus('URL đã sẵn sàng!', 'success');
                    }
                }
            });

            imageUrlInput.addEventListener('blur', () => {
                const url = imageUrlInput.value.trim();
                if (url && url.startsWith('http')) {
                    uploadedImageUrl = url;
                    showPreview(url);
                    setStatus('URL đã sẵn sàng!', 'success');
                }
            });

            // Handle file upload
            async function handleFile(file) {
                if (!file.type.startsWith('image/')) {
                    setStatus('Chỉ hỗ trợ file ảnh!', 'error');
                    return;
                }

                if (file.size > 32 * 1024 * 1024) {
                    setStatus('File quá lớn! Tối đa 32MB', 'error');
                    return;
                }

                // Show local preview
                const reader = new FileReader();
                reader.onload = (e) => showPreview(e.target.result);
                reader.readAsDataURL(file);

                // Try multiple free image hosts
                setStatus('⏳ Đang upload ảnh...', '');

                // Try catbox.moe (no API key needed)
                try {
                    const formData = new FormData();
                    formData.append('reqtype', 'fileupload');
                    formData.append('fileToUpload', file);

                    const response = await fetch('https://catbox.moe/user/api.php', {
                        method: 'POST',
                        body: formData
                    });

                    const url = await response.text();

                    if (url && url.startsWith('https://')) {
                        uploadedImageUrl = url.trim();
                        setStatus('✅ Upload thành công! Click "Open Tools" để tìm kiếm.', 'success');
                        showUrl(uploadedImageUrl);
                        return;
                    }
                } catch (e) {
                    console.log('Catbox failed, trying litterbox...');
                }

                // Fallback: Try litterbox.catbox.moe (temporary, 1 hour)
                try {
                    const formData = new FormData();
                    formData.append('reqtype', 'fileupload');
                    formData.append('time', '1h');
                    formData.append('fileToUpload', file);

                    const response = await fetch('https://litterbox.catbox.moe/resources/internals/api.php', {
                        method: 'POST',
                        body: formData
                    });

                    const url = await response.text();

                    if (url && url.startsWith('https://')) {
                        uploadedImageUrl = url.trim();
                        setStatus('✅ Upload thành công (link 1 giờ)! Click "Open Tools".', 'success');
                        showUrl(uploadedImageUrl);
                        return;
                    }
                } catch (e) {
                    console.log('Litterbox failed');
                }

                // Final fallback: use base64 locally
                setStatus('⚠️ Upload lỗi. Dùng "Open Tools" và upload thủ công vào từng trang.', 'error');
            }

            function showPreview(src) {
                previewImg.src = src;
                uploadPreview.style.display = 'inline-block';
            }

            window.removePreview = function () {
                uploadPreview.style.display = 'none';
                previewImg.src = '';
                uploadedImageUrl = '';
                imageUrlInput.value = '';
                imageFile.value = '';
                setStatus('', '');
                hideUrl();
            };

            function setStatus(msg, type) {
                uploadStatus.textContent = msg;
                uploadStatus.className = 'upload-status ' + type;
            }

            function showUrl(url) {
                const urlResult = document.getElementById('urlResult');
                const resultUrl = document.getElementById('resultUrl');
                resultUrl.value = url;
                urlResult.style.display = 'flex';
            }

            function hideUrl() {
                document.getElementById('urlResult').style.display = 'none';
            }

            window.copyUrl = function () {
                const resultUrl = document.getElementById('resultUrl');
                resultUrl.select();
                document.execCommand('copy');

                const btn = document.querySelector('.copy-url-btn');
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);

                toast('Đã copy URL!');
            };

            // Update reverse search to use uploaded URL
            const originalReverseUrls = { ...REVERSE_URLS };

            // Override REVERSE_URLS to use uploaded image URL when available
            Object.keys(REVERSE_URLS).forEach(key => {
                const original = REVERSE_URLS[key];
                REVERSE_URLS[key] = () => {
                    if (uploadedImageUrl && uploadedImageUrl.startsWith('http')) {
                        // Tools that support URL parameter
                        const urlSupported = {
                            tineye: `https://tineye.com/search?url=${encodeURIComponent(uploadedImageUrl)}`,
                            yandexreverse: `https://yandex.com/images/search?rpt=imageview&url=${encodeURIComponent(uploadedImageUrl)}`,
                            googlereverse: `https://lens.google.com/uploadbyurl?url=${encodeURIComponent(uploadedImageUrl)}`,
                            lenso: `https://lenso.ai/en/search-by-url?url=${encodeURIComponent(uploadedImageUrl)}`,
                            saucenao: `https://saucenao.com/search.php?url=${encodeURIComponent(uploadedImageUrl)}`,
                            iqdb: `https://iqdb.org/?url=${encodeURIComponent(uploadedImageUrl)}`,
                            trace: `https://trace.moe/?url=${encodeURIComponent(uploadedImageUrl)}`,
                            imgops: `https://imgops.com/${encodeURIComponent(uploadedImageUrl)}`
                        };
                        return urlSupported[key] || original();
                    }
                    return original();
                };
            });

            // ========== DRAGGABLE TABS ==========
            const tabsContainer = document.getElementById('tabsWrapper');
            let draggedTab = null;

            tabsContainer.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('dragstart', (e) => {
                    draggedTab = tab;
                    tab.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                tab.addEventListener('dragend', () => {
                    tab.classList.remove('dragging');
                    draggedTab = null;
                    saveTabOrder();
                });

                tab.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedTab && draggedTab !== tab) {
                        const rect = tab.getBoundingClientRect();
                        const midPoint = rect.left + rect.width / 2;
                        if (e.clientX < midPoint) {
                            tabsContainer.insertBefore(draggedTab, tab);
                        } else {
                            tabsContainer.insertBefore(draggedTab, tab.nextSibling);
                        }
                    }
                });
            });

            function saveTabOrder() {
                const order = [];
                tabsContainer.querySelectorAll('.tab').forEach(tab => {
                    order.push(tab.dataset.tab);
                });
                localStorage.setItem('tabOrder', JSON.stringify(order));
                autoSyncToDrive();
            }

            function loadTabOrder() {
                const order = JSON.parse(localStorage.getItem('tabOrder') || '[]');
                if (order.length > 0) {
                    order.forEach(tabId => {
                        const tab = tabsContainer.querySelector(`[data-tab="${tabId}"]`);
                        if (tab) tabsContainer.appendChild(tab);
                    });
                }
            }

            loadTabOrder();

            // Replace emoji icons with real favicons
            const FAVICON_DOMAINS = {
                // Video - Global
                youtube: 'youtube.com',
                tiktok: 'tiktok.com',
                instagram: 'instagram.com',
                facebook: 'facebook.com',
                googlevideos: 'google.com',
                vimeo: 'vimeo.com',
                dailymotion: 'dailymotion.com',
                twitch: 'twitch.tv',
                rumble: 'rumble.com',
                // Video - China
                douyin: 'douyin.com',
                bilibili: 'bilibili.com',
                kuaishou: 'kuaishou.com',
                xiaohongshu: 'xiaohongshu.com',
                weibo: 'weibo.com',
                youku: 'youku.com',
                iqiyi: 'iqiyi.com',
                tencentvideo: 'v.qq.com',
                mangotv: 'mgtv.com',
                // Video - Stock
                pexelsvideo: 'pexels.com',
                pixabayvideo: 'pixabay.com',
                coverr: 'coverr.co',
                videezy: 'videezy.com',
                lifeofvids: 'lifeofvids.com',
                mazwai: 'mazwai.com',
                vidsplay: 'vidsplay.com',
                vecteezy: 'vecteezy.com',
                dareful: 'dareful.com',
                // Image
                googleimages: 'google.com',
                yandex: 'yandex.com',
                bingimages: 'bing.com',
                pinterest: 'pinterest.com',
                tineye: 'tineye.com',
                lenso: 'lenso.ai',
                unsplash: 'unsplash.com',
                pexels: 'pexels.com',
                pixabay: 'pixabay.com',
                freepik: 'freepik.com',
                behance: 'behance.net',
                dribbble: 'dribbble.com',
                artstation: 'artstation.com',
                baidu: 'baidu.com',
                sogou: 'sogou.com',
                huaban: 'huaban.com',
                // Ebook
                annas: 'annas-archive.org',
                libgen: 'libgen.is',
                zlibrary: 'z-lib.id',
                pdfdrive: 'pdfdrive.com',
                oceanofpdf: 'oceanofpdf.com',
                gutenberg: 'gutenberg.org',
                openlibrary: 'openlibrary.org',
                standardebooks: 'standardebooks.org',
                manybooks: 'manybooks.net',
                smashwords: 'smashwords.com',
                obooko: 'obooko.com',
                epubbooks: 'epubbooks.com',
                bookboon: 'bookboon.com',
                googlebooks: 'books.google.com',
                // Movie - Global Hot
                hydrahd: 'hydrahd.cc',
                cineby: 'cineby.app',
                fmovies: 'fmoviesz.to',
                m4uhd: 'm4uhd.tv',
                movie456: '456movie.com',
                sflix: 'sflix.to',
                flixhq: 'flixhq.to',
                soap2day: 'soap2day.tf',
                // Movie - Legal Free
                tubi: 'tubitv.com',
                plextv: 'plex.tv',
                plutotv: 'pluto.tv',
                rokuchannel: 'roku.com',
                peacock: 'peacocktv.com',
                freevee: 'amazon.com',
                // Movie - Database
                imdb: 'imdb.com',
                letterboxd: 'letterboxd.com',
                rottentomatoes: 'rottentomatoes.com',
                justwatch: 'justwatch.com',
                tmdb: 'themoviedb.org',
                // Movie - China
                cupfox: 'cupfox.app',
                libvio: 'libvio.cc',
                iyf: 'iyf.tv',
                duonao: 'duonaovod.com',
                duboku: 'duboku.tv',
                cnys: 'cnys.tv',
                olevod: 'olevod.com',
                nivod: 'nivod.tv',
                douban: 'douban.com',
                // Movie - Russia
                hdrezka: 'hdrezka.ag',
                kinopoisk: 'kinopoisk.ru',
                ivi: 'ivi.ru',
                okko: 'okko.tv',
                lordfilm: 'lordfilm.gg',
                kinogo: 'kinogo.cc',
                start: 'start.ru',
                // PC Software - Torrent
                rutracker: 'rutracker.org',
                '1337x': '1337x.to',
                fitgirl: 'fitgirl-repacks.site',
                dodi: 'dodi-repacks.site',
                steamrip: 'steamrip.com',
                // PC Software - Russia
                rsload: 'rsload.net',
                nnmclub: 'nnmclub.to',
                rutor: 'rutor.info',
                softportal: 'softportal.com',
                // PC Software - China
                '52pojie': '52pojie.cn',
                ghboke: 'ghxi.com',
                '423down': '423down.com',
                iplaysoft: 'iplaysoft.com',
                carrotchou: 'carrotchou.blog',
                // Software - Additional
                piratebay: 'thepiratebay.org',
                torrentgalaxy: 'torrentgalaxy.to',
                'gog-games': 'gog-games.to',
                ovagames: 'ovagames.com',
                masuit: 'masuit.com',
                getintopc: 'getintopc.com',
                filecr: 'filecr.com',
                nsaneforums: 'nsaneforums.com',
                // APK
                mobilism: 'mobilism.org',
                platinmods: 'platinmods.com',
                modyolo: 'modyolo.com',
                liteapks: 'liteapks.com',
                apkdone: 'apkdone.com',
                happymod: 'happymod.com',
                an1: 'an1.com',
                androeed: 'androeed.ru',
                '5play': '5play.ru',
                huluxia: 'huluxia.com',
                coolapk: 'coolapk.com',
                ddooo: 'ddooo.com',
                apkpure: 'apkpure.com',
                apkmirror: 'apkmirror.com',
                uptodown: 'uptodown.com',
                // AI
                chatgpt: 'chat.openai.com',
                claude: 'claude.ai',
                gemini: 'gemini.google.com',
                perplexity: 'perplexity.ai',
                copilot: 'copilot.microsoft.com',
                grok: 'x.ai',
                poe: 'poe.com',
                you: 'you.com',
                cursor: 'cursor.sh',
                replit: 'replit.com',
                codeium: 'codeium.com',
                phind: 'phind.com',
                ernie: 'yiyan.baidu.com',
                qianwen: 'tongyi.aliyun.com',
                kimi: 'kimi.moonshot.cn',
                doubao: 'doubao.com',
                deepseek: 'deepseek.com',
                zhipu: 'chatglm.cn',
                midjourney: 'midjourney.com',
                dalle: 'openai.com',
                ideogram: 'ideogram.ai',
                leonardo: 'leonardo.ai',
                // Reverse
                yandexreverse: 'yandex.com',
                googlereverse: 'google.com',
                bingreverse: 'bing.com',
                copyseeker: 'copyseeker.net',
                pimeyes: 'pimeyes.com',
                reversely: 'reversely.ai',
                imgops: 'imgops.com',
                duplichecker: 'duplichecker.com',
                smallseotools: 'smallseotools.com',
                saucenao: 'saucenao.com',
                iqdb: 'iqdb.org',
                trace: 'trace.moe',
                baidureverse: 'baidu.com',
                sogouimage: 'sogou.com',
                '360reverse': 'so.com',
                taobaoimage: 'taobao.com',
                // Discover - Mega Directories
                fmhy: 'fmhy.net',
                rippedguide: 'ripped.guide',
                wotaku: 'wotaku.wiki',
                theindex: 'theindex.moe',
                alternativeto: 'alternativeto.net',
                // Discover - Content Discovery
                producthunt: 'producthunt.com',
                mixcom: 'mix.com',
                flipboard: 'flipboard.com',
                digg: 'digg.com',
                feedly: 'feedly.com',
                hackernews: 'news.ycombinator.com',
                // Discover - Random
                discuvver: 'discuvver.com',
                cloudhiker: 'cloudhiker.net',
                boredbutton: 'boredbutton.com',
                // Discover - AI
                futurepedia: 'futurepedia.io',
                toolify: 'toolify.ai',
                theresanai: 'theresanaiforthat.com',
                // Discover - Design
                awwwards: 'awwwards.com',
                godlywebsite: 'godly.website',
                lapaninja: 'lapa.ninja',
                // Discover - China
                hao123: 'hao123.com',
                '360nav': '360.com',
                '265nav': '265.com',
                '360ai': '360.com',
                uisdc: 'uisdc.com',
                // Discover - Russia
                yandexru: 'yandex.ru',
                dzen: 'dzen.ru',
                vk: 'vk.com',
                '2gis': '2gis.ru',
                // Encyclopedia - Global
                wikipedia: 'wikipedia.org',
                britannica: 'britannica.com',
                scholarpedia: 'scholarpedia.org',
                encyclopedia: 'encyclopedia.com',
                stanfordphil: 'stanford.edu',
                handwiki: 'handwiki.org',
                // Encyclopedia - China
                baidubaike: 'baike.baidu.com',
                zhihu: 'zhihu.com',
                sogoubaike: 'sogou.com',
                '360baike': 'so.com',
                kuaidong: 'baike.com',
                zgbk: 'zgbk.com',
                // Encyclopedia - Russia
                ruwiki: 'ruwiki.ru',
                ruwikipedia: 'wikipedia.org',
                krugosvet: 'krugosvet.ru',
                akademik: 'academic.ru',

                // Vision - Image Description
                chatgptvision: 'openai.com',
                geminivision: 'gemini.google.com',
                claudevision: 'claude.ai',
                llava: 'llava-vl.github.io',
                huggingfacecaption: 'huggingface.co',
                // Vision - Video Storyboard Global
                storyboardhero: 'storyboardhero.ai',
                adobefirefly: 'firefly.adobe.com',
                ltxstudio: 'ltx.studio',
                boords: 'boords.com',
                katalist: 'katalist.ai',
                higgsfield: 'higgsfield.ai',
                // Vision - China
                qwenvl: 'tongyi.aliyun.com',
                glm4v: 'chatglm.cn',
                doubaovision: 'doubao.com',
                deepseekv: 'deepseek.com',
                // Vision - China Storyboard
                kemengai: 'kemeng.com',
                senseseko: 'sensetime.com',
                yiyuanai: 'yiyuanai.com',
                // Vision - Video Caption
                submagic: 'submagic.co',
                captionsai: 'captions.ai',
                veedio: 'veed.io',
                vmakerai: 'vmaker.com'
            };

            function replaceFavicons() {
                document.querySelectorAll('.platform input[data-p]').forEach(input => {
                    const platformKey = input.dataset.p;
                    const domain = FAVICON_DOMAINS[platformKey];
                    if (domain) {
                        const iconSpan = input.parentElement.querySelector('.platform-icon');
                        if (iconSpan) {
                            const img = document.createElement('img');
                            img.src = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                            img.alt = platformKey;
                            img.className = 'platform-icon';
                            img.onerror = () => { img.style.display = 'none'; };
                            iconSpan.replaceWith(img);
                        }
                    }
                });
            }

            replaceFavicons();

            // ========== NEW UX FEATURES ==========

            // Language system
            const TRANSLATIONS = {
                vi: {
                    appTitle: '🎬 Media Search Pro',
                    lblApiKey: '🤖 Gemini API Key',
                    lblGetKey: 'Lấy key miễn phí →',
                    lblEnableAI: 'Bật AI gợi ý thông minh',
                    btnSaveSettings: '💾 Lưu cài đặt',
                    btnExport: '📤 Export',
                    btnImport: '📥 Import',
                    modalTitle: 'Mở nhiều tab',
                    modalText: 'Bạn đang mở {count} trang cùng lúc. Trình duyệt có thể chặn popup.',
                    btnCancel: 'Hủy',
                    btnConfirm: 'Tiếp tục',
                    toastOpening: 'Đang mở {count} trang...',
                    toastSearch: 'Tìm {count} nền tảng...',
                    toastExported: 'Đã export cài đặt!',
                    toastImported: 'Đã import cài đặt!',
                    toastSaved: 'Đã lưu cài đặt!'
                },
                en: {
                    appTitle: '🎬 Media Search Pro',
                    lblApiKey: '🤖 Gemini API Key',
                    lblGetKey: 'Get free key →',
                    lblEnableAI: 'Enable AI smart suggestions',
                    btnSaveSettings: '💾 Save Settings',
                    btnExport: '📤 Export',
                    btnImport: '📥 Import',
                    modalTitle: 'Opening many tabs',
                    modalText: 'You are opening {count} pages at once. Browser may block popups.',
                    btnCancel: 'Cancel',
                    btnConfirm: 'Continue',
                    toastOpening: 'Opening {count} pages...',
                    toastSearch: 'Searching {count} platforms...',
                    toastExported: 'Settings exported!',
                    toastImported: 'Settings imported!',
                    toastSaved: 'Settings saved!'
                }
            };

            let currentLang = localStorage.getItem('lang') || 'vi';

            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('lang', lang);
                autoSyncToDrive();
                document.querySelectorAll('.lang-toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === lang);
                });
                applyTranslations();
            }

            function applyTranslations() {
                const t = TRANSLATIONS[currentLang];
                Object.keys(t).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && !key.includes('toast') && !key.includes('modal')) {
                        el.textContent = t[key];
                    }
                });
            }

            function t(key, replacements = {}) {
                let text = TRANSLATIONS[currentLang][key] || key;
                Object.keys(replacements).forEach(k => {
                    text = text.replace(`{${k}}`, replacements[k]);
                });
                return text;
            }

            // Scroll to Top
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollTopBtn.classList.add('visible');
                } else {
                    scrollTopBtn.classList.remove('visible');
                }
            });

            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Tab Scroll Indicator
            const tabsEl = document.getElementById('tabsContainer');
            const tabsWrapper = document.getElementById('tabsWrapper');

            if (tabsEl && tabsWrapper) {
                tabsEl.addEventListener('scroll', () => {
                    const isAtEnd = tabsEl.scrollLeft + tabsEl.clientWidth >= tabsEl.scrollWidth - 10;
                    tabsWrapper.classList.toggle('scrolled-end', isAtEnd);
                });
            }

            // Batch Warning Modal
            let pendingBatchSearch = null;

            function showBatchWarning(count, callback) {
                document.getElementById('tabCount').textContent = count;
                document.getElementById('modalTitle').textContent = t('modalTitle');
                document.getElementById('modalText').innerHTML = t('modalText', { count });
                document.getElementById('btnCancel').textContent = t('btnCancel');
                document.getElementById('btnConfirm').textContent = t('btnConfirm');
                document.getElementById('batchModal').classList.add('show');
                pendingBatchSearch = callback;
            }

            function closeBatchModal() {
                document.getElementById('batchModal').classList.remove('show');
                pendingBatchSearch = null;
            }

            function confirmBatchOpen() {
                closeBatchModal();
                if (pendingBatchSearch) {
                    pendingBatchSearch();
                }
            }

            // Override search function to add batch warning
            const originalSearch = search;
            search = function () {
                const selected = document.querySelectorAll(`#${currentTab}-tab .platform input:checked`);
                if (selected.length > 10) {
                    showBatchWarning(selected.length, () => originalSearch());
                } else {
                    originalSearch();
                }
            };

            // Rebind search buttons with new search function
            document.getElementById('videoSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('movieSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('imageSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('ebookSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('apkSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('softwareSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('aiSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('reverseSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('discoverSearchBtn').removeEventListener('click', originalSearch);
            document.getElementById('visionSearchBtn').removeEventListener('click', originalSearch);

            document.getElementById('videoSearchBtn').addEventListener('click', search);
            document.getElementById('movieSearchBtn').addEventListener('click', search);
            document.getElementById('imageSearchBtn').addEventListener('click', search);
            document.getElementById('ebookSearchBtn').addEventListener('click', search);
            document.getElementById('apkSearchBtn').addEventListener('click', search);
            document.getElementById('softwareSearchBtn').addEventListener('click', search);
            document.getElementById('aiSearchBtn').addEventListener('click', search);
            document.getElementById('reverseSearchBtn').addEventListener('click', search);
            document.getElementById('discoverSearchBtn').addEventListener('click', search);
            document.getElementById('visionSearchBtn').addEventListener('click', search);

            // Export/Import Settings
            function exportSettings() {
                const settings = {
                    favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
                    apiKey: localStorage.getItem('geminiApiKey') || '',
                    enableAI: localStorage.getItem('enableAI') !== 'false',
                    lang: currentLang,
                    history: JSON.parse(localStorage.getItem('searchHistory') || '[]')
                };
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'media-search-settings.json';
                a.click();
                URL.revokeObjectURL(url);
                toast(t('toastExported'));
            }

            function importSettings() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const settings = JSON.parse(event.target.result);
                            if (settings.favorites) localStorage.setItem('favorites', JSON.stringify(settings.favorites));
                            if (settings.apiKey) localStorage.setItem('geminiApiKey', settings.apiKey);
                            if (settings.enableAI !== undefined) localStorage.setItem('enableAI', settings.enableAI ? 'true' : 'false');
                            if (settings.lang) setLanguage(settings.lang);
                            if (settings.history) localStorage.setItem('searchHistory', JSON.stringify(settings.history));
                            toast(t('toastImported'));
                            location.reload();
                        } catch (err) {
                            toast('Import failed');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            // Favorites
            let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

            function toggleFavorite(platform) {
                const idx = favorites.indexOf(platform);
                if (idx > -1) {
                    favorites.splice(idx, 1);
                } else {
                    favorites.push(platform);
                }
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavoriteStars();
            }

            function updateFavoriteStars() {
                document.querySelectorAll('.fav-star').forEach(star => {
                    const platform = star.dataset.platform;
                    star.classList.toggle('active', favorites.includes(platform));
                    star.textContent = favorites.includes(platform) ? '★' : '☆';
                });
            }

            // Clear All function
            function clearAll(tabId) {
                const tab = document.getElementById(tabId + '-tab');
                if (tab) {
                    tab.querySelectorAll('.platform input:checked').forEach(cb => cb.checked = false);
                    const input = tab.querySelector('.search-input');
                    if (input) input.value = '';
                    updateCount();
                }
            }

            // Initialize on load
            document.addEventListener('DOMContentLoaded', () => {
                // Apply saved language
                const savedLang = localStorage.getItem('lang');
                if (savedLang) {
                    setLanguage(savedLang);
                }
            });

            // ========== DRAG-DROP PLATFORMS ==========
            let draggedPlatform = null;

            function initPlatformDragDrop() {
                document.querySelectorAll('.platforms').forEach(container => {
                    container.querySelectorAll('.platform').forEach(platform => {
                        platform.setAttribute('draggable', 'true');

                        platform.addEventListener('dragstart', e => {
                            // Cancel drag if clicking on the checkbox input itself
                            if (e.target.tagName === 'INPUT') {
                                e.preventDefault();
                                return;
                            }
                            draggedPlatform = platform;
                            platform.classList.add('dragging');
                            e.dataTransfer.effectAllowed = 'move';
                        });

                        platform.addEventListener('dragend', () => {
                            platform.classList.remove('dragging');
                            document.querySelectorAll('.platform.drag-over').forEach(p => p.classList.remove('drag-over'));
                            draggedPlatform = null;
                            savePlatformOrder();
                        });

                        platform.addEventListener('dragover', e => {
                            e.preventDefault();
                            if (draggedPlatform && draggedPlatform !== platform) {
                                platform.classList.add('drag-over');
                            }
                        });

                        platform.addEventListener('dragleave', () => {
                            platform.classList.remove('drag-over');
                        });

                        platform.addEventListener('drop', e => {
                            e.preventDefault();
                            platform.classList.remove('drag-over');
                            if (draggedPlatform && draggedPlatform !== platform) {
                                const container = platform.closest('.platforms');
                                const allPlatforms = [...container.querySelectorAll('.platform')];
                                const draggedIdx = allPlatforms.indexOf(draggedPlatform);
                                const targetIdx = allPlatforms.indexOf(platform);

                                if (draggedIdx < targetIdx) {
                                    platform.after(draggedPlatform);
                                } else {
                                    platform.before(draggedPlatform);
                                }

                                // Save first platform as default homepage for this tab
                                saveFirstPlatformAsDefault();
                            }
                        });
                    });
                });
            }

            // Save first platform of each section as default homepage for the tab
            function saveFirstPlatformAsDefault() {
                const tabId = currentTab + '-tab';
                const tab = document.getElementById(tabId);
                if (!tab) return;

                const firstPlatform = tab.querySelector('.section .platforms .platform input[data-p]');
                if (firstPlatform) {
                    const defaultHomepages = JSON.parse(localStorage.getItem('defaultHomepages') || '{}');
                    defaultHomepages[currentTab] = firstPlatform.dataset.p;
                    localStorage.setItem('defaultHomepages', JSON.stringify(defaultHomepages));
                    autoSyncToDrive();
                }
            }

            // Get default homepage for current tab (first platform)
            function getTabDefaultHomepage() {
                const defaultHomepages = JSON.parse(localStorage.getItem('defaultHomepages') || '{}');
                const defaultPlatformKey = defaultHomepages[currentTab];

                if (defaultPlatformKey && HOMEPAGE_URLS[defaultPlatformKey]) {
                    return HOMEPAGE_URLS[defaultPlatformKey];
                }

                // Fallback: get first platform in the tab
                const tabId = currentTab + '-tab';
                const tab = document.getElementById(tabId);
                if (tab) {
                    const firstPlatform = tab.querySelector('.section .platforms .platform input[data-p]');
                    if (firstPlatform) {
                        return HOMEPAGE_URLS[firstPlatform.dataset.p];
                    }
                }
                return null;
            }

            function savePlatformOrder() {
                const order = {};
                document.querySelectorAll('.tab-content').forEach(tab => {
                    const tabId = tab.id;
                    order[tabId] = [];
                    tab.querySelectorAll('.platforms').forEach((container, sectionIdx) => {
                        order[tabId][sectionIdx] = [];
                        container.querySelectorAll('.platform input[data-p]').forEach(input => {
                            order[tabId][sectionIdx].push(input.dataset.p);
                        });
                    });
                });
                localStorage.setItem('platformOrder', JSON.stringify(order));

                // Auto sync to Drive (debounced)
                autoSyncToDrive();
            }

            function loadPlatformOrder() {
                const saved = localStorage.getItem('platformOrder');
                if (!saved) return;

                try {
                    const order = JSON.parse(saved);
                    Object.keys(order).forEach(tabId => {
                        const tab = document.getElementById(tabId);
                        if (!tab) return;

                        const containers = tab.querySelectorAll('.platforms');
                        order[tabId].forEach((platformKeys, sectionIdx) => {
                            const container = containers[sectionIdx];
                            if (!container) return;

                            platformKeys.forEach(key => {
                                const platform = container.querySelector(`input[data-p="${key}"]`)?.closest('.platform');
                                if (platform) {
                                    container.appendChild(platform);
                                }
                            });
                        });
                    });
                } catch (e) {
                    console.error('Error loading platform order:', e);
                }

                // Keep add-custom buttons at the end
                document.querySelectorAll('.add-custom-btn').forEach(btn => {
                    btn.parentElement.appendChild(btn);
                });
            }

            // ========== CUSTOM SITES ==========
            let customSites = JSON.parse(localStorage.getItem('customSites') || '{}');

            function openAddSiteModal(tabId) {
                document.getElementById('customSiteTab').value = tabId;
                document.getElementById('customSiteName').value = '';
                document.getElementById('customSiteUrl').value = '';
                document.getElementById('customSiteSearch').value = '';
                document.querySelectorAll('#iconPicker .icon-option').forEach((btn, i) => {
                    btn.classList.toggle('selected', i === 0);
                });
                document.getElementById('addSiteModal').classList.add('show');
            }

            function closeAddSiteModal() {
                document.getElementById('addSiteModal').classList.remove('show');
            }

            function submitCustomSite(e) {
                e.preventDefault();

                const tabId = document.getElementById('customSiteTab').value;
                const name = document.getElementById('customSiteName').value.trim();
                const url = document.getElementById('customSiteUrl').value.trim();
                const searchUrl = document.getElementById('customSiteSearch').value.trim();

                if (!name || !url) return;

                // Auto-fetch favicon from URL domain
                let faviconUrl = '';
                try {
                    const domain = new URL(url).hostname;
                    faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                } catch (e) {
                    faviconUrl = '';
                }

                // Generate unique key
                const key = 'custom_' + Date.now();

                // Save to customSites (with favicon URL instead of emoji)
                if (!customSites[tabId]) customSites[tabId] = [];
                customSites[tabId].push({ key, name, url, searchUrl, faviconUrl });
                localStorage.setItem('customSites', JSON.stringify(customSites));

                // Add to DOM
                addCustomSiteToDOM(tabId, { key, name, url, searchUrl, faviconUrl });

                closeAddSiteModal();
                toast('Đã thêm ' + name);
                updateCount();

                // Auto sync to Drive
                autoSyncToDrive();
            }

            function addCustomSiteToDOM(tabId, site) {
                const tab = document.getElementById(tabId);
                if (!tab) return;

                // Find the last platforms container or create one
                let container = tab.querySelector('.platforms');
                if (!container) return;

                // Find or create add-custom button
                let addBtn = container.querySelector('.add-custom-btn');

                const platform = document.createElement('label');
                platform.className = 'platform custom';
                platform.draggable = true;

                // Use favicon URL if available, otherwise fallback to icon emoji or default
                const iconHtml = site.faviconUrl
                    ? `<img class="platform-icon" src="${site.faviconUrl}" onerror="this.outerHTML='🌐'">`
                    : `<span class="platform-icon">${site.icon || '🌐'}</span>`;

                platform.innerHTML = `
                <input type="checkbox" data-p="${site.key}">
                <span class="platform-label">
                    ${iconHtml}${site.name}
                </span>
                <button class="delete-custom" onclick="deleteCustomSite('${tabId}', '${site.key}', event)">×</button>
            `;

                // Add HOMEPAGE_URLS entry
                if (site.url) {
                    HOMEPAGE_URLS[site.key] = site.url;
                }

                // Add search URL if provided
                if (site.searchUrl) {
                    // Add to appropriate URL object based on tab
                    const urlObj = tabId === 'video-tab' ? VIDEO_URLS :
                        tabId === 'movie-tab' ? MOVIE_URLS :
                            tabId === 'image-tab' ? IMAGE_URLS :
                                tabId === 'ebook-tab' ? EBOOK_URLS :
                                    tabId === 'apk-tab' ? APK_URLS : null;
                    if (urlObj) {
                        urlObj[site.key] = q => site.searchUrl.replace('{query}', encodeURIComponent(q));
                    }
                }

                if (addBtn) {
                    addBtn.before(platform);
                } else {
                    container.appendChild(platform);
                }

                // Reinit drag for new element
                initSinglePlatformDrag(platform);

                // Add change listener
                platform.querySelector('input').addEventListener('change', updateCount);
            }

            function initSinglePlatformDrag(platform) {
                platform.setAttribute('draggable', 'true');

                platform.addEventListener('dragstart', e => {
                    draggedPlatform = platform;
                    platform.classList.add('dragging');
                });

                platform.addEventListener('dragend', () => {
                    platform.classList.remove('dragging');
                    draggedPlatform = null;
                    savePlatformOrder();
                });

                platform.addEventListener('dragover', e => {
                    e.preventDefault();
                    if (draggedPlatform && draggedPlatform !== platform) {
                        platform.classList.add('drag-over');
                    }
                });

                platform.addEventListener('dragleave', () => {
                    platform.classList.remove('drag-over');
                });

                platform.addEventListener('drop', e => {
                    e.preventDefault();
                    platform.classList.remove('drag-over');
                    if (draggedPlatform && draggedPlatform !== platform) {
                        const container = platform.closest('.platforms');
                        platform.before(draggedPlatform);
                    }
                });
            }

            function deleteCustomSite(tabId, key, e) {
                e.preventDefault();
                e.stopPropagation();

                if (!confirm('Xóa trang web này?')) return;

                // Remove from customSites
                if (customSites[tabId]) {
                    customSites[tabId] = customSites[tabId].filter(s => s.key !== key);
                    localStorage.setItem('customSites', JSON.stringify(customSites));
                }

                // Remove from DOM
                const platform = document.querySelector(`input[data-p="${key}"]`)?.closest('.platform');
                if (platform) platform.remove();

                toast('Đã xóa');
                updateCount();

                // Auto sync to Drive
                autoSyncToDrive();
            }

            function loadCustomSites() {
                Object.keys(customSites).forEach(tabId => {
                    customSites[tabId].forEach(site => {
                        addCustomSiteToDOM(tabId, site);
                    });
                });
            }

            function addCustomButtonsToAllTabs() {
                const tabs = ['video-tab', 'image-tab', 'ebook-tab', 'apk-tab', 'ai-tab', 'reverse-tab', 'discover-tab', 'vision-tab'];
                tabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (!tab) return;

                    const containers = tab.querySelectorAll('.platforms');
                    containers.forEach(container => {
                        // Check if add button already exists
                        if (container.querySelector('.add-custom-btn')) return;

                        const addBtn = document.createElement('button');
                        addBtn.className = 'add-custom-btn';
                        addBtn.innerHTML = '➕ Thêm';
                        addBtn.onclick = () => openAddSiteModal(tabId);
                        container.appendChild(addBtn);
                    });
                });
            }

            // Icon picker
            document.querySelectorAll('#iconPicker .icon-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#iconPicker .icon-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });

            // ========== GOOGLE DRIVE SYNC (REWRITTEN) ==========
            // Configuration - all in window scope for global access
            (function () {
                'use strict';
                console.log('[GDrive] IIFE starting...');

                // Config constants
                const CONFIG = {
                    CLIENT_ID: '676557816670-38kek48cab0ge88hmsvbo8lcpslp82fv.apps.googleusercontent.com',
                    SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
                    FILE_NAME: 'media-search-pro-settings.json',
                    AUTO_SYNC_DELAY: 3000
                };

                // State
                let accessToken = null;
                let currentUser = null;
                let tokenClient = null;
                let isInitialized = false;
                let autoSyncTimer = null;

                // ===== INITIALIZATION =====
                function init() {
                    console.log('[GDrive] Initializing...');

                    // Check protocol
                    if (location.protocol === 'file:') {
                        console.warn('[GDrive] Cannot run on file:// protocol');
                        updateUI('file-protocol');
                        return;
                    }

                    // Wait for Google Identity Services
                    if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                        console.log('[GDrive] Waiting for Google API...');
                        setTimeout(init, 500);
                        return;
                    }

                    try {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: CONFIG.CLIENT_ID,
                            scope: CONFIG.SCOPES,
                            callback: onTokenResponse,
                            error_callback: onTokenError
                        });

                        isInitialized = true;
                        console.log('[GDrive] Initialized successfully');

                        // Restore session if exists
                        restoreSession();

                    } catch (err) {
                        console.error('[GDrive] Init error:', err);
                        updateUI('init-error', err.message);
                    }
                }

                // ===== SESSION MANAGEMENT =====
                function restoreSession() {
                    const savedToken = localStorage.getItem('gdrive_token');
                    const savedUser = localStorage.getItem('gdrive_user');

                    if (savedToken && savedUser) {
                        accessToken = savedToken;
                        try {
                            currentUser = JSON.parse(savedUser);
                            // Validate token
                            validateToken().then(valid => {
                                if (valid) {
                                    updateUI('signed-in');
                                } else {
                                    clearSession();
                                    updateUI('signed-out');
                                }
                            });
                        } catch (e) {
                            clearSession();
                            updateUI('signed-out');
                        }
                    } else {
                        updateUI('signed-out');
                    }
                }

                async function validateToken() {
                    if (!accessToken) return false;
                    try {
                        const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': 'Bearer ' + accessToken }
                        });
                        return res.ok;
                    } catch (e) {
                        return false;
                    }
                }

                function clearSession() {
                    accessToken = null;
                    currentUser = null;
                    localStorage.removeItem('gdrive_token');
                    localStorage.removeItem('gdrive_user');
                }

                // ===== AUTH CALLBACKS =====
                function onTokenResponse(response) {
                    console.log('[GDrive] Token received');

                    if (response.error) {
                        console.error('[GDrive] Token error:', response);
                        toast('Đăng nhập thất bại: ' + (response.error_description || response.error));
                        updateUI('signed-out');
                        return;
                    }

                    accessToken = response.access_token;
                    localStorage.setItem('gdrive_token', accessToken);

                    // Get user info
                    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    })
                        .then(res => res.json())
                        .then(user => {
                            currentUser = user;
                            localStorage.setItem('gdrive_user', JSON.stringify(user));
                            updateUI('signed-in');
                            toast('✓ Đăng nhập Google thành công!');
                        })
                        .catch(err => {
                            console.error('[GDrive] User info error:', err);
                            toast('Lỗi: ' + err.message);
                        });
                }

                function onTokenError(error) {
                    console.error('[GDrive] Token error callback:', error);

                    let msg = 'Lỗi đăng nhập Google';
                    if (error.type === 'popup_closed') {
                        msg = 'Bạn đã đóng cửa sổ đăng nhập';
                    } else if (error.type === 'popup_blocked') {
                        msg = 'Popup bị chặn. Vui lòng cho phép popup.';
                    }

                    toast(msg);
                    updateUI('signed-out');
                }

                // ===== USER ACTIONS =====
                window.signInGoogle = function () {
                    console.log('[GDrive] Sign in clicked');

                    if (location.protocol === 'file:') {
                        toast('⚠️ Cần chạy qua HTTP Server (localhost)');
                        return;
                    }

                    if (!isInitialized || !tokenClient) {
                        toast('Đang khởi tạo Google API...');
                        init();
                        return;
                    }

                    try {
                        tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (err) {
                        console.error('[GDrive] Request token error:', err);
                        toast('Lỗi: ' + err.message);
                    }
                };

                window.signOutGoogle = function () {
                    console.log('[GDrive] Sign out clicked');

                    if (accessToken && typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                        try {
                            google.accounts.oauth2.revoke(accessToken, () => {
                                console.log('[GDrive] Token revoked');
                            });
                        } catch (e) {
                            console.warn('[GDrive] Revoke error:', e);
                        }
                    }

                    clearSession();
                    updateUI('signed-out');
                    toast('Đã đăng xuất Google');
                };

                window.syncToDrive = async function () {
                    if (!accessToken) {
                        toast('Vui lòng đăng nhập Google trước');
                        return;
                    }

                    const statusEl = document.getElementById('driveStatus');
                    if (statusEl) {
                        statusEl.textContent = '⏳ Đang lưu...';
                        statusEl.className = 'sync-status';
                    }

                    try {
                        const data = collectSyncData();

                        // Find existing file
                        const searchRes = await fetch(
                            `https://www.googleapis.com/drive/v3/files?q=name='${CONFIG.FILE_NAME}'&spaces=drive`,
                            { headers: { 'Authorization': 'Bearer ' + accessToken } }
                        );

                        if (!searchRes.ok) {
                            if (searchRes.status === 401) {
                                clearSession();
                                updateUI('signed-out');
                                toast('Phiên hết hạn, vui lòng đăng nhập lại');
                                return;
                            }
                            throw new Error(`Search failed: ${searchRes.status}`);
                        }

                        const searchData = await searchRes.json();
                        const existingFileId = searchData.files?.[0]?.id;

                        // Prepare upload
                        const metadata = { name: CONFIG.FILE_NAME, mimeType: 'application/json' };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));

                        const uploadUrl = existingFileId
                            ? `https://www.googleapis.com/upload/drive/v3/files/${existingFileId}?uploadType=multipart`
                            : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

                        const uploadRes = await fetch(uploadUrl, {
                            method: existingFileId ? 'PATCH' : 'POST',
                            headers: { 'Authorization': 'Bearer ' + accessToken },
                            body: form
                        });

                        if (!uploadRes.ok) throw new Error(`Upload failed: ${uploadRes.status}`);

                        if (statusEl) {
                            statusEl.textContent = '✓ Đã lưu lên Drive!';
                            statusEl.className = 'sync-status success';
                        }
                        toast('✓ Đã lưu lên Google Drive!');

                    } catch (err) {
                        console.error('[GDrive] Sync to drive error:', err);
                        if (statusEl) {
                            statusEl.textContent = '✗ Lỗi: ' + err.message;
                            statusEl.className = 'sync-status error';
                        }
                        toast('Lỗi: ' + err.message);
                    }
                };

                window.syncFromDrive = async function () {
                    if (!accessToken) {
                        toast('Vui lòng đăng nhập Google trước');
                        return;
                    }

                    const statusEl = document.getElementById('driveStatus');
                    if (statusEl) {
                        statusEl.textContent = '⏳ Đang tải xuống...';
                        statusEl.className = 'sync-status';
                    }

                    try {
                        // Find file
                        const searchRes = await fetch(
                            `https://www.googleapis.com/drive/v3/files?q=name='${CONFIG.FILE_NAME}'&spaces=drive`,
                            { headers: { 'Authorization': 'Bearer ' + accessToken } }
                        );

                        if (!searchRes.ok) {
                            if (searchRes.status === 401) {
                                clearSession();
                                updateUI('signed-out');
                                toast('Phiên hết hạn, vui lòng đăng nhập lại');
                                return;
                            }
                            throw new Error(`Search failed: ${searchRes.status}`);
                        }

                        const searchData = await searchRes.json();
                        if (!searchData.files?.length) {
                            if (statusEl) {
                                statusEl.textContent = 'Không tìm thấy file backup';
                                statusEl.className = 'sync-status error';
                            }
                            return;
                        }

                        // Download file
                        const fileId = searchData.files[0].id;
                        const downloadRes = await fetch(
                            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                            { headers: { 'Authorization': 'Bearer ' + accessToken } }
                        );

                        if (!downloadRes.ok) throw new Error(`Download failed: ${downloadRes.status}`);

                        const data = await downloadRes.json();
                        applySyncData(data);

                        if (statusEl) {
                            statusEl.textContent = '✓ Đã tải xuống! Reloading...';
                            statusEl.className = 'sync-status success';
                        }
                        toast('✓ Đã tải xuống từ Google Drive!');

                        setTimeout(() => location.reload(), 1500);

                    } catch (err) {
                        console.error('[GDrive] Sync from drive error:', err);
                        if (statusEl) {
                            statusEl.textContent = '✗ Lỗi: ' + err.message;
                            statusEl.className = 'sync-status error';
                        }
                        toast('Lỗi: ' + err.message);
                    }
                };

                // ===== DATA HELPERS =====
                function collectSyncData() {
                    return {
                        version: 3,
                        timestamp: new Date().toISOString(),
                        geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                        enableAI: localStorage.getItem('enableAI') || 'true',
                        lang: localStorage.getItem('lang') || 'vi',
                        tabOrder: JSON.parse(localStorage.getItem('tabOrder') || '[]'),
                        platformOrder: JSON.parse(localStorage.getItem('platformOrder') || '{}'),
                        customSites: JSON.parse(localStorage.getItem('customSites') || '{}'),
                        customHomepages: JSON.parse(localStorage.getItem('customHomepages') || '{}'),
                        defaultHomepages: JSON.parse(localStorage.getItem('defaultHomepages') || '{}'),
                        searchHistory: JSON.parse(localStorage.getItem('searchHistory') || '[]'),
                        myTools: JSON.parse(localStorage.getItem('myTools') || '[]'),
                        promptLibrary: JSON.parse(localStorage.getItem('promptLibrary') || '[]'),
                        favorites: JSON.parse(localStorage.getItem('favorites') || '[]')
                    };
                }

                function applySyncData(data) {
                    if (!data) return;

                    const keys = ['geminiApiKey', 'enableAI', 'lang'];
                    keys.forEach(k => {
                        if (data[k] !== undefined) localStorage.setItem(k, data[k]);
                    });

                    const jsonKeys = ['tabOrder', 'platformOrder', 'customSites', 'customHomepages',
                        'defaultHomepages', 'searchHistory', 'myTools', 'promptLibrary', 'favorites'];
                    jsonKeys.forEach(k => {
                        if (data[k]) localStorage.setItem(k, JSON.stringify(data[k]));
                    });
                }

                // Auto-sync when data changes
                window.autoSyncToDrive = function () {
                    if (!accessToken) return;

                    if (autoSyncTimer) clearTimeout(autoSyncTimer);
                    autoSyncTimer = setTimeout(() => {
                        console.log('[GDrive] Auto-syncing...');
                        window.syncToDrive();
                    }, CONFIG.AUTO_SYNC_DELAY);
                };

                // ===== UI UPDATE =====
                function updateUI(state, errorMsg) {
                    const notSignedIn = document.getElementById('driveNotSignedIn');
                    const signedIn = document.getElementById('driveSignedIn');
                    const loginBtn = document.querySelector('[onclick="signInGoogle()"]');
                    const userPhoto = document.getElementById('driveUserPhoto');
                    const userName = document.getElementById('driveUserName');

                    switch (state) {
                        case 'file-protocol':
                            if (notSignedIn) notSignedIn.style.display = 'block';
                            if (signedIn) signedIn.style.display = 'none';
                            if (loginBtn) {
                                loginBtn.innerHTML = '⚠️ Cần HTTP Server';
                                loginBtn.disabled = true;
                                loginBtn.style.opacity = '0.6';
                                loginBtn.title = 'Chạy qua localhost hoặc deploy web';
                            }
                            break;

                        case 'init-error':
                            if (notSignedIn) notSignedIn.style.display = 'block';
                            if (signedIn) signedIn.style.display = 'none';
                            if (loginBtn) {
                                loginBtn.innerHTML = '⚠️ Lỗi: ' + (errorMsg || 'Không thể khởi tạo');
                                loginBtn.disabled = true;
                                loginBtn.style.opacity = '0.6';
                            }
                            break;

                        case 'signed-in':
                            if (notSignedIn) notSignedIn.style.display = 'none';
                            if (signedIn) signedIn.style.display = 'block';
                            if (currentUser) {
                                if (userPhoto && currentUser.picture) {
                                    userPhoto.src = currentUser.picture;
                                    userPhoto.style.display = 'block';
                                }
                                if (userName) {
                                    userName.textContent = currentUser.email || currentUser.name || 'Đã đăng nhập';
                                }
                            }
                            break;

                        case 'signed-out':
                        default:
                            if (notSignedIn) notSignedIn.style.display = 'block';
                            if (signedIn) signedIn.style.display = 'none';
                            if (loginBtn) {
                                loginBtn.innerHTML = '<img src="https://www.google.com/favicon.ico" style="width:14px;height:14px;margin-right:6px;vertical-align:middle;"> Đăng nhập Google';
                                loginBtn.disabled = false;
                                loginBtn.style.opacity = '1';
                            }
                            break;
                    }
                }

                // ===== EXPOSE TO WINDOW FOR LEGACY COMPAT =====
                window.googleAccessToken = null; // For backward compat, updated via getter
                Object.defineProperty(window, 'googleAccessToken', {
                    get: () => accessToken,
                    set: (v) => { accessToken = v; }
                });

                // Initialize on DOM ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', init);
                } else {
                    init();
                }

                // Also init on window load (backup)
                window.addEventListener('load', function () {
                    if (!isInitialized) init();
                });

            })();

            // Initialize all features - ORDER MATTERS!
            // 1. First add custom buttons so containers are ready
            addCustomButtonsToAllTabs();
            // 2. Then load custom sites into DOM
            loadCustomSites();
            // 3. THEN apply saved platform order (after all platforms are in DOM)
            loadPlatformOrder();
            // 4. Finally init drag-drop for all platforms
            initPlatformDragDrop();

            // 5. Update header clock
            function updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const date = now.toLocaleDateString('vi-VN', { weekday: 'short', day: 'numeric', month: 'numeric' });
                document.getElementById('headerClock').textContent = `${date} • ${time}`;
            }
            updateClock();
            setInterval(updateClock, 60000);

            // 6. Formula Cards functions
            function toggleFormulaCards() {
                const cards = document.getElementById('formulaCards');
                const icon = document.getElementById('formulaToggleIcon');
                if (cards.style.display === 'none') {
                    cards.style.display = 'block';
                    icon.textContent = '▲';
                } else {
                    cards.style.display = 'none';
                    icon.textContent = '▼';
                }
            }

            // Recipe presets mapping
            const recipePresets = {
                // Stock Photography
                'business': {
                    style: 'Stock - Business/Corporate',
                    lighting: 'Window Light',
                    composition: 'Medium Shot',
                    mood: 'Professional/Corporate',
                    color: 'Cool/Blue Tones'
                },
                'lifestyle': {
                    style: 'Stock - Lifestyle',
                    lighting: 'Golden Hour',
                    composition: 'Wide Shot',
                    mood: 'Authentic/Candid',
                    color: 'Warm Tones'
                },
                'food': {
                    style: 'Stock - Food',
                    lighting: 'Window Light',
                    composition: 'Overhead Flat Lay',
                    mood: 'Playful/Fun',
                    color: 'Warm Tones'
                },
                'product': {
                    style: 'Stock - Product',
                    lighting: 'High-Key',
                    composition: 'Close-up',
                    mood: 'Minimalist/Clean',
                    color: 'Monochromatic'
                },
                // Vector
                'vector-corporate': {
                    style: 'Vector - Corporate',
                    lighting: '',
                    composition: 'Isometric',
                    mood: 'Professional/Corporate',
                    color: 'Cool/Blue Tones'
                },
                'vector-icon': {
                    style: 'Vector - Icons/UI',
                    lighting: '',
                    composition: '',
                    mood: 'Minimalist/Clean',
                    color: 'Monochromatic'
                },
                'vector-mascot': {
                    style: 'Vector - Character/Mascot',
                    lighting: '',
                    composition: 'Portrait/Centered',
                    mood: 'Playful/Fun',
                    color: 'Vibrant/Saturated'
                },
                'vector-pattern': {
                    style: 'Vector - Pattern/Seamless',
                    lighting: '',
                    composition: '',
                    mood: 'Bold/Vibrant',
                    color: 'Pastel'
                },
                // Backgrounds
                'bg-gradient': {
                    style: 'BG - Gradient',
                    lighting: '',
                    composition: '',
                    mood: 'Dreamy/Ethereal',
                    color: 'Pastel'
                },
                'bg-tech': {
                    style: 'BG - Tech/Futuristic',
                    lighting: 'Neon',
                    composition: '',
                    mood: 'Mysterious/Moody',
                    color: 'Neon/Electric'
                },
                'bg-nature': {
                    style: 'BG - Nature Blur',
                    lighting: 'Golden Hour',
                    composition: '',
                    mood: 'Serene/Peaceful',
                    color: 'Earth Tones'
                },
                'bg-studio': {
                    style: 'BG - Studio/Solid',
                    lighting: 'High-Key',
                    composition: '',
                    mood: 'Minimalist/Clean',
                    color: 'Monochromatic'
                },
                // Trending
                'trend-authentic': {
                    style: 'Trend - Authentic Human',
                    lighting: 'Natural Daylight',
                    composition: 'Rule of Thirds',
                    mood: 'Authentic/Candid',
                    color: 'Muted/Cinematic'
                },
                'trend-hyperreal': {
                    style: 'Trend - Hyperreal AI',
                    lighting: 'Cinematic',
                    composition: 'Close-up',
                    mood: 'Dreamy/Ethereal',
                    color: 'Vibrant/Saturated'
                },
                'trend-y2k': {
                    style: 'Trend - Y2K Revival',
                    lighting: 'Neon',
                    composition: '',
                    mood: 'Nostalgic/Vintage',
                    color: 'Neon/Electric'
                },
                'trend-mixed': {
                    style: 'Trend - Mixed Media',
                    lighting: 'Dramatic',
                    composition: '',
                    mood: 'Bold/Vibrant',
                    color: 'Complementary'
                }
            };

            function applyRecipe(recipeId) {
                const recipe = recipePresets[recipeId];
                if (!recipe) return;

                // Helper to select option by partial text match
                const selectByText = (selectId, searchText) => {
                    if (!searchText) return;
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    for (let opt of select.options) {
                        if (opt.text.includes(searchText) || opt.value.includes(searchText.toLowerCase())) {
                            select.value = opt.value;
                            break;
                        }
                    }
                };

                // Apply recipe values
                selectByText('pbStyle', recipe.style);
                selectByText('pbLighting', recipe.lighting);
                selectByText('pbComposition', recipe.composition);
                selectByText('pbMood', recipe.mood);
                selectByText('pbColorPalette', recipe.color);

                // Update the final prompt
                updateFinalPrompt();

                // Show toast
                toast(`✨ Đã áp dụng công thức: ${recipeId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`);
            }

            // 7. Prompt Builder functions
            function updateFinalPrompt() {
                const subject = document.getElementById('pbSubject').value.trim();
                const details = document.getElementById('pbDetails').value.trim();
                const setting = document.getElementById('pbSetting').value.trim();
                const style = document.getElementById('pbStyle').value;
                const lighting = document.getElementById('pbLighting').value;
                const composition = document.getElementById('pbComposition').value;
                const aspectRatio = document.getElementById('pbAspectRatio').value;
                const mood = document.getElementById('pbMood')?.value || '';
                const colorPalette = document.getElementById('pbColorPalette')?.value || '';

                let parts = [];
                if (subject) parts.push(subject);
                if (details) parts.push(details);
                if (setting) parts.push(setting);
                if (style) parts.push(style);
                if (lighting) parts.push(lighting);
                if (composition) parts.push(composition);
                if (aspectRatio) parts.push(aspectRatio);
                if (mood) parts.push(mood);
                if (colorPalette) parts.push(colorPalette);

                // Build negative prompt
                let negatives = [];
                if (document.getElementById('negText')?.checked) negatives.push('no text', 'no watermark', 'no logo');
                if (document.getElementById('negBlur')?.checked) negatives.push('no blur', 'no artifacts', 'sharp focus');
                if (document.getElementById('negFingers')?.checked) negatives.push('no extra fingers', 'no extra limbs', 'correct anatomy');
                if (document.getElementById('negPlastic')?.checked) negatives.push('no plastic skin', 'natural skin texture', 'realistic');
                if (document.getElementById('negDeformed')?.checked) negatives.push('no deformed faces', 'proper facial features', 'symmetrical face');
                if (document.getElementById('negLowQuality')?.checked) negatives.push('no low quality', 'high resolution', '8K', 'ultra detailed');

                let finalPrompt = parts.join(', ');
                if (negatives.length > 0) {
                    finalPrompt += ' --neg ' + negatives.join(', ');
                }

                document.getElementById('finalPrompt').value = finalPrompt;
            }

            function copyFinalPrompt() {
                const prompt = document.getElementById('finalPrompt').value;
                if (!prompt) {
                    toast('⚠️ Prompt trống!');
                    return;
                }
                navigator.clipboard.writeText(prompt).then(() => {
                    toast('✅ Đã copy prompt!');
                });
            }

            // Update create count when checkboxes change
            document.addEventListener('change', function (e) {
                if (e.target.name === 'aiModelCreate') {
                    const count = document.querySelectorAll('input[name="aiModelCreate"]:checked').length;
                    document.getElementById('createCount').textContent = count;
                }
            });

            function generateAIImage() {
                const prompt = document.getElementById('finalPrompt').value.trim();
                const selectedModels = document.querySelectorAll('.ai-icon-btn.selected');

                if (!prompt) {
                    alert('Vui lòng điền thông tin để tạo prompt!');
                    return;
                }

                if (selectedModels.length === 0) {
                    alert('Vui lòng chọn ít nhất 1 AI model!');
                    return;
                }

                const encodedPrompt = encodeURIComponent(prompt);

                const aiUrls = {
                    'chatgpt-dalle': `https://chat.openai.com/?q=Create an image: ${encodedPrompt}`,
                    'midjourney': 'https://www.midjourney.com/app/',
                    'flux': 'https://flux1.ai/',
                    'ideogram': `https://ideogram.ai/t/explore?q=${encodedPrompt}`,
                    'leonardo': 'https://app.leonardo.ai/ai-generations',
                    'firefly': 'https://firefly.adobe.com/generate/images',
                    'gemini-image': 'https://gemini.google.com/',
                    'stable-diffusion': 'https://stability.ai/stable-image',
                    'keling': 'https://klingai.com/',
                    'jimeng': 'https://jimeng.jianying.com/',
                    'doubao-image': 'https://www.doubao.com/',
                    'tongyi': 'https://tongyi.aliyun.com/wanxiang/',
                    'ernie-vilg': 'https://yiyan.baidu.com/',
                    'aistudio': 'https://aistudio.google.com/prompts/new_chat?model=gemini-3-pro-image-preview',
                    'kittl': 'https://www.kittl.com/create',
                    'recraft': 'https://www.recraft.ai/create',
                    'reve': 'https://reve.art/generate',
                    'freepik-ai': 'https://www.freepik.com/ai/image-generator'
                };

                // Copy prompt to clipboard
                navigator.clipboard.writeText(prompt).then(() => {
                    toast(`✅ Đã copy prompt! Mở ${selectedModels.length} tool...`);
                }).catch(() => { });

                // Open all selected AI tools
                selectedModels.forEach((checkbox, index) => {
                    const url = aiUrls[checkbox.value];
                    setTimeout(() => {
                        window.open(url, '_blank');
                    }, index * 300); // Slight delay between opens
                });
            }

            // 7. AI Assist Function - Smart Presets + Gemini API
            // ATTRACTIVE IMAGE PRINCIPLES:
            // 1. Contrast: Warm subject + Cool background OR Cool subject + Warm background
            // 2. Focal Point: Clear subject with appropriate camera angle
            // 3. Mood Harmony: Lighting should match mood
            // 4. Color Balance: Complementary or harmonious palette

            const SMART_PRESETS = {
                // ==================== STOCK PHOTOGRAPHY ====================
                // Business/Corporate
                business: { style: 'corporate stock photography, professional business setting, modern office, diverse team collaboration, clean composition, commercial license', lighting: 'soft window light, indirect sunlight', composition: 'medium shot, waist up', aspectRatio: '16:9 horizontal landscape format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                corporate: { style: 'corporate stock photography, professional business setting, modern office, diverse team collaboration, clean composition, commercial license', lighting: 'soft window light, indirect sunlight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                office: { style: 'corporate stock photography, professional business setting, modern office, diverse team collaboration, clean composition, commercial license', lighting: 'natural lighting, soft daylight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                meeting: { style: 'corporate stock photography, professional business setting, modern office, diverse team collaboration, clean composition, commercial license', lighting: 'soft window light, indirect sunlight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'professional, corporate, clean, business-appropriate', color: 'muted desaturated colors, film look, cinematic' },

                // Lifestyle
                lifestyle: { style: 'stock photography, authentic lifestyle, natural lighting, diverse subjects, commercial use, editorial quality, candid moment, genuine emotion', lighting: 'golden hour lighting, warm sun', composition: 'rule of thirds, off-center subject', aspectRatio: '4:3 landscape format', mood: 'authentic, candid, genuine emotion, real moment', color: 'warm color palette, golden tones, amber, orange' },
                family: { style: 'stock photography, authentic lifestyle, natural lighting, diverse subjects, commercial use, editorial quality, candid moment, genuine emotion', lighting: 'natural lighting, soft daylight', composition: 'wide shot, full body, environment', aspectRatio: '4:3 landscape format', mood: 'authentic, candid, genuine emotion, real moment', color: 'warm color palette, golden tones, amber, orange' },
                happy: { style: 'stock photography, authentic lifestyle, natural lighting, diverse subjects, commercial use, editorial quality, candid moment, genuine emotion', lighting: 'golden hour lighting, warm sun', composition: 'medium shot, waist up', aspectRatio: '3:4 portrait format', mood: 'playful, fun, cheerful, colorful', color: 'vibrant saturated colors, bold, vivid' },

                // Food
                food: { style: 'food photography, appetizing presentation, overhead flat lay, natural lighting, fresh ingredients, culinary art, food magazine style', lighting: 'soft window light, indirect sunlight', composition: 'overhead flat lay, product arrangement', aspectRatio: '1:1 square format', mood: 'playful, fun, cheerful, colorful', color: 'warm color palette, golden tones, amber, orange' },
                restaurant: { style: 'food photography, appetizing presentation, overhead flat lay, natural lighting, fresh ingredients, culinary art, food magazine style', lighting: 'natural lighting, soft daylight', composition: 'close-up portrait, face detail', aspectRatio: '4:3 landscape format', mood: 'luxury, premium, elegant, high-end', color: 'warm color palette, golden tones, amber, orange' },
                coffee: { style: 'food photography, appetizing presentation, overhead flat lay, natural lighting, fresh ingredients, culinary art, food magazine style', lighting: 'soft window light, indirect sunlight', composition: 'overhead flat lay, product arrangement', aspectRatio: '1:1 square format', mood: 'serene, peaceful, calm, tranquil', color: 'earth tones, natural colors, brown, green, beige' },

                // Product
                product: { style: 'product photography, clean white background, studio lighting, commercial quality, e-commerce ready, sharp focus, professional', lighting: 'high-key lighting, bright, minimal shadows, clean', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'monochromatic, single color scheme, variations' },
                ecommerce: { style: 'product photography, clean white background, studio lighting, commercial quality, e-commerce ready, sharp focus, professional', lighting: 'softbox lighting, diffused, professional portrait', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'monochromatic, single color scheme, variations' },

                // Travel
                travel: { style: 'travel stock photography, destination scenery, wanderlust, vibrant colors, tourism, adventure, landscape, cultural', lighting: 'golden hour lighting, warm sun', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'vibrant saturated colors, bold, vivid' },
                adventure: { style: 'travel stock photography, destination scenery, wanderlust, vibrant colors, tourism, adventure, landscape, cultural', lighting: 'natural lighting, soft daylight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'vibrant saturated colors, bold, vivid' },

                // Technology
                tech: { style: 'technology stock, modern devices, startup environment, digital workspace, screens and gadgets, clean tech aesthetic', lighting: 'professional studio lighting, three-point setup', composition: 'close-up portrait, face detail', aspectRatio: '16:9 horizontal landscape format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                startup: { style: 'technology stock, modern devices, startup environment, digital workspace, screens and gadgets, clean tech aesthetic', lighting: 'natural lighting, soft daylight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'cool color palette, blue tones, teal, cyan' },

                // Healthcare
                healthcare: { style: 'healthcare stock photography, medical professionals, patient care, hospital setting, clinical, compassionate, clean', lighting: 'high-key lighting, bright, minimal shadows, clean', composition: 'medium shot, waist up', aspectRatio: '16:9 horizontal landscape format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                doctor: { style: 'healthcare stock photography, medical professionals, patient care, hospital setting, clinical, compassionate, clean', lighting: 'soft window light, indirect sunlight', composition: 'portrait composition, centered subject', aspectRatio: '3:4 portrait format', mood: 'serene, peaceful, calm, tranquil', color: 'cool color palette, blue tones, teal, cyan' },

                // ==================== VECTOR/ILLUSTRATION ====================
                vector: { style: 'flat vector illustration, clean geometric shapes, bold colors, minimalist design, 2D, scalable, consistent line weight, print-ready', lighting: '', composition: 'isometric view, 3D-like angle, vector style', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'vibrant saturated colors, bold, vivid' },
                flat: { style: 'flat vector illustration, clean geometric shapes, bold colors, minimalist design, 2D, scalable, consistent line weight, print-ready', lighting: '', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'pastel colors, soft muted tones, gentle' },
                isometric: { style: 'isometric vector illustration, 3D-like perspective, clean geometry, modern infographic style, technical precision, soft shadows', lighting: '', composition: 'isometric view, 3D-like angle, vector style', aspectRatio: '1:1 square format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                icon: { style: 'icon design, flat vector icons, consistent style, UI/UX ready, simple shapes, scalable SVG, professional iconography', lighting: '', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'monochromatic, single color scheme, variations' },
                mascot: { style: 'character illustration, cartoon style, mascot design, friendly expression, vibrant colors, scalable vector', lighting: '', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'playful, fun, cheerful, colorful', color: 'vibrant saturated colors, bold, vivid' },
                logo: { style: 'icon design, flat vector icons, consistent style, UI/UX ready, simple shapes, scalable SVG, professional iconography', lighting: '', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'monochromatic, single color scheme, variations' },
                infographic: { style: 'isometric vector illustration, 3D-like perspective, clean geometry, modern infographic style, technical precision, soft shadows', lighting: '', composition: 'isometric view, 3D-like angle, vector style', aspectRatio: '9:16 vertical portrait format', mood: 'professional, corporate, clean, business-appropriate', color: 'cool color palette, blue tones, teal, cyan' },
                pattern: { style: 'seamless pattern design, repeating tile, textile print, geometric or floral, vector pattern, surface design', lighting: '', composition: '', aspectRatio: '1:1 square format', mood: 'bold, vibrant, energetic, dynamic', color: 'pastel colors, soft muted tones, gentle' },

                // ==================== BACKGROUNDS ====================
                background: { style: 'soft gradient background, smooth color transition, abstract, minimalist, suitable for text overlay, clean design', lighting: '', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'pastel colors, soft muted tones, gentle' },
                gradient: { style: 'soft gradient background, smooth color transition, abstract, minimalist, suitable for text overlay, clean design', lighting: '', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'pastel colors, soft muted tones, gentle' },
                texture: { style: 'marble texture background, elegant stone surface, white and gray veins, luxurious, high-resolution, product backdrop', lighting: '', composition: '', aspectRatio: '1:1 square format', mood: 'luxury, premium, elegant, high-end', color: 'monochromatic, single color scheme, variations' },
                marble: { style: 'marble texture background, elegant stone surface, white and gray veins, luxurious, high-resolution, product backdrop', lighting: '', composition: '', aspectRatio: '1:1 square format', mood: 'luxury, premium, elegant, high-end', color: 'monochromatic, single color scheme, variations' },
                bokeh: { style: 'blurred nature background, soft bokeh, green foliage, out of focus, dreamy atmosphere, natural light', lighting: 'golden hour lighting, warm sun', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'earth tones, natural colors, brown, green, beige' },
                nature: { style: 'blurred nature background, soft bokeh, green foliage, out of focus, dreamy atmosphere, natural light', lighting: 'natural lighting, soft daylight', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'serene, peaceful, calm, tranquil', color: 'earth tones, natural colors, brown, green, beige' },
                cyber: { style: 'futuristic tech background, neon lights, cyber grid, dark atmosphere, sci-fi aesthetic, digital matrix', lighting: 'neon lights, colorful glow, cyberpunk', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'mysterious, moody, dark, atmospheric', color: 'neon colors, cyberpunk palette, electric' },
                futuristic: { style: 'futuristic tech background, neon lights, cyber grid, dark atmosphere, sci-fi aesthetic, digital matrix', lighting: 'neon lights, colorful glow, cyberpunk', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'mysterious, moody, dark, atmospheric', color: 'neon colors, cyberpunk palette, electric' },
                abstract: { style: 'abstract geometric background, modern shapes, overlapping forms, bold colors, dynamic composition, contemporary art', lighting: '', composition: '', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'complementary colors, color contrast, dynamic' },

                // ==================== TRENDING 2025-2026 ====================
                authentic: { style: 'authentic human storytelling, genuine emotion, candid documentary style, diverse representation, real moments, unposed, natural imperfections', lighting: 'natural lighting, soft daylight', composition: 'rule of thirds, off-center subject', aspectRatio: '4:3 landscape format', mood: 'authentic, candid, genuine emotion, real moment', color: 'muted desaturated colors, film look, cinematic' },
                hyperreal: { style: 'hyperreal AI photography, surreal details, impossible perfection combined with reality, dreamlike quality, cutting-edge visual', lighting: 'cinematic lighting, movie quality, depth', composition: 'close-up portrait, face detail', aspectRatio: '3:4 portrait format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'vibrant saturated colors, bold, vivid' },
                y2k: { style: 'Y2K aesthetic, early 2000s nostalgia, chrome effects, bubble fonts, digital glitch, retro-futuristic', lighting: 'neon lights, colorful glow, cyberpunk', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'nostalgic, vintage, retro, film grain', color: 'neon colors, cyberpunk palette, electric' },
                retro: { style: 'Y2K aesthetic, early 2000s nostalgia, chrome effects, bubble fonts, digital glitch, retro-futuristic', lighting: 'neon lights, colorful glow, cyberpunk', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'nostalgic, vintage, retro, film grain', color: 'neon colors, cyberpunk palette, electric' },
                'mixed media': { style: 'mixed media collage, layered textures, scanned materials, digital meets analog, experimental composition, artistic fusion', lighting: 'dramatic lighting, strong contrast', composition: '', aspectRatio: '1:1 square format', mood: 'bold, vibrant, energetic, dynamic', color: 'complementary colors, color contrast, dynamic' },
                collage: { style: 'mixed media collage, layered textures, scanned materials, digital meets analog, experimental composition, artistic fusion', lighting: '', composition: '', aspectRatio: '1:1 square format', mood: 'bold, vibrant, energetic, dynamic', color: 'complementary colors, color contrast, dynamic' },
                maximalist: { style: 'maximalist psychedelia, hyper-colorful, intricate patterns, 70s retrofuturism, bold and vibrant, surreal dreamscape', lighting: 'dramatic lighting, strong contrast', composition: 'wide shot, full body, environment', aspectRatio: '1:1 square format', mood: 'bold, vibrant, energetic, dynamic', color: 'vibrant saturated colors, bold, vivid' },

                // ==================== PALEOART (existing enhanced) ====================
                dinosaur: { style: 'dinosaur art, detailed scales and feathers, Mesozoic era, lush prehistoric jungle', lighting: 'natural lighting, soft daylight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'mysterious, moody, dark, atmospheric', color: 'earth tones, natural colors, brown, green, beige' },
                'trex': { style: 'dinosaur art, detailed scales and feathers, Mesozoic era, lush prehistoric jungle', lighting: 'dramatic lighting, strong contrast', composition: 'low angle shot, heroic perspective', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'earth tones, natural colors, brown, green, beige' },
                prehistoric: { style: 'ecological paleoart, ancient ecosystem, prehistoric environment, flora and fauna coexisting', lighting: 'golden hour lighting, warm sun', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'serene, peaceful, calm, tranquil', color: 'earth tones, natural colors, brown, green, beige' },
                mammoth: { style: 'prehistoric mammal art, Ice Age, mammoth, saber-tooth, megafauna, tundra landscape', lighting: 'overcast lighting, soft diffused, no harsh shadows', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'mysterious, moody, dark, atmospheric', color: 'cool color palette, blue tones, teal, cyan' },
                fossil: { style: 'fossil reconstruction art, skeletal anatomy, museum display, scientific diagram', lighting: 'professional studio lighting, three-point setup', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'professional, corporate, clean, business-appropriate', color: 'earth tones, natural colors, brown, green, beige' },

                // ==================== PORTRAIT/PEOPLE (enhanced) ====================
                portrait: { style: 'photorealistic, 8K UHD, ultra-detailed, DSLR quality, shot on Canon EOS R5, 85mm f/1.4 lens, shallow depth of field, natural bokeh, detailed skin texture, visible pores', lighting: 'ring light, beauty lighting, even illumination', composition: 'close-up portrait, face detail', aspectRatio: '3:4 portrait format', mood: 'authentic, candid, genuine emotion, real moment', color: 'warm color palette, golden tones, amber, orange' },
                woman: { style: 'photorealistic, 8K UHD, ultra-detailed, DSLR quality, shot on Canon EOS R5, 85mm f/1.4 lens, shallow depth of field, natural bokeh, detailed skin texture, visible pores', lighting: 'golden hour lighting, warm sun', composition: 'portrait composition, centered subject', aspectRatio: '3:4 portrait format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'warm color palette, golden tones, amber, orange' },
                man: { style: 'photorealistic, 8K UHD, ultra-detailed, DSLR quality, shot on Canon EOS R5, 85mm f/1.4 lens, shallow depth of field, natural bokeh, detailed skin texture, visible pores', lighting: 'natural lighting, soft daylight', composition: 'portrait composition, centered subject', aspectRatio: '3:4 portrait format', mood: 'professional, corporate, clean, business-appropriate', color: 'muted desaturated colors, film look, cinematic' },
                beauty: { style: 'photorealistic, 8K UHD, ultra-detailed, DSLR quality, shot on Canon EOS R5, 85mm f/1.4 lens, shallow depth of field, natural bokeh, detailed skin texture, visible pores', lighting: 'ring light, beauty lighting, even illumination', composition: 'close-up portrait, face detail', aspectRatio: '3:4 portrait format', mood: 'luxury, premium, elegant, high-end', color: 'pastel colors, soft muted tones, gentle' },
                fashion: { style: 'photorealistic, 8K UHD, ultra-detailed, DSLR quality, shot on Canon EOS R5, 85mm f/1.4 lens, shallow depth of field, natural bokeh, detailed skin texture, visible pores', lighting: 'professional studio lighting, three-point setup', composition: 'medium shot, waist up', aspectRatio: '3:4 portrait format', mood: 'bold, vibrant, energetic, dynamic', color: 'complementary colors, color contrast, dynamic' },

                // ==================== LANDSCAPE/NATURE ====================
                landscape: { style: 'landscape photography, golden hour, dramatic sky, wide angle lens, 16K resolution, HDR, vibrant colors, sharp details from foreground to background', lighting: 'golden hour lighting, warm sun', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'serene, peaceful, calm, tranquil', color: 'warm color palette, golden tones, amber, orange' },
                sunset: { style: 'landscape photography, golden hour, dramatic sky, wide angle lens, 16K resolution, HDR, vibrant colors, sharp details from foreground to background', lighting: 'golden hour lighting, warm sun', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'warm color palette, golden tones, amber, orange' },
                ocean: { style: 'landscape photography, golden hour, dramatic sky, wide angle lens, 16K resolution, HDR, vibrant colors, sharp details from foreground to background', lighting: 'blue hour lighting, twilight, cool tones', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'serene, peaceful, calm, tranquil', color: 'cool color palette, blue tones, teal, cyan' },
                mountain: { style: 'landscape photography, golden hour, dramatic sky, wide angle lens, 16K resolution, HDR, vibrant colors, sharp details from foreground to background', lighting: 'natural lighting, soft daylight', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'cool color palette, blue tones, teal, cyan' },

                // ==================== ART STYLES (enhanced) ====================
                anime: { style: 'anime style', lighting: 'high-key lighting, bright, minimal shadows, clean', composition: 'portrait composition, centered subject', aspectRatio: '9:16 vertical portrait format', mood: 'playful, fun, cheerful, colorful', color: 'vibrant saturated colors, bold, vivid' },
                cyberpunk: { style: 'cyberpunk style', lighting: 'neon lights, colorful glow, cyberpunk', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'mysterious, moody, dark, atmospheric', color: 'neon colors, cyberpunk palette, electric' },
                fantasy: { style: 'fantasy art', lighting: 'dramatic lighting, strong contrast', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'vibrant saturated colors, bold, vivid' },
                ghibli: { style: 'Studio Ghibli style', lighting: 'overcast lighting, soft diffused, no harsh shadows', composition: 'wide shot, full body, environment', aspectRatio: '16:9 horizontal landscape format', mood: 'serene, peaceful, calm, tranquil', color: 'pastel colors, soft muted tones, gentle' },
                '3d': { style: '3D render', lighting: 'professional studio lighting, three-point setup', composition: 'portrait composition, centered subject', aspectRatio: '1:1 square format', mood: 'minimalist, clean, simple, uncluttered', color: 'cool color palette, blue tones, teal, cyan' },
                oil: { style: 'oil painting', lighting: 'natural lighting, soft daylight', composition: 'portrait composition, centered subject', aspectRatio: '4:3 landscape format', mood: 'nostalgic, vintage, retro, film grain', color: 'warm color palette, golden tones, amber, orange' },
                watercolor: { style: 'watercolor', lighting: 'overcast lighting, soft diffused, no harsh shadows', composition: 'portrait composition, centered subject', aspectRatio: '4:3 landscape format', mood: 'dreamy, ethereal, soft focus, romantic', color: 'pastel colors, soft muted tones, gentle' },

                // ==================== ANIMALS ====================
                animal: { style: 'wildlife photography, National Geographic style, sharp focus, natural habitat, authentic behavior', lighting: 'natural lighting, soft daylight', composition: 'rule of thirds, off-center subject', aspectRatio: '16:9 horizontal landscape format', mood: 'authentic, candid, genuine emotion, real moment', color: 'earth tones, natural colors, brown, green, beige' },
                wildlife: { style: 'wildlife photography, National Geographic style, sharp focus, natural habitat, authentic behavior', lighting: 'golden hour lighting, warm sun', composition: 'rule of thirds, off-center subject', aspectRatio: '16:9 horizontal landscape format', mood: 'bold, vibrant, energetic, dynamic', color: 'earth tones, natural colors, brown, green, beige' },
                pet: { style: 'pet photography, cute, adorable, studio or outdoor, sharp focus, playful', lighting: 'natural lighting, soft daylight', composition: 'close-up portrait, face detail', aspectRatio: '1:1 square format', mood: 'playful, fun, cheerful, colorful', color: 'warm color palette, golden tones, amber, orange' },
                cat: { style: 'pet photography, cute, adorable, studio or outdoor, sharp focus, playful', lighting: 'soft window light, indirect sunlight', composition: 'close-up portrait, face detail', aspectRatio: '1:1 square format', mood: 'serene, peaceful, calm, tranquil', color: 'warm color palette, golden tones, amber, orange' },
                dog: { style: 'pet photography, cute, adorable, studio or outdoor, sharp focus, playful', lighting: 'natural lighting, soft daylight', composition: 'medium shot, waist up', aspectRatio: '1:1 square format', mood: 'playful, fun, cheerful, colorful', color: 'warm color palette, golden tones, amber, orange' },
            };


            // ========== SUB-TABS NAVIGATION ==========
            function switchCreateSubTab(tabName) {
                // Update button states
                document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                        btn.classList.add('active');
                    }
                });

                // Update content visibility
                document.getElementById('subTabBasic').classList.remove('active');
                document.getElementById('subTabAdvanced').classList.remove('active');
                document.getElementById('subTabTemplates').classList.remove('active');

                if (tabName === 'basic') {
                    document.getElementById('subTabBasic').classList.add('active');
                } else if (tabName === 'advanced') {
                    document.getElementById('subTabAdvanced').classList.add('active');
                } else if (tabName === 'templates') {
                    document.getElementById('subTabTemplates').classList.add('active');
                }
            }


            // ========== AI ICON BUTTONS ==========
            function toggleAiIcon(btn) {
                btn.classList.toggle('selected');
                updateCreateCount();
            }

            function getSelectedAiModels() {
                const selectedBtns = document.querySelectorAll('.ai-icon-btn.selected');
                return Array.from(selectedBtns).map(btn => btn.dataset.ai);
            }

            function updateCreateCount() {
                const count = document.querySelectorAll('.ai-icon-btn.selected').length;
                const countEl = document.getElementById('createCount');
                if (countEl) countEl.textContent = count || 1;
            }


            async function aiAssistFill() {
                const subject = document.getElementById('pbSubject').value.trim().toLowerCase();
                const btn = document.querySelector('.ai-assist-btn');

                if (!subject) {
                    toast('⚠️ Vui lòng nhập chủ thể trước!');
                    return;
                }

                btn.disabled = true;
                btn.textContent = '⏳...';

                // Variation arrays for attractive combinations
                const LIGHTING_VARIATIONS = [
                    'golden hour lighting, warm sun',
                    'natural lighting, soft daylight',
                    'soft window light, indirect sunlight',
                    'cinematic lighting, movie quality, depth',
                    'dramatic lighting, strong contrast',
                    'professional studio lighting, three-point setup',
                    'ring light, beauty lighting, even illumination',
                    'blue hour lighting, twilight, cool tones'
                ];

                const MOOD_VARIATIONS = [
                    'professional, corporate, clean, business-appropriate',
                    'authentic, candid, genuine emotion, real moment',
                    'dreamy, ethereal, soft focus, romantic',
                    'bold, vibrant, energetic, dynamic',
                    'serene, peaceful, calm, tranquil',
                    'playful, fun, cheerful, colorful',
                    'luxury, premium, elegant, high-end',
                    'mysterious, moody, dark, atmospheric'
                ];

                const COLOR_VARIATIONS = [
                    'warm color palette, golden tones, amber, orange',
                    'cool color palette, blue tones, teal, cyan',
                    'pastel colors, soft muted tones, gentle',
                    'vibrant saturated colors, bold, vivid',
                    'muted desaturated colors, film look, cinematic',
                    'earth tones, natural colors, brown, green, beige',
                    'complementary colors, color contrast, dynamic',
                    'monochromatic, single color scheme, variations'
                ];

                const COMPOSITION_VARIATIONS = [
                    'portrait composition, centered subject',
                    'rule of thirds, off-center subject',
                    'close-up portrait, face detail',
                    'medium shot, waist up',
                    'wide shot, full body, environment',
                    'overhead flat lay, product arrangement',
                    'low angle shot, heroic perspective',
                    'isometric view, 3D-like angle, vector style'
                ];

                // Random picker
                const randomPick = (arr) => arr[Math.floor(Math.random() * arr.length)];

                // First try smart presets
                let preset = null;
                for (const [keyword, settings] of Object.entries(SMART_PRESETS)) {
                    if (subject.includes(keyword)) {
                        preset = { ...settings }; // Clone to avoid modifying original
                        break;
                    }
                }

                // Check if Gemini API key is saved
                const geminiApiKey = localStorage.getItem('geminiApiKey');
                const intent = document.getElementById('pbIntent').value.trim();

                if (intent && !geminiApiKey) {
                    toast('⚠️ Để AI phân tích "Ý tưởng", bạn cần nhập API Key (⚙️)!');
                }

                if (geminiApiKey) {
                    // Try Gemini API
                    try {
                        const suggestion = await callGeminiForSuggestion(subject, intent, geminiApiKey);
                        if (suggestion) {
                            applyAISuggestion(suggestion);
                            btn.disabled = false;
                            btn.textContent = '🔄 Khác';
                            btn.title = 'Thử kết hợp khác';
                            return;
                        }
                    } catch (e) {
                        console.error('Gemini API error:', e);
                    }
                }

                // Fallback to smart presets with variations
                if (preset) {
                    // Check if this is a re-click (button already shows 🔄)
                    const isVariation = btn.title && btn.title.includes('kết hợp');

                    if (isVariation) {
                        // Apply random variations for attractive combinations
                        preset.lighting = randomPick(LIGHTING_VARIATIONS);
                        preset.mood = randomPick(MOOD_VARIATIONS);
                        preset.color = randomPick(COLOR_VARIATIONS);
                        // Sometimes vary composition too (50% chance)
                        if (Math.random() > 0.5) {
                            preset.composition = randomPick(COMPOSITION_VARIATIONS);
                        }
                    }

                    applyPreset(preset);
                    toast(isVariation ? '🎲 Đã tạo kết hợp mới!' : '💡 Đã áp dụng gợi ý thông minh!');
                } else {
                    // Default preset with random elements for attractive results
                    applyPreset({
                        style: 'digital art, high quality, detailed',
                        lighting: randomPick(LIGHTING_VARIATIONS),
                        composition: randomPick(COMPOSITION_VARIATIONS),
                        aspectRatio: '1:1 square format',
                        mood: randomPick(MOOD_VARIATIONS),
                        color: randomPick(COLOR_VARIATIONS)
                    });
                    toast('🎲 Đã tạo kết hợp ngẫu nhiên!');
                }

                btn.disabled = false;
                btn.textContent = '🔄 Khác';
                btn.title = 'Thử kết hợp khác';
            }

            function applyPreset(preset) {
                if (preset.style) setSelectByValue('pbStyle', preset.style);
                if (preset.lighting) setSelectByValue('pbLighting', preset.lighting);
                if (preset.composition) setSelectByValue('pbComposition', preset.composition);
                if (preset.aspectRatio) setSelectByValue('pbAspectRatio', preset.aspectRatio);
                if (preset.mood) setSelectByValue('pbMood', preset.mood);
                if (preset.color) setSelectByValue('pbColorPalette', preset.color);
                updateFinalPrompt();
            }

            function setSelectByValue(selectId, value) {
                const select = document.getElementById(selectId);
                if (!value) return;
                const cleanValue = value.toLowerCase().trim();

                // 1. Try exact match first
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value.toLowerCase() === cleanValue) {
                        select.selectedIndex = i;
                        return;
                    }
                }

                // 2. Try fuzzy match (contains)
                let bestMatchIndex = -1;
                let maxOverlap = 0;

                for (let i = 0; i < select.options.length; i++) {
                    const optionVal = select.options[i].value.toLowerCase();
                    // Skip placeholder options
                    if (!optionVal || optionVal.includes('chọn')) continue;

                    if (optionVal.includes(cleanValue) || cleanValue.includes(optionVal)) {
                        // Simple length check for "best" overlap
                        const overlap = Math.min(optionVal.length, cleanValue.length);
                        if (overlap > maxOverlap) {
                            maxOverlap = overlap;
                            bestMatchIndex = i;
                        }
                    }
                }

                if (bestMatchIndex !== -1) {
                    select.selectedIndex = bestMatchIndex;
                }
            }

            function applyAISuggestion(data) {
                // Support both new (Creative Director) and old formats
                const suggestion = data.technical_params || data;

                if (suggestion.details) document.getElementById('pbDetails').value = suggestion.details;
                if (suggestion.setting) document.getElementById('pbSetting').value = suggestion.setting;
                if (suggestion.style) setSelectByValue('pbStyle', suggestion.style);
                if (suggestion.lighting) setSelectByValue('pbLighting', suggestion.lighting);
                if (suggestion.composition) setSelectByValue('pbComposition', suggestion.composition);
                if (suggestion.aspectRatio) setSelectByValue('pbAspectRatio', suggestion.aspectRatio);
                if (suggestion.mood) setSelectByValue('pbMood', suggestion.mood);
                if (suggestion.color) setSelectByValue('pbColorPalette', suggestion.color);

                updateFinalPrompt();

                // Handle Creative Director Features (Analysis & Template)
                if (data.analysis && data.template) {
                    // Copy template to clipboard
                    navigator.clipboard.writeText(data.template).then(() => {
                        toast('📋 Đã copy Template mẫu vào Clipboard!');
                    });

                    // Show Analysis Modal/Alert (Simple formatted string for now)
                    const analysisMsg = `🧠 AI STYLE ANALYSIS:\n\n` +
                        `🎨 Style: ${data.style_name}\n` +
                        `🔎 Phân tích: ${data.analysis}\n\n` +
                        `👉 Template đã được copy! Bạn có thể paste và thay đổi {{subject}} ngay.`;

                    alert(analysisMsg);
                } else {
                    toast(`✨ AI đã gợi ý bố cục hình ảnh thu hút!`);
                }
            }

            async function callGeminiForSuggestion(subject, intent, apiKey) {
                let contextPrompt = "";
                if (intent) {
                    contextPrompt = `\nMỤC ĐÍCH & Ý TƯỞNG CỦA NGƯỜI DÙNG: "${intent}"\nBạn hãy đóng vai trò là một Creative Director/Art Director chuyên nghiệp. Hãy phân tích kỹ mục đích này để đưa ra định hướng nghệ thuật tối ưu nhất (ví dụ: thumbnail phải nổi bật, banner phải hài hòa, ảnh minh họa phải rõ ràng...).`;
                }

                const prompt = `Bạn là một đạo diễn hình ảnh chuyên nghiệp. Hãy phân tích chủ thể và tư duy theo MOOD để tạo ra 1 bức ảnh chất lượng.${contextPrompt}

CHỦ THỂ: "${subject}"

BƯỚC 1 - PHÂN TÍCH: Chủ thể này gợi lên cảm xúc gì? Câu chuyện nào phù hợp? Mood nào sẽ làm nổi bật được chủ thể?

BƯỚC 2 - TƯ DUY MOOD: Chọn 1 mood phù hợp nhất với chủ thể (ví dụ: cinematic, dreamy, dark moody, vintage, epic, intimate, mysterious, joyful...)

BƯỚC 3 - GỢI Ý HOÀN CHỈNH: Dựa trên mood đã chọn, đưa ra các gợi ý ĐỒNG BỘ để tạo ra 1 bức ảnh chất lượng và có hồn.

Trả về JSON duy nhất, không giải thích:
{
  "mood": "mood đã chọn và lý do ngắn gọn (10-20 từ)",
  "details": "chi tiết cụ thể phù hợp với mood: quần áo, biểu cảm, texture, màu sắc (20-40 từ)",
  "setting": "bối cảnh và atmosphere đồng bộ với mood (15-30 từ)",
  "style": "chọn 1 từ: photorealistic 8K UHD DSLR Canon EOS R5 85mm f/1.4 shallow depth of field | digital art | oil painting | anime style | cyberpunk style | fantasy art | Studio Ghibli style | watercolor",
  "lighting": "chọn 1 từ: natural lighting | golden hour lighting | dramatic lighting | soft diffused lighting | neon lights | cinematic lighting | studio lighting | backlit rim lighting",
  "composition": "chọn 1 từ: close-up portrait | wide shot | portrait centered | bird's eye view | low angle shot | rule of thirds | macro shot",
  "aspectRatio": "chọn 1 từ: 1:1 square format | 9:16 vertical portrait format | 16:9 horizontal landscape format | 3:4 portrait format"
}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.9 }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                return null;
            }

            // --- Style Transfer Logic ---
            // --- Style Transfer Logic ---
            function showProcessing(msg) {
                const overlay = document.getElementById('styleProcessingOverlay');
                const text = document.getElementById('styleProcessingText');
                if (overlay && text) {
                    overlay.style.display = 'flex';
                    text.textContent = msg;
                }
            }

            function hideProcessing() {
                const overlay = document.getElementById('styleProcessingOverlay');
                if (overlay) overlay.style.display = 'none';
            }

            function openCopyStyleModal() {
                document.getElementById('copyStyleModal').style.display = 'flex';
            }

            function closeCopyStyleModal() {
                document.getElementById('copyStyleModal').style.display = 'none';
                hideProcessing();
            }

            function switchStyleTab(type) {
                document.querySelectorAll('.style-tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                if (type === 'image') {
                    document.getElementById('styleInputImage').style.display = 'block';
                    document.getElementById('styleInputText').style.display = 'none';
                } else {
                    document.getElementById('styleInputImage').style.display = 'none';
                    document.getElementById('styleInputText').style.display = 'block';
                }
            }

            function previewStyleImage(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    if (file.size > 5 * 1024 * 1024) {
                        alert('⚠️ Ảnh quá lớn (>5MB). Vui lòng chọn ảnh nhỏ hơn để AI xử lý nhanh hơn.');
                        input.value = ''; // Reset input
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('styleImagePreview').src = e.target.result;
                        document.getElementById('styleImagePreview').style.display = 'block';
                        document.getElementById('uploadPlaceholder').style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            }

            async function analyzeAndApplyStyle() {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    alert('⚠️ Vui lòng lưu API Key trong phần Cài đặt (icon ⚙️) trước khi sử dụng tính năng này.');
                    return;
                }

                const btn = document.getElementById('analyzeBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;

                try {
                    showProcessing('Đang khởi tạo...');

                    const isImageTab = document.getElementById('styleInputImage').style.display !== 'none';
                    let prompt = "";
                    let imagePart = null;

                    if (isImageTab) {
                        const fileInput = document.getElementById('styleImageInput');
                        if (!fileInput.files[0]) {
                            hideProcessing();
                            toast('⚠️ Vui lòng chọn ảnh!');
                            throw new Error("Chưa chọn ảnh");
                        }

                        showProcessing('Đang xử lý ảnh (Nén & Mã hóa)...');

                        // Convert file to base64
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(fileInput.files[0]);
                        });

                        imagePart = {
                            inlineData: {
                                data: base64,
                                mimeType: fileInput.files[0].type
                            }
                        };

                        prompt = `ACT AS A WORLD-CLASS AI ART DIRECTOR \u0026 PROMPT ENGINEER.
Your goal is to reverse-engineer the "Style DNA" of this visual concept so a user can recreate it with DIFFERENT subjects.

Analyze the input deeply. Think about:
1. **The "Vibe"**: Is it whimsical, dark, corporate, retro, cinematic?
2. **The Technique**: Is it 3D render, watercolor, vector, thick oil impasto?
3. **The Light**: How does light interact with the subject?
4. **The User's Goal**: They want to make *other* things look like this.

RETURN ONLY A VALID JSON OBJECT (No markdown, no intro):
{
  "style_name": "A short, catchy name for this style (e.g. 'Neon Cyberpunk 3D', 'Vintage Ghibli Watercolor')",
  "analysis": "A concise (2-3 sentences) explanation of what makes this style unique. Explain the key visual elements clearly to the user.",
  "template": "A high-quality, reusable prompt template. Use {{subject}} as a placeholder. Example: 'A cute {{subject}} in the style of 3D Pixar, soft volumetric lighting...'",
  "technical_params": {
      "style": "best matching keyword for Style dropdown (e.g. 3D Render, Anime, Oil Painting...)",
      "lighting": "best matching keyword for Lighting dropdown",
      "composition": "best matching keyword for Composition dropdown",
      "aspectRatio": "estimated aspect ratio (e.g. 16:9, 1:1)",
      "mood": "best matching keyword for Mood dropdown",
      "color": "best matching keyword for Color Palette dropdown",
      "details": "comma separated list of critical technical keywords (e.g. octane render, 8k, bokeh, thick brushstrokes)"
  }
}`;

                    } else {
                        const textInput = document.getElementById('stylePromptInput').value.trim();
                        if (!textInput) {
                            hideProcessing();
                            toast('⚠️ Vui lòng nhập prompt!');
                            throw new Error("Chưa nhập prompt");
                        }

                        showProcessing('Đang phân tích text...');

                        prompt = `ACT AS A WORLD-CLASS AI ART DIRECTOR \u0026 PROMPT ENGINEER.
Your goal is to reverse-engineer the "Style DNA" of this visual concept so a user can recreate it with DIFFERENT subjects.

Analyze the input deeply. Think about:
1. **The "Vibe"**: Is it whimsical, dark, corporate, retro, cinematic?
2. **The Technique**: Is it 3D render, watercolor, vector, thick oil impasto?
3. **The Light**: How does light interact with the subject?
4. **The User's Goal**: They want to make *other* things look like this.

RETURN ONLY A VALID JSON OBJECT (No markdown, no intro):
{
  "style_name": "A short, catchy name for this style (e.g. 'Neon Cyberpunk 3D', 'Vintage Ghibli Watercolor')",
  "analysis": "A concise (2-3 sentences) explanation of what makes this style unique. Explain the key visual elements clearly to the user.",
  "template": "A high-quality, reusable prompt template. Use {{subject}} as a placeholder. Example: 'A cute {{subject}} in the style of 3D Pixar, soft volumetric lighting...'",
  "technical_params": {
      "style": "best matching keyword for Style dropdown (e.g. 3D Render, Anime, Oil Painting...)",
      "lighting": "best matching keyword for Lighting dropdown",
      "composition": "best matching keyword for Composition dropdown",
      "aspectRatio": "estimated aspect ratio (e.g. 16:9, 1:1)",
      "mood": "best matching keyword for Mood dropdown",
      "color": "best matching keyword for Color Palette dropdown",
      "details": "comma separated list of critical technical keywords (e.g. octane render, 8k, bokeh, thick brushstrokes)"
  }
}`;
                    }

                    showProcessing('Đang gửi tới Gemini AI (Vision)...');

                    // Call Gemini (using 2.0-flash as used in other parts of the app)
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const parts = [{
                        text: prompt
                    }];
                    if (imagePart) parts.push(imagePart);

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: parts
                            }],
                            generationConfig: {
                                temperature: 0.4
                            } // Low temperature for factual extraction
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || response.statusText);
                    }

                    showProcessing('AI đang phân tích style...');
                    const data = await response.json();

                    let resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!resultText) throw new Error("AI không trả về kết quả.");

                    // Clean markdown if present
                    resultText = resultText.replace(/```json/g, '').replace(/```/g, '').trim();

                    showProcessing('Đang áp dụng style...');
                    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                    const analysis = jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(resultText);

                    // Apply results
                    applyAISuggestion(analysis);

                    hideProcessing();
                    closeCopyStyleModal();
                    toast('✅ Đã Copy Style thành công!');
                    // Auto scroll to prompt builder
                    document.querySelector('.prompt-builder').scrollIntoView({
                        behavior: 'smooth'
                    });

                } catch (error) {
                    console.error("Analysis Error:", error);
                    hideProcessing();

                    if (error.message.includes("429") || error.message.includes("Resource exhausted")) {
                        alert('⏳ Server đang bận (429 Too Many Requests).\n\nAPI miễn phí có giới hạn số lần gọi trong 1 phút.\nVui lòng đợi khoảng 30-60 giây rồi thử lại!');
                    } else {
                        alert('❌ Lỗi xử lý: ' + error.message + '\n\n(Vui lòng kiểm tra lại API Key hoặc kết nối mạng)');
                    }
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }


            // 8. Gemini API Key Management
            function saveGeminiApiKey(key) {
                if (key && key.trim()) {
                    localStorage.setItem('geminiApiKey', key.trim());
                    toast('✅ API key đã lưu!');
                } else {
                    localStorage.removeItem('geminiApiKey');
                    toast('🗑️ API key đã xóa!');
                }
                autoSyncToDrive();
            }

            function toggleApiKeyVisibility() {
                const input = document.getElementById('geminiApiKeyInput');
                const btn = document.querySelector('.toggle-key-btn');
                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = '🙈';
                } else {
                    input.type = 'password';
                    btn.textContent = '👁️';
                }
            }

            function toggleModalKeyVisibility() {
                const input = document.getElementById('modalApiKeyInput');
                const btn = input.parentElement.querySelector('.toggle-key-btn');
                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = '🙈';
                } else {
                    input.type = 'password';
                    btn.textContent = '👁️';
                }
            }

            // Load saved API key on page load
            (function loadSavedApiKey() {
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    const input = document.getElementById('geminiApiKeyInput');
                    if (input) input.value = savedKey;
                }
            })();

            // 9. API Key Modal Management
            function showApiKeyModal() {
                document.getElementById('apiKeyModal').style.display = 'flex';
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    document.getElementById('modalApiKeyInput').value = savedKey;
                }
            }

            function hideApiKeyModal() {
                document.getElementById('apiKeyModal').style.display = 'none';
            }

            function saveApiKeyFromModal() {
                const key = document.getElementById('modalApiKeyInput').value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    autoSyncToDrive();
                    updateApiStatusBadge(true);
                    hideApiKeyModal();
                    toast('✅ API key đã lưu!');
                } else {
                    toast('⚠️ Vui lòng nhập API key!');
                }
            }

            function removeApiKey() {
                localStorage.removeItem('geminiApiKey');
                document.getElementById('modalApiKeyInput').value = '';
                updateApiStatusBadge(false);
                hideApiKeyModal();
                toast('🗑️ API key đã xóa!');
            }

            function updateApiStatusBadge(connected) {
                const badge = document.getElementById('apiStatusBadge');
                if (connected) {
                    badge.className = 'api-status-badge connected';
                    badge.innerHTML = '<span class="status-icon">✅</span><span class="status-text">AI</span>';
                } else {
                    badge.className = 'api-status-badge disconnected';
                    badge.innerHTML = '<span class="status-icon">❌</span><span class="status-text">AI</span>';
                }
            }

            // Check API key on load and show modal if not set
            (function initApiKeyCheck() {
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    updateApiStatusBadge(true);
                } else {
                    // Show modal on first visit to Create tab
                    setTimeout(() => {
                        if (document.getElementById('create-tab').classList.contains('active')) {
                            showApiKeyModal();
                        }
                    }, 500);
                }
            })();

            // ========== PLATFORM CONTEXT MENU & HOMEPAGE EDITING ==========
            let selectedPlatformKey = null;
            const customHomepages = JSON.parse(localStorage.getItem('customHomepages') || '{}');

            // Right-click on platform to show context menu
            document.addEventListener('contextmenu', e => {
                const platform = e.target.closest('.platform');
                if (platform) {
                    e.preventDefault();
                    const checkbox = platform.querySelector('input[data-p]');
                    if (checkbox) {
                        selectedPlatformKey = checkbox.dataset.p;
                        const menu = document.getElementById('platformContextMenu');
                        menu.style.left = e.pageX + 'px';
                        menu.style.top = e.pageY + 'px';
                        menu.classList.add('show');
                    }
                }
            });

            // Hide context menu on click elsewhere
            document.addEventListener('click', e => {
                const menu = document.getElementById('platformContextMenu');
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });

            function editPlatformHomepage() {
                document.getElementById('platformContextMenu').classList.remove('show');
                if (!selectedPlatformKey) return;

                const currentUrl = customHomepages[selectedPlatformKey] || HOMEPAGE_URLS[selectedPlatformKey] || '';
                document.getElementById('editPlatformName').textContent = selectedPlatformKey;
                document.getElementById('editHomepageUrl').value = currentUrl;
                document.getElementById('editHomepageModal').classList.add('show');
            }

            function openPlatformHomepage() {
                document.getElementById('platformContextMenu').classList.remove('show');
                if (!selectedPlatformKey) return;

                const url = customHomepages[selectedPlatformKey] || HOMEPAGE_URLS[selectedPlatformKey];
                if (url) window.open(url, '_blank');
            }

            function resetPlatformHomepage() {
                document.getElementById('platformContextMenu').classList.remove('show');
                if (!selectedPlatformKey) return;

                delete customHomepages[selectedPlatformKey];
                localStorage.setItem('customHomepages', JSON.stringify(customHomepages));
                autoSyncToDrive();
                toast('🔄 Đã đặt lại mặc định cho ' + selectedPlatformKey);
            }

            function closeEditHomepageModal() {
                document.getElementById('editHomepageModal').classList.remove('show');
            }

            function saveHomepageUrl() {
                const url = document.getElementById('editHomepageUrl').value.trim();
                if (!url) {
                    toast('⚠️ Vui lòng nhập URL!');
                    return;
                }

                customHomepages[selectedPlatformKey] = url;
                localStorage.setItem('customHomepages', JSON.stringify(customHomepages));
                autoSyncToDrive();

                // Also update HOMEPAGE_URLS for current session
                HOMEPAGE_URLS[selectedPlatformKey] = url;

                closeEditHomepageModal();
                toast('✅ Đã lưu homepage cho ' + selectedPlatformKey);
            }

            // Load custom homepages on startup
            Object.keys(customHomepages).forEach(key => {
                HOMEPAGE_URLS[key] = customHomepages[key];
            });

            // ========== WIKIPEDIA PREVIEW ==========
            let currentWikiLang = 'vi';
            let currentWikiQuery = '';
            let availableWikiLangs = [];

            const WIKI_LANGUAGES = {
                vi: { name: 'Tiếng Việt', flag: '🇻🇳' },
                en: { name: 'English', flag: '🇬🇧' },
                zh: { name: '中文', flag: '🇨🇳' },
                ru: { name: 'Русский', flag: '🇷🇺' },
                ja: { name: '日本語', flag: '🇯🇵' },
                ko: { name: '한국어', flag: '🇰🇷' },
                fr: { name: 'Français', flag: '🇫🇷' },
                de: { name: 'Deutsch', flag: '🇩🇪' },
                es: { name: 'Español', flag: '🇪🇸' },
                pt: { name: 'Português', flag: '🇵🇹' },
                ar: { name: 'العربية', flag: '🇸🇦' },
                th: { name: 'ไทย', flag: '🇹🇭' },
                id: { name: 'Indonesia', flag: '🇮🇩' },
                it: { name: 'Italiano', flag: '🇮🇹' },
                pl: { name: 'Polski', flag: '🇵🇱' },
                nl: { name: 'Nederlands', flag: '🇳🇱' },
                uk: { name: 'Українська', flag: '🇺🇦' },
                fa: { name: 'فارسی', flag: '🇮🇷' },
                hi: { name: 'हिन्दी', flag: '🇮🇳' }
            };

            async function previewWikipedia(lang = 'vi') {
                const query = document.getElementById('wikiInput').value.trim();
                if (!query) {
                    toast('Nhập từ khóa để preview Wikipedia');
                    return;
                }

                currentWikiLang = lang;
                currentWikiQuery = query;

                const container = document.getElementById('wikiPreviewResult');
                const loading = document.getElementById('wikiLoading');
                const content = document.getElementById('wikiPreviewContent');

                container.style.display = 'block';
                loading.style.display = 'flex';
                content.innerHTML = '';

                try {
                    // First fetch content
                    const data = await fetchWikipediaContent(query, lang);

                    if (data) {
                        // Now fetch languages using the ACTUAL page title
                        const langs = await fetchAvailableLanguages(data.title, lang);
                        availableWikiLangs = langs || [];

                        loading.style.display = 'none';
                        const langInfo = WIKI_LANGUAGES[lang] || { name: lang, flag: '🌐' };
                        const langCount = availableWikiLangs.length;

                        content.innerHTML = `
                        <div class="wiki-article">
                            <div class="wiki-article-header">
                                <h2 class="wiki-article-title">${data.title}</h2>
                                <div class="wiki-header-actions">
                                    <div class="wiki-lang-selector">
                                        <button class="wiki-lang-btn" onclick="toggleLangDropdown()">
                                            ${langInfo.flag} ${langCount > 0 ? langCount + ' ngôn ngữ' : 'Ngôn ngữ'} ▾
                                        </button>
                                        <div class="wiki-lang-dropdown" id="wikiLangDropdown">
                                            <div class="wiki-lang-search">
                                                <input type="text" placeholder="Tìm ngôn ngữ..." oninput="filterWikiLangs(this.value)">
                                            </div>
                                            <div class="wiki-lang-list" id="wikiLangList"></div>
                                        </div>
                                    </div>
                                    <a href="https://${lang}.wikipedia.org/wiki/${encodeURIComponent(data.title)}" target="_blank" class="wiki-open-link">🔗 Mở</a>
                                </div>
                            </div>
                            <div class="wiki-article-body">${data.html}</div>
                            <div class="wiki-article-footer">
                                <button class="wiki-btn" onclick="copyToClipboard(document.querySelector('.wiki-article-body').innerText.substring(0,2000))">📋 Copy</button>
                                <button class="wiki-btn" onclick="speakText(document.querySelector('.wiki-article-body').innerText.substring(0,1000))">🔊 Đọc</button>
                                <button class="wiki-btn primary" onclick="window.open('https://${lang}.wikipedia.org/wiki/${encodeURIComponent(data.title)}', '_blank')">📖 Xem đầy đủ</button>
                            </div>
                        </div>
                    `;

                        // Populate language list
                        renderWikiLangList();
                    } else {
                        loading.style.display = 'none';
                        content.innerHTML = `
                        <div class="wiki-no-results">
                            <div style="font-size:3rem;margin-bottom:1rem;">🔍</div>
                            <p>Không tìm thấy "<strong>${escapeHtml(query)}</strong>"</p>
                            <button class="wiki-btn primary" style="margin-top:1rem;" onclick="window.open('https://${lang}.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(query)}', '_blank')">🔍 Tìm trên Wikipedia</button>
                        </div>
                    `;
                    }
                } catch (error) {
                    loading.style.display = 'none';
                    content.innerHTML = `<div class="wiki-no-results"><p>⚠️ Lỗi kết nối Wikipedia</p></div>`;
                }
            }

            function toggleLangDropdown() {
                const dropdown = document.getElementById('wikiLangDropdown');
                dropdown.classList.toggle('show');
            }

            function renderWikiLangList(filter = '') {
                const list = document.getElementById('wikiLangList');
                if (!list) return;

                let html = '';
                const filterLower = filter.toLowerCase();

                // Current language first
                const currentLangInfo = WIKI_LANGUAGES[currentWikiLang] || { name: currentWikiLang, flag: '🌐' };
                html += `<div class="wiki-lang-item active">${currentLangInfo.flag} ${currentLangInfo.name}</div>`;

                // Available languages
                availableWikiLangs.forEach(lang => {
                    if (lang.code === currentWikiLang) return;
                    const info = WIKI_LANGUAGES[lang.code] || { name: lang.name, flag: '🌐' };
                    const name = info.name || lang.name;
                    if (filterLower && !name.toLowerCase().includes(filterLower) && !lang.code.includes(filterLower)) return;
                    html += `<div class="wiki-lang-item" onclick="switchWikiLang('${lang.code}', '${lang.title.replace(/'/g, "\\'")}')">${info.flag} ${name}</div>`;
                });

                list.innerHTML = html;
            }

            function filterWikiLangs(filter) {
                renderWikiLangList(filter);
            }

            async function switchWikiLang(langCode, pageTitle) {
                document.getElementById('wikiLangDropdown').classList.remove('show');

                const loading = document.getElementById('wikiLoading');
                const content = document.getElementById('wikiPreviewContent');

                loading.style.display = 'flex';
                content.innerHTML = '';

                try {
                    const data = await fetchWikipediaContentByTitle(pageTitle, langCode);
                    loading.style.display = 'none';
                    currentWikiLang = langCode;

                    if (data) {
                        const langInfo = WIKI_LANGUAGES[langCode] || { name: langCode, flag: '🌐' };
                        const langCount = availableWikiLangs.length;

                        content.innerHTML = `
                        <div class="wiki-article">
                            <div class="wiki-article-header">
                                <h2 class="wiki-article-title">${data.title}</h2>
                                <div class="wiki-header-actions">
                                    <div class="wiki-lang-selector">
                                        <button class="wiki-lang-btn" onclick="toggleLangDropdown()">
                                            ${langInfo.flag} ${langCount} ngôn ngữ ▾
                                        </button>
                                        <div class="wiki-lang-dropdown" id="wikiLangDropdown">
                                            <div class="wiki-lang-search">
                                                <input type="text" placeholder="Tìm ngôn ngữ..." oninput="filterWikiLangs(this.value)">
                                            </div>
                                            <div class="wiki-lang-list" id="wikiLangList"></div>
                                        </div>
                                    </div>
                                    <a href="https://${langCode}.wikipedia.org/wiki/${encodeURIComponent(data.title)}" target="_blank" class="wiki-open-link">🔗 Mở</a>
                                </div>
                            </div>
                            <div class="wiki-article-body">${data.html}</div>
                            <div class="wiki-article-footer">
                                <button class="wiki-btn" onclick="copyToClipboard(document.querySelector('.wiki-article-body').innerText.substring(0,2000))">📋 Copy</button>
                                <button class="wiki-btn" onclick="speakText(document.querySelector('.wiki-article-body').innerText.substring(0,1000))">🔊 Đọc</button>
                                <button class="wiki-btn primary" onclick="window.open('https://${langCode}.wikipedia.org/wiki/${encodeURIComponent(data.title)}', '_blank')">📖 Xem đầy đủ</button>
                            </div>
                        </div>
                    `;
                        renderWikiLangList();
                    }
                } catch (error) {
                    loading.style.display = 'none';
                    content.innerHTML = `<div class="wiki-no-results"><p>⚠️ Lỗi tải ngôn ngữ</p></div>`;
                }
            }

            async function fetchAvailableLanguages(query, lang) {
                try {
                    const url = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(query)}&prop=langlinks&lllimit=500&format=json&origin=*`;
                    const response = await fetch(url);
                    const data = await response.json();
                    const pages = data.query?.pages;
                    if (pages) {
                        const pageId = Object.keys(pages)[0];
                        const langlinks = pages[pageId]?.langlinks || [];
                        return langlinks.map(l => ({ code: l.lang, name: l.langname || l.lang, title: l['*'] }));
                    }
                } catch (e) { }
                return [];
            }

            async function fetchWikipediaContent(query, lang = 'vi') {
                const parseUrl = `https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(query)}&format=json&origin=*&prop=text`;
                let response = await fetch(parseUrl);
                let data = await response.json();

                if (data.error) {
                    const searchUrl = `https://${lang}.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=1&format=json&origin=*`;
                    const searchResponse = await fetch(searchUrl);
                    const searchData = await searchResponse.json();
                    if (searchData[1] && searchData[1].length > 0) {
                        const retryUrl = `https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(searchData[1][0])}&format=json&origin=*&prop=text`;
                        response = await fetch(retryUrl);
                        data = await response.json();
                    } else { return null; }
                }
                if (!data.parse) return null;

                let html = data.parse.text['*'];
                html = html.replace(/<span class="mw-editsection">[\s\S]*?<\/span>/g, '');
                html = html.replace(/href="\/wiki\//g, `href="https://${lang}.wikipedia.org/wiki/`);
                html = html.replace(/src="\/\//g, 'src="https://');
                return { title: data.parse.title, html: html };
            }

            async function fetchWikipediaContentByTitle(title, lang) {
                const parseUrl = `https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&format=json&origin=*&prop=text`;
                const response = await fetch(parseUrl);
                const data = await response.json();
                if (!data.parse) return null;

                let html = data.parse.text['*'];
                html = html.replace(/<span class="mw-editsection">[\s\S]*?<\/span>/g, '');
                html = html.replace(/href="\/wiki\//g, `href="https://${lang}.wikipedia.org/wiki/`);
                html = html.replace(/src="\/\//g, 'src="https://');
                return { title: data.parse.title, html: html };
            }

            function escapeQuotes(str) { return str.replace(/'/g, "\\'").replace(/"/g, '\\"'); }
            function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => toast('📋 Đã copy!')); }
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = currentWikiLang === 'vi' ? 'vi-VN' : currentWikiLang;
                    u.rate = 0.9;
                    speechSynthesis.speak(u);
                    toast('🔊 Đang đọc...');
                }
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', e => {
                const dropdown = document.getElementById('wikiLangDropdown');
                if (dropdown && !e.target.closest('.wiki-lang-selector')) {
                    dropdown.classList.remove('show');
                }
            });

            // ========== MY TOOL TAB ==========
            let myTools = JSON.parse(localStorage.getItem('myTools') || '[]');
            let editingToolIndex = -1;

            function renderMyTools(filter = '') {
                const list = document.getElementById('mytoolList');
                const filterLower = filter.toLowerCase();

                const filtered = myTools.filter(t =>
                    !filterLower || t.name.toLowerCase().includes(filterLower) || t.url.toLowerCase().includes(filterLower)
                );

                if (filtered.length === 0) {
                    list.innerHTML = '<div class="mytool-empty">Chưa có công cụ nào. Thêm công cụ mới ở trên! 👆</div>';
                    return;
                }

                list.innerHTML = filtered.map((tool, i) => {
                    const realIndex = myTools.indexOf(tool);
                    return `
                    <div class="mytool-item" onclick="openMyTool(${realIndex})" title="${tool.url}">
                        <span class="mytool-icon">${tool.icon || '🔧'}</span>
                        <span class="mytool-name">${tool.name}</span>
                        <div class="mytool-actions">
                            <button class="mytool-action-btn" onclick="event.stopPropagation();editMyTool(${realIndex})" title="Sửa">✏️</button>
                            <button class="mytool-action-btn delete" onclick="event.stopPropagation();deleteMyTool(${realIndex})" title="Xóa">🗑️</button>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function addMyTool() {
                const nameInput = document.getElementById('mytoolName');
                const urlInput = document.getElementById('mytoolUrl');
                const iconInput = document.getElementById('mytoolIcon');

                const name = nameInput.value.trim();
                const url = urlInput.value.trim();
                const icon = iconInput.value.trim() || '🔧';

                if (!name || !url) {
                    toast('⚠️ Nhập tên và URL');
                    return;
                }

                if (!url.startsWith('http')) {
                    toast('⚠️ URL phải bắt đầu bằng http:// hoặc https://');
                    return;
                }

                if (editingToolIndex >= 0) {
                    // Edit mode
                    myTools[editingToolIndex] = { name, url, icon };
                    editingToolIndex = -1;
                    document.getElementById('btnCancelEdit').style.display = 'none';
                    document.querySelector('.btn-add-tool').textContent = '➕ Thêm mới';
                    toast('✅ Đã cập nhật công cụ');
                } else {
                    // Add mode
                    myTools.push({ name, url, icon });
                    toast('✅ Đã thêm công cụ');
                }

                localStorage.setItem('myTools', JSON.stringify(myTools));
                autoSyncToDrive();
                nameInput.value = '';
                urlInput.value = '';
                iconInput.value = '';
                renderMyTools();
            }

            function editMyTool(index) {
                const tool = myTools[index];
                document.getElementById('mytoolName').value = tool.name;
                document.getElementById('mytoolUrl').value = tool.url;
                document.getElementById('mytoolIcon').value = tool.icon || '';
                editingToolIndex = index;
                document.getElementById('btnCancelEdit').style.display = 'inline-block';
                document.querySelector('.btn-add-tool').textContent = '💾 Lưu thay đổi';
                document.getElementById('mytoolName').focus();
            }

            function cancelEditTool() {
                editingToolIndex = -1;
                document.getElementById('mytoolName').value = '';
                document.getElementById('mytoolUrl').value = '';
                document.getElementById('mytoolIcon').value = '';
                document.getElementById('btnCancelEdit').style.display = 'none';
                document.querySelector('.btn-add-tool').textContent = '➕ Thêm mới';
            }

            function deleteMyTool(index) {
                if (confirm('Xóa công cụ "' + myTools[index].name + '"?')) {
                    myTools.splice(index, 1);
                    localStorage.setItem('myTools', JSON.stringify(myTools));
                    autoSyncToDrive();
                    renderMyTools();
                    toast('🗑️ Đã xóa');
                }
            }

            function openMyTool(index) {
                const tool = myTools[index];
                window.open(tool.url, '_blank');
            }

            function filterMyTools(value) {
                renderMyTools(value);
            }

            // Render on page load
            document.addEventListener('DOMContentLoaded', () => {
                renderMyTools();
                renderPrompts();
            });

            // ========== PROMPT MANAGER ==========
            let prompts = JSON.parse(localStorage.getItem('promptLibrary') || '[]');
            let editingPromptIndex = -1;

            function renderPrompts() {
                const list = document.getElementById('promptList');
                const countEl = document.getElementById('promptCount');
                const searchVal = document.getElementById('promptSearch')?.value?.toLowerCase() || '';
                const categoryFilter = document.getElementById('promptCategoryFilter')?.value || '';
                const workflowFilter = document.getElementById('promptWorkflowFilter')?.value || '';
                const copyBtn = document.getElementById('btnCopyWorkflow');

                // Update workflow filter dropdown options
                updateWorkflowDropdown();

                // Show/hide Copy All Steps button
                copyBtn.style.display = workflowFilter ? 'inline-block' : 'none';

                let filtered = prompts.filter(p => {
                    const matchSearch = !searchVal ||
                        p.name.toLowerCase().includes(searchVal) ||
                        p.content.toLowerCase().includes(searchVal) ||
                        (p.tags && p.tags.some(t => t.toLowerCase().includes(searchVal))) ||
                        (p.workflow && p.workflow.toLowerCase().includes(searchVal));
                    const matchCategory = !categoryFilter || p.category === categoryFilter;
                    const matchWorkflow = !workflowFilter || p.workflow === workflowFilter;
                    return matchSearch && matchCategory && matchWorkflow;
                });

                // Sort by step if filtering by workflow
                if (workflowFilter) {
                    filtered.sort((a, b) => (a.step || 999) - (b.step || 999));
                }

                countEl.textContent = `${filtered.length} prompts`;

                if (filtered.length === 0) {
                    list.innerHTML = '<div class="prompt-empty">Chưa có prompt nào. Thêm prompt mới ở trên! 👆</div>';
                    return;
                }

                list.innerHTML = filtered.map((p, i) => {
                    const realIndex = prompts.indexOf(p);
                    const contentHtml = escapeHtml(p.content).replace(/\{\{(\w+)\}\}/g, '<span class="variable">{{$1}}</span>');
                    const tagsHtml = p.tags && p.tags.length ?
                        p.tags.map(t => `<span class="prompt-tag">#${t}</span>`).join('') : '';
                    const noteHtml = p.note ? `<div class="prompt-item-note">💡 ${escapeHtml(p.note)}</div>` : '';

                    // Format timestamp
                    const timestamp = p.createdAt ? formatTimestamp(p.createdAt) : '';

                    // Build meta line with timestamp and workflow only
                    let metaHtml = '<div class="prompt-item-meta">';
                    if (timestamp) {
                        metaHtml += `<span class="prompt-timestamp">📅 ${timestamp}</span>`;
                    }
                    if (p.workflow) {
                        metaHtml += `<span class="prompt-workflow-badge">🔄 ${escapeHtml(p.workflow)}</span>`;
                    }
                    metaHtml += '</div>';

                    return `
                    <div class="prompt-item" draggable="true" 
                         ondragstart="handleDragStart(event, ${realIndex})" 
                         ondragover="handleDragOver(event)" 
                         ondrop="handleDrop(event, ${realIndex})"
                         data-index="${realIndex}">
                        <div class="prompt-item-header">
                            <span class="prompt-drag-handle">≡</span>
                            ${p.category ? `<span class="prompt-item-category">${p.category}</span>` : ''}
                        </div>
                        ${metaHtml}
                        <div class="prompt-item-content">${contentHtml}</div>
                        ${tagsHtml ? `<div class="prompt-item-tags">${tagsHtml}</div>` : ''}
                        ${noteHtml}
                        <div class="prompt-item-actions">
                            <button class="prompt-action-btn copy" onclick="copyPrompt(${realIndex})">📋 Copy</button>
                            <button class="prompt-action-btn" onclick="editPrompt(${realIndex})">✏️ Sửa</button>
                            <button class="prompt-action-btn delete" onclick="deletePrompt(${realIndex})">🗑️ Xóa</button>
                        </div>
                    </div>
                `;
                }).join('');

                // Setup drag event listeners
                setupDragListeners();
            }

            // Format timestamp helper
            function formatTimestamp(isoString) {
                try {
                    const date = new Date(isoString);
                    return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    return '';
                }
            }

            // Update workflow dropdown for filter
            function updateWorkflowDropdown() {
                const dropdown = document.getElementById('promptWorkflowFilter');
                const currentValue = dropdown.value;
                const workflows = [...new Set(prompts.filter(p => p.workflow).map(p => p.workflow))].sort();

                dropdown.innerHTML = '<option value="">🔄 Tất cả Workflow</option>' +
                    workflows.map(w => `<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('');

                dropdown.value = currentValue;
            }

            // Update workflow dropdown for form (adding prompts)
            function updateWorkflowFormDropdown() {
                const dropdown = document.getElementById('promptWorkflow');
                const currentValue = dropdown.value;
                const workflows = [...new Set(prompts.filter(p => p.workflow).map(p => p.workflow))].sort();

                dropdown.innerHTML = '<option value="">-- Không thuộc Workflow --</option>' +
                    workflows.map(w => `<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('') +
                    '<option value="__new__">➕ Tạo Workflow mới...</option>';

                dropdown.value = currentValue;
            }

            // Handle workflow dropdown change
            function onWorkflowSelectChange() {
                const select = document.getElementById('promptWorkflow');
                const newInput = document.getElementById('promptWorkflowNew');
                if (select.value === '__new__') {
                    newInput.style.display = 'block';
                    newInput.focus();
                } else {
                    newInput.style.display = 'none';
                }
            }

            // Copy all prompts in workflow (in position order)
            function copyWorkflowSteps() {
                const workflowFilter = document.getElementById('promptWorkflowFilter')?.value;
                if (!workflowFilter) return;

                // Get prompts in their current position order (not by step number)
                const workflowPrompts = prompts.filter(p => p.workflow === workflowFilter);

                if (workflowPrompts.length === 0) {
                    toast('❌ Không tìm thấy prompt nào trong workflow này');
                    return;
                }

                const allContent = workflowPrompts.map((p, i) => {
                    return `[${i + 1}] ${p.name}\n${p.content}`;
                }).join('\n\n---\n\n');

                navigator.clipboard.writeText(allContent).then(() => {
                    toast(`📋 Đã copy ${workflowPrompts.length} prompts trong workflow "${workflowFilter}"`);
                });
            }

            function addPrompt() {
                const contentInput = document.getElementById('promptContent');
                const categoryInput = document.getElementById('promptCategory');
                const tagsInput = document.getElementById('promptTags');
                const noteInput = document.getElementById('promptNote');
                const workflowSelect = document.getElementById('promptWorkflow');
                const workflowNewInput = document.getElementById('promptWorkflowNew');

                const content = contentInput.value.trim();
                const category = categoryInput.value;
                const tags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
                const note = noteInput.value.trim();

                // Handle workflow selection
                let workflow = null;
                if (workflowSelect.value === '__new__') {
                    workflow = workflowNewInput.value.trim() || null;
                } else if (workflowSelect.value) {
                    workflow = workflowSelect.value;
                }

                if (!content) {
                    toast('⚠️ Nhập nội dung prompt');
                    return;
                }

                // Auto-generate name from first 50 chars
                const autoName = content.substring(0, 50).replace(/\n/g, ' ') + (content.length > 50 ? '...' : '');

                const promptData = {
                    id: Date.now().toString(),
                    name: autoName,
                    content,
                    category,
                    tags,
                    note,
                    workflow,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (editingPromptIndex >= 0) {
                    promptData.id = prompts[editingPromptIndex].id;
                    promptData.createdAt = prompts[editingPromptIndex].createdAt;
                    prompts[editingPromptIndex] = promptData;
                    editingPromptIndex = -1;
                    document.getElementById('btnCancelPromptEdit').style.display = 'none';
                    document.querySelector('.btn-add-prompt').textContent = '➕ Lưu Prompt';
                    toast('✅ Đã cập nhật prompt');
                } else {
                    prompts.unshift(promptData);
                    toast('✅ Đã lưu prompt');
                }

                localStorage.setItem('promptLibrary', JSON.stringify(prompts));
                autoSyncToDrive();
                clearPromptForm();
                renderPrompts();
            }

            function clearPromptForm() {
                document.getElementById('promptContent').value = '';
                document.getElementById('promptCategory').value = '';
                document.getElementById('promptTags').value = '';
                document.getElementById('promptNote').value = '';
                document.getElementById('promptWorkflow').value = '';
                document.getElementById('promptWorkflowNew').value = '';
                document.getElementById('promptWorkflowNew').style.display = 'none';
            }

            function editPrompt(index) {
                const p = prompts[index];
                updateWorkflowFormDropdown(); // Populate dropdown first
                document.getElementById('promptContent').value = p.content;
                document.getElementById('promptCategory').value = p.category || '';
                document.getElementById('promptTags').value = p.tags ? p.tags.join(', ') : '';
                document.getElementById('promptNote').value = p.note || '';
                // Set workflow dropdown value
                const workflowSelect = document.getElementById('promptWorkflow');
                if (p.workflow && [...workflowSelect.options].some(o => o.value === p.workflow)) {
                    workflowSelect.value = p.workflow;
                } else {
                    workflowSelect.value = '';
                }
                document.getElementById('promptWorkflowNew').style.display = 'none';
                editingPromptIndex = index;
                document.getElementById('btnCancelPromptEdit').style.display = 'inline-block';
                document.querySelector('.btn-add-prompt').textContent = '💾 Lưu thay đổi';
                document.getElementById('promptContent').focus();
                document.getElementById('promptForm').scrollIntoView({ behavior: 'smooth' });
            }

            function cancelEditPrompt() {
                editingPromptIndex = -1;
                clearPromptForm();
                document.getElementById('btnCancelPromptEdit').style.display = 'none';
                document.querySelector('.btn-add-prompt').textContent = '➕ Lưu Prompt';
            }

            let draggedIndex = null;

            function handleDragStart(event, index) {
                draggedIndex = index;
                event.target.classList.add('dragging');
                event.dataTransfer.effectAllowed = 'move';
            }

            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
            }

            function handleDrop(event, dropIndex) {
                event.preventDefault();
                if (draggedIndex === null || draggedIndex === dropIndex) return;

                // Reorder prompts
                const [draggedItem] = prompts.splice(draggedIndex, 1);
                prompts.splice(dropIndex, 0, draggedItem);

                draggedIndex = null;
                localStorage.setItem('promptLibrary', JSON.stringify(prompts));
                renderPrompts();
                autoSyncToDrive();
            }

            function setupDragListeners() {
                document.querySelectorAll('.prompt-item').forEach(item => {
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        draggedIndex = null;
                    });
                });
            }

            function deletePrompt(index) {
                if (confirm('Xóa prompt "' + prompts[index].name + '"?')) {
                    prompts.splice(index, 1);
                    localStorage.setItem('promptLibrary', JSON.stringify(prompts));
                    renderPrompts();
                    toast('🗑️ Đã xóa prompt');
                    autoSyncToDrive();
                }
            }

            function copyPrompt(index) {
                const p = prompts[index];
                navigator.clipboard.writeText(p.content).then(() => {
                    toast('📋 Đã copy prompt!');
                });
            }

            function filterPrompts() {
                renderPrompts();
            }

            // ========== KNOWLEDGE BASE FUNCTIONS ==========
            let knowledgeBase = JSON.parse(localStorage.getItem('knowledgeBase') || '[]');
            let editingKnowledgeId = null;

            // File Upload Handler
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    readFileContent(file);
                }
            }

            function readFileContent(file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;

                    // Extract title from filename (remove extension)
                    let title = file.name.replace(/\.(md|txt|markdown)$/i, '');

                    // Or extract from first heading if exists
                    const headingMatch = content.match(/^#\s+(.+)$/m);
                    if (headingMatch) {
                        title = headingMatch[1].replace(/[🎯📝🎬🤖📢🔍📋📁]/g, '').trim();
                    }

                    // Auto-detect category from content
                    let category = '';
                    const contentLower = content.toLowerCase();
                    if (contentLower.includes('script') || contentLower.includes('kịch bản') || contentLower.includes('hook')) {
                        category = 'Scriptwriting';
                    } else if (contentLower.includes('video') || contentLower.includes('edit')) {
                        category = 'Video Editing';
                    } else if (contentLower.includes('prompt') || contentLower.includes('ai')) {
                        category = 'AI Prompts';
                    }

                    // Fill form
                    document.getElementById('knowledgeName').value = title;
                    document.getElementById('knowledgeCategory').value = category;
                    document.getElementById('knowledgeContent').value = content;

                    toast('✅ Đã tải file: ' + file.name);
                };
                reader.onerror = function () {
                    toast('❌ Không thể đọc file!');
                };
                reader.readAsText(file);
            }

            // Drag and Drop handlers
            document.addEventListener('DOMContentLoaded', function () {
                const uploadArea = document.getElementById('knowledgeUploadArea');
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });

                    uploadArea.addEventListener('dragleave', function (e) {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                    });

                    uploadArea.addEventListener('drop', function (e) {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');

                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const file = files[0];
                            if (file.name.match(/\.(md|txt|markdown)$/i)) {
                                readFileContent(file);
                            } else {
                                toast('⚠️ Chỉ hỗ trợ file .md, .txt');
                            }
                        }
                    });
                }

                renderKnowledge();
            });

            function renderKnowledge() {
                const list = document.getElementById('knowledgeList');
                const search = document.getElementById('knowledgeSearch').value.toLowerCase();
                const category = document.getElementById('knowledgeCategoryFilter').value;

                const filtered = knowledgeBase.filter(item => {
                    const matchSearch = item.title.toLowerCase().includes(search) ||
                        item.content.toLowerCase().includes(search) ||
                        (item.tags && item.tags.some(t => t.toLowerCase().includes(search)));
                    const matchCategory = !category || item.category === category;
                    return matchSearch && matchCategory;
                });

                document.getElementById('knowledgeCount').textContent = `${filtered.length} tài liệu`;

                if (filtered.length === 0) {
                    list.innerHTML = '<div class="knowledge-empty">Không tìm thấy tài liệu nào. Thêm mới ở trên! 👆</div>';
                    return;
                }

                list.innerHTML = filtered.map((item, idx) => {
                    const tagsHtml = item.tags && item.tags.length > 0
                        ? item.tags.map(t => `<span class="knowledge-item-tag">${t}</span>`).join('')
                        : '';
                    const previewContent = item.content.substring(0, 150) + (item.content.length > 150 ? '...' : '');

                    return `
                    <div class="knowledge-item" data-id="${item.id}">
                        <div class="knowledge-item-header" onclick="toggleKnowledgeItem('${item.id}')">
                            <div class="knowledge-item-expand">▶</div>
                            <div class="knowledge-item-info">
                                <div class="knowledge-item-title">${escapeHtml(item.title)}</div>
                                <div class="knowledge-item-meta">
                                    ${item.category ? `<span class="knowledge-item-category">${item.category}</span>` : ''}
                                    ${tagsHtml}
                                </div>
                            </div>
                            <div class="knowledge-item-actions" onclick="event.stopPropagation()">
                                <button class="knowledge-action-btn copy" onclick="copyKnowledge('${item.id}')" title="Copy">📋</button>
                                <button class="knowledge-action-btn edit" onclick="editKnowledge('${item.id}')" title="Sửa">✏️</button>
                                <button class="knowledge-action-btn delete" onclick="deleteKnowledge('${item.id}')" title="Xóa">🗑️</button>
                            </div>
                        </div>
                        <div class="knowledge-item-body">
                            <div class="knowledge-item-content markdown-body">${renderMarkdown(item.content)}</div>
                            <button class="knowledge-item-copy-full" onclick="copyKnowledge('${item.id}')">📋 Copy toàn bộ nội dung</button>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function renderMarkdown(text) {
                // Use marked.js if available, otherwise fallback to basic formatting
                if (typeof marked !== 'undefined') {
                    return marked.parse(text);
                }
                // Fallback: basic formatting
                return text
                    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                    .replace(/^\- (.+)$/gm, '<li>$1</li>')
                    .replace(/^\* (.+)$/gm, '<li>$1</li>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
            }

            function toggleKnowledgeItem(id) {
                const item = document.querySelector(`.knowledge-item[data-id="${id}"]`);
                if (item) {
                    item.classList.toggle('expanded');
                }
            }

            function addKnowledge() {
                const title = document.getElementById('knowledgeName').value.trim();
                const category = document.getElementById('knowledgeCategory').value;
                const content = document.getElementById('knowledgeContent').value.trim();
                const tagsInput = document.getElementById('knowledgeTags').value.trim();

                if (!title || !content) {
                    toast('⚠️ Vui lòng nhập tiêu đề và nội dung!');
                    return;
                }

                const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

                if (editingKnowledgeId) {
                    // Update existing
                    const idx = knowledgeBase.findIndex(k => k.id === editingKnowledgeId);
                    if (idx !== -1) {
                        knowledgeBase[idx] = {
                            ...knowledgeBase[idx],
                            title,
                            category,
                            content,
                            tags,
                            updatedAt: new Date().toISOString()
                        };
                    }
                    editingKnowledgeId = null;
                    document.getElementById('btnCancelKnowledge').style.display = 'none';
                    document.querySelector('.btn-add-knowledge').textContent = '➕ Thêm tài liệu';
                    toast('✅ Đã cập nhật tài liệu!');
                } else {
                    // Add new
                    const newItem = {
                        id: Date.now().toString(),
                        title,
                        category,
                        content,
                        tags,
                        createdAt: new Date().toISOString()
                    };
                    knowledgeBase.unshift(newItem);
                    toast('✅ Đã thêm tài liệu!');
                }

                // Save and render
                localStorage.setItem('knowledgeBase', JSON.stringify(knowledgeBase));
                autoSyncToDrive();
                clearKnowledgeForm();
                renderKnowledge();
            }

            function editKnowledge(id) {
                const item = knowledgeBase.find(k => k.id === id);
                if (!item) return;

                editingKnowledgeId = id;
                document.getElementById('knowledgeName').value = item.title;
                document.getElementById('knowledgeCategory').value = item.category || '';
                document.getElementById('knowledgeContent').value = item.content;
                document.getElementById('knowledgeTags').value = item.tags ? item.tags.join(', ') : '';

                document.getElementById('btnCancelKnowledge').style.display = 'inline-block';
                document.querySelector('.btn-add-knowledge').textContent = '💾 Cập nhật';

                // Scroll to form
                document.getElementById('knowledgeForm').scrollIntoView({ behavior: 'smooth' });
            }

            function cancelEditKnowledge() {
                editingKnowledgeId = null;
                clearKnowledgeForm();
                document.getElementById('btnCancelKnowledge').style.display = 'none';
                document.querySelector('.btn-add-knowledge').textContent = '➕ Thêm tài liệu';
            }

            function clearKnowledgeForm() {
                document.getElementById('knowledgeName').value = '';
                document.getElementById('knowledgeCategory').value = '';
                document.getElementById('knowledgeContent').value = '';
                document.getElementById('knowledgeTags').value = '';
            }

            function deleteKnowledge(id) {
                if (!confirm('Bạn có chắc muốn xóa tài liệu này?')) return;

                knowledgeBase = knowledgeBase.filter(k => k.id !== id);
                localStorage.setItem('knowledgeBase', JSON.stringify(knowledgeBase));
                autoSyncToDrive();
                renderKnowledge();
                toast('🗑️ Đã xóa tài liệu!');
            }

            function copyKnowledge(id) {
                const item = knowledgeBase.find(k => k.id === id);
                if (!item) return;

                navigator.clipboard.writeText(item.content).then(() => {
                    toast('📋 Đã copy nội dung!');
                });
            }

            function filterKnowledge() {
                renderKnowledge();
            }

            // ========== NEW KNOWLEDGE BASE GUIDES ==========
            let currentGuideId = null;

            // Guide URLs - cached content will be fetched from GitHub raw files or embedded
            const guideUrls = {
                shorts: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/AI_YouTube_Shorts_Scriptwriting_Guide.md',
                longform: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/AI_YouTube_LongForm_Scriptwriting_Guide.md',
                workflow: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/AI_Scriptwriting_Workflow.md',
                evaluator: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/AI_Script_Evaluator_System.md',
                douyin: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/Douyin_to_YouTube_Shorts_Guide.md',
                claude: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/Claude_Natural_Writing_Techniques.md',
                assistant: 'https://raw.githubusercontent.com/hituongvypham-hue/Tim-tat-ca/main/guides/How_To_Create_AI_Script_Assistant.md'
            };

            const guideTitles = {
                shorts: '🎬 YouTube Shorts Scriptwriting Guide',
                longform: '📺 YouTube Long-form Scriptwriting Guide',
                workflow: '🔄 AI Scriptwriting Workflow',
                evaluator: '🤖 AI Script Evaluator System',
                douyin: '🇨🇳 Douyin → YouTube Shorts Guide',
                claude: '🎭 Claude Natural Writing Techniques',
                assistant: '🛠️ Hướng dẫn Tạo AI Script Assistant'
            };

            // Cache for guide content
            const guideCache = {};

            function filterGuides(category) {
                // Update active button
                document.querySelectorAll('.kb-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase().includes(category) ||
                        (category === 'all' && btn.textContent.includes('Tất cả'))) {
                        btn.classList.add('active');
                    }
                });

                // Filter cards
                document.querySelectorAll('.kb-card').forEach(card => {
                    const cardCategory = card.dataset.category;
                    if (category === 'all' || cardCategory === category) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            }

            async function openGuideModal(guideId) {
                currentGuideId = guideId;
                const modal = document.getElementById('guideModal');
                const titleEl = document.getElementById('guideModalTitle');
                const contentEl = document.getElementById('guideModalContent');

                titleEl.textContent = guideTitles[guideId] || 'Guide';
                contentEl.innerHTML = '<div style="text-align:center;padding:3rem;"><div style="font-size:2rem;">⏳</div><p>Đang tải nội dung...</p></div>';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';

                try {
                    let content = '';
                    if (guideCache[guideId]) {
                        content = guideCache[guideId];
                    } else {
                        const res = await fetch(guideUrls[guideId]);
                        if (res.ok) {
                            content = await res.text();
                            guideCache[guideId] = content;
                        } else {
                            throw new Error('Failed to fetch');
                        }
                    }

                    // Render markdown
                    if (typeof marked !== 'undefined') {
                        contentEl.innerHTML = marked.parse(content);
                    } else {
                        contentEl.innerHTML = '<pre style="white-space:pre-wrap;">' + content + '</pre>';
                    }
                } catch (e) {
                    contentEl.innerHTML = '<div style="text-align:center;padding:3rem;color:#ef4444;"><div style="font-size:2rem;">❌</div><p>Không thể tải nội dung. Vui lòng kiểm tra kết nối mạng.</p><p style="font-size:0.8rem;color:#666;">Nội dung sẽ được tải từ GitHub repository.</p></div>';
                    console.error('Error loading guide:', e);
                }
            }

            function closeGuideModal() {
                document.getElementById('guideModal').classList.remove('show');
                document.body.style.overflow = '';
                currentGuideId = null;
            }

            async function copyGuide(guideId) {
                try {
                    let content = '';
                    if (guideCache[guideId]) {
                        content = guideCache[guideId];
                    } else {
                        const res = await fetch(guideUrls[guideId]);
                        if (res.ok) {
                            content = await res.text();
                            guideCache[guideId] = content;
                        }
                    }
                    await navigator.clipboard.writeText(content);
                    toast('📋 Đã copy toàn bộ guide!');
                } catch (e) {
                    toast('❌ Không thể copy. Vui lòng thử lại.');
                }
            }

            // Tab Filtering Logic
            function filterTabs(category) {
                // Update filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const btnCat = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                    if (btnCat === category) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // Show/Hide tabs
                const tabs = document.querySelectorAll('.tab');
                let firstVisibleTab = null;
                let activeTabVisible = false;

                tabs.forEach(tab => {
                    const tabCategory = tab.getAttribute('data-category');
                    const shouldShow = category === 'all' || tabCategory === category;

                    if (shouldShow) {
                        tab.style.display = 'flex';
                        if (!firstVisibleTab) firstVisibleTab = tab;
                        if (tab.classList.contains('active')) activeTabVisible = true;
                    } else {
                        tab.style.display = 'none';
                    }
                });

                // If active tab is hidden, switch to first visible
                if (!activeTabVisible && firstVisibleTab) {
                    // Ensure we don't trigger if it's just 'all' view and everything is visible
                    // But here we want to ensure user sees a valid tab for the new category
                    firstVisibleTab.click();
                }
            }

            function copyCurrentGuide() {
                if (currentGuideId) {
                    copyGuide(currentGuideId);
                }
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && document.getElementById('guideModal').classList.contains('show')) {
                    closeGuideModal();
                }
            });
        </script>


        <!-- API Key Modal -->
        <div id="apiKeyModal" class="api-modal-overlay" onclick="if(event.target===this)hideApiKeyModal()">
            <div class="api-modal">
                <div class="api-modal-header">
                    <h3>🔑 Cài đặt Gemini API Key</h3>
                    <button class="modal-close-btn" onclick="hideApiKeyModal()">✕</button>
                </div>
                <div class="api-modal-body">
                    <p>Để sử dụng tính năng <strong>🤖 AI thông minh</strong>, bạn cần API key miễn phí từ
                        Google.</p>
                    <ol>
                        <li>Truy cập <a href="https://aistudio.google.com/app/apikey"
                                target="_blank">aistudio.google.com/app/apikey</a></li>
                        <li>Đăng nhập và tạo API key</li>
                        <li>Dán key vào ô bên dưới</li>
                    </ol>
                    <div class="api-modal-input-group">
                        <input type="password" id="modalApiKeyInput" class="api-modal-input"
                            placeholder="Dán API key tại đây...">
                        <button type="button" class="toggle-key-btn" onclick="toggleModalKeyVisibility()">👁️</button>
                    </div>
                </div>
                <div class="api-modal-footer">
                    <button class="modal-btn cancel" onclick="hideApiKeyModal()">Bỏ qua</button>
                    <button class="modal-btn danger" onclick="removeApiKey()">🗑️ Xóa key</button>
                    <button class="modal-btn primary" onclick="saveApiKeyFromModal()">💾 Lưu</button>
                </div>
            </div>
        </div>
        <!-- Copy Style Modal -->
        <div id="copyStyleModal" class="style-modal" style="display: none;"
            onclick="if(event.target===this){this.style.display='none';}">
            <div class="style-modal-content" style="position: relative;">
                <!-- Loading Overlay (hidden by default) -->
                <div id="styleProcessingOverlay" class="processing-overlay" style="display: none;">
                    <div class="processing-spinner"></div>
                    <div class="processing-text" id="styleProcessingText">Đang xử lý...</div>
                </div>
                <!-- Close Button - using button element with inline JS -->
                <button type="button" onclick="document.getElementById('copyStyleModal').style.display='none';"
                    style="position:absolute; right:15px; top:15px; font-size:20px; cursor:pointer; z-index: 100002; background:rgba(0,0,0,0.1); border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">&times;</button>
                <h3 style="margin-top:0">🎨 Copy Style & Reverse Prompt</h3>
                <p style="color:#5f6368; font-size:13px; margin-bottom:20px;">AI sẽ phân tích ảnh hoặc prompt
                    mẫu để tự
                    động
                    điền các thông số style cho bạn.</p>

                <div class="style-tabs">
                    <button class="style-tab-btn active" onclick="switchStyleTab('image')">🖼️ Từ Ảnh
                        (Vision)</button>
                    <button class="style-tab-btn" onclick="switchStyleTab('text')">📝 Từ Prompt (Text)</button>
                </div>

                <div id="styleInputImage" class="style-input-section">
                    <div class="upload-area" id="styleUploadArea"
                        onclick="document.getElementById('styleImageInput').click()">
                        <input type="file" id="styleImageInput" accept="image/*" style="display:none"
                            onchange="previewStyleImage(this)">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <div style="font-size:32px; margin-bottom:10px;">📤</div>
                            <span>Click để tải ảnh lên<br><small style="color:#9aa0a6">(JPG, PNG,
                                    WebP)</small></span>
                        </div>
                        <img id="styleImagePreview"
                            style="display:none; max-height: 200px; margin:0 auto; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    </div>
                </div>

                <div id="styleInputText" class="style-input-section" style="display:none;">
                    <textarea id="stylePromptInput" class="pb-textarea" rows="5"
                        placeholder="Paste prompt mẫu (English/Vietnamese) vào đây để AI phân tích style..."
                        style="width:100%; resize:vertical; background:#f8f9fa;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="analyze-btn" id="analyzeBtn" onclick="analyzeAndApplyStyle()" style="flex:1;">
                        <span>✨ Phân tích & Áp dụng Style</span>
                    </button>
                    <button type="button" onclick="document.getElementById('copyStyleModal').style.display='none';"
                        style="padding: 12px 20px; background: #e0e0e0; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    </div> <!-- End .container -->
    </main> <!-- End .mac-content -->
    </div> <!-- End .mac-layout -->
    </div> <!-- End .mac-window -->

    <script>
        // macOS Sidebar Tab Switching
        function switchMacTab(tabName) {
            // Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            if (event && event.target) {
                const clickedItem = event.target.closest('.sidebar-item');
                if (clickedItem) clickedItem.classList.add('active');
            }

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // Show the selected tab content
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
            }

            // Also update the hidden tab buttons for consistency
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tabBtn) {
                tabBtn.classList.add('active');
            }

            // Fix: Update global currentTab variable so search logic works
            currentTab = tabName;
        }

        // Initialize: show video tab by default
        document.addEventListener('DOMContentLoaded', function () {
            const videoTab = document.getElementById('video-tab');
            if (videoTab) {
                videoTab.style.display = 'block';
                videoTab.classList.add('active');
            }
        });

        // Close Copy Style Modal
        function closeCopyStyleModal() {
            const modal = document.getElementById('copyStyleModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Also add click handler to close modal when clicking backdrop
        document.addEventListener('click', function (e) {
            if (e.target.id === 'copyStyleModal') {
                closeCopyStyleModal();
            }
        });

        // FORCE HIDE MODAL ON LOAD (Temporary fix as requested)
        window.addEventListener('load', function () {
            const modal = document.getElementById('copyStyleModal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    </script>

</body>

</html>